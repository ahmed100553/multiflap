%% Generated by Sphinx.
\def\sphinxdocclass{report}
\documentclass[letterpaper,10pt,english,openany,oneside]{sphinxmanual}
\ifdefined\pdfpxdimen
   \let\sphinxpxdimen\pdfpxdimen\else\newdimen\sphinxpxdimen
\fi \sphinxpxdimen=.75bp\relax

\PassOptionsToPackage{warn}{textcomp}
\usepackage[utf8]{inputenc}
\ifdefined\DeclareUnicodeCharacter
% support both utf8 and utf8x syntaxes
  \ifdefined\DeclareUnicodeCharacterAsOptional
    \def\sphinxDUC#1{\DeclareUnicodeCharacter{"#1}}
  \else
    \let\sphinxDUC\DeclareUnicodeCharacter
  \fi
  \sphinxDUC{00A0}{\nobreakspace}
  \sphinxDUC{2500}{\sphinxunichar{2500}}
  \sphinxDUC{2502}{\sphinxunichar{2502}}
  \sphinxDUC{2514}{\sphinxunichar{2514}}
  \sphinxDUC{251C}{\sphinxunichar{251C}}
  \sphinxDUC{2572}{\textbackslash}
\fi
\usepackage{cmap}
\usepackage[T1]{fontenc}
\usepackage{amsmath,amssymb,amstext}
\usepackage{babel}



\usepackage{times}
\expandafter\ifx\csname T@LGR\endcsname\relax
\else
% LGR was declared as font encoding
  \substitutefont{LGR}{\rmdefault}{cmr}
  \substitutefont{LGR}{\sfdefault}{cmss}
  \substitutefont{LGR}{\ttdefault}{cmtt}
\fi
\expandafter\ifx\csname T@X2\endcsname\relax
  \expandafter\ifx\csname T@T2A\endcsname\relax
  \else
  % T2A was declared as font encoding
    \substitutefont{T2A}{\rmdefault}{cmr}
    \substitutefont{T2A}{\sfdefault}{cmss}
    \substitutefont{T2A}{\ttdefault}{cmtt}
  \fi
\else
% X2 was declared as font encoding
  \substitutefont{X2}{\rmdefault}{cmr}
  \substitutefont{X2}{\sfdefault}{cmss}
  \substitutefont{X2}{\ttdefault}{cmtt}
\fi


\usepackage[Bjarne]{fncychap}
\usepackage{sphinx}

\fvset{fontsize=\small}
\usepackage{geometry}


% Include hyperref last.
\usepackage{hyperref}
% Fix anchor placement for figures with captions.
\usepackage{hypcap}% it must be loaded after hyperref.
% Set up styles of URL: it should be placed after hyperref.
\urlstyle{same}

\usepackage{sphinxmessages}
\setcounter{tocdepth}{1}



\title{Read the Docs Template Documentation}
\date{Dec 07, 2021}
\release{1.1}
\author{Read the Docs}
\newcommand{\sphinxlogo}{\vbox{}}
\renewcommand{\releasename}{Release}
\makeindex
\begin{document}

\pagestyle{empty}
\sphinxmaketitle
\pagestyle{plain}
\sphinxtableofcontents
\pagestyle{normal}
\phantomsection\label{\detokenize{index::doc}}


Multiflap is a \sphinxcode{\sphinxupquote{python}} toolbox optimised to assess the cycle stability of flapping fliers. The kernel of this framework relies on the \sphinxstylestrong{multiple\sphinxhyphen{}shooting} algorithm, which is a numerical method to detect iteratively limit cycles, and assess their stability via the Floquet multipliers.

The object\sphinxhyphen{}oriented structure of this code allows the user to couple the multiple\sphinxhyphen{}shooting scheme with any system of ordinary differential equations.

The documentation is organized as follows:


\chapter{User guide}
\label{\detokenize{getting_started/index:user-guide}}\label{\detokenize{getting_started/index::doc}}

\section{Introduction}
\label{\detokenize{getting_started/multiflap_guide:introduction}}\label{\detokenize{getting_started/multiflap_guide::doc}}
\sphinxtitleref{multiflap} is a Python toolbox for finding periodic orbit of nonlinear systems of ODEs. The code relies on the multiple\sphinxhyphen{}shooting algorithm, and simultaneously allows to study the stability of the system via the Floquet multipliers.

This toolbox is optimised to study the limit cycle of flapping wings dynamics, but the modular architecture allows the user to use the kernel with any set of ODEs.

In order to run the code for a particular dynamical system, two files have to be created:
\begin{itemize}
\item {} 
\sphinxstylestrong{Input file}: The input file contains the system of differential equations, and the related staility matrix.

\item {} 
\sphinxstylestrong{Main file}: The main file is the python module that will e executed. More detailes on the format of the main file will be provided later. \sphinxstylestrong{NOTE} despite of example cases, the main file has to be inside \sphinxtitleref{multiflap} directory.

\end{itemize}


\section{Installation and getting started}
\label{\detokenize{getting_started/multiflap_guide:installation-and-getting-started}}
\sphinxtitleref{multiflap} runs on Python 3 and Python 2.
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
Get a local copy of \sphinxtitleref{multiflap}:

\end{enumerate}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} git clone https://github.com/vortexlab\PYGZhy{}uclouvain/multiflap.git \PYG{o}{\PYGZam{}\PYGZam{}} \PYG{n+nb}{cd} multiflap
\end{sphinxVerbatim}
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\setcounter{enumi}{1}
\item {} 
Install the packages:

\end{enumerate}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} python setup.py install
\end{sphinxVerbatim}
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\setcounter{enumi}{2}
\item {} 
To run one of the examples, from the multiflap root directory:

\end{enumerate}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} python3 examples/rossler\PYGZus{}system.py
\end{sphinxVerbatim}


\chapter{Limit cycle stability}
\label{\detokenize{limit_cycle_stability/index:limit-cycle-stability}}\label{\detokenize{limit_cycle_stability/index::doc}}
This section briefly aims to recall the basic theory about cycle stability, providing the user the mathematical notations on which the code builds upon.
Such notation is strongly inspired by ChaosBook {[}cite here{]}.


\section{Stability of cycles}
\label{\detokenize{limit_cycle_stability/limit_cycle_stability:stability-of-cycles}}\label{\detokenize{limit_cycle_stability/limit_cycle_stability::doc}}
Given the generic system of ordinary differential equations of the form:
\begin{equation}\label{equation:limit_cycle_stability/limit_cycle_stability:odes}
\begin{split}\dot{\mathbf{x}} = \mathbf{v}(\mathbf{x}, t)\end{split}
\end{equation}
we want to find a particular solution such that:
\begin{equation}
\mathbf{x}^{*}(t) = \mathbf{x}^{*}(t + T)
\end{equation}
where \(T > 0\) is the period of the cycle.

\begin{figure}[htbp]
\centering

\noindent\sphinxincludegraphics[width=0.650\linewidth]{{limit_cycle_stability}.png}
\end{figure}

Depending on their asymptotic behavior limit cycles can be either \sphinxstylestrong{stable} or \sphinxstylestrong{unstable}. In the first scenario they behave as attractors, while in the second one they behave as repellers.

Let  \(\textbf{x}^*(t) + \delta\textbf{x}(t)\) be the neighbor of a limit cycle state at time \(t\), where \(\delta\textbf{x}(t)\) thus captures the initial perturbation with respect to the limit cycle. After a time equal to the period \(T\), this point of the state space is transported by the flow as following:
\begin{equation}\label{equation:limit_cycle_stability/limit_cycle_stability:flow_map}
\begin{split}x_{i}^{*}(t) + \delta{x}_{i}(t+T) = f_{i}\big(\textbf{x}^*(t) + \delta\textbf{x}(t)\big) \Big \rvert_{t}^{t+T}\end{split}
\end{equation}
By expanding the right hand side of Equation \eqref{equation:limit_cycle_stability/limit_cycle_stability:flow_map} to the first order, and considering that \(x_{i}^{*}(t) = f_{i}\big(\textbf{x}^*(t)\big) \big \rvert_{t}^{t+T}\) (limit cycle condition), we obtain:
\begin{equation}\label{equation:limit_cycle_stability/limit_cycle_stability:flow_map_2}
\begin{split}\delta{x}_{i}(t+T) = \sum_{j = 1}^{N} \frac{\partial f_{i}\big(\textbf{x}^*(t)\big) \big \rvert_{t}^{t+T}}{\partial x_{j}}\cdot \delta x_j(t)\end{split}
\end{equation}
Equation \eqref{equation:limit_cycle_stability/limit_cycle_stability:flow_map_2} describes the dynamic of the perturbed neighboring state.

\begin{sphinxadmonition}{note}{Note:}
The quantity
\begin{equation*}
\begin{split}\mathbb{J}(\mathbf{x}^*)\big \rvert_{t}^{t+T}= \sum_{j = 1}^{N} \frac{\partial f_{i}\big(\textbf{x}^*(t)\big) \big \rvert_{t}^{t+T}}{\partial x_{j}}\end{split}
\end{equation*}
is called the Jacobian Matrix or Floquet Matrix, and describes how the neighbor is deformed by the flow, after a period \(T\).
\end{sphinxadmonition}

The stability of a periodic orbit is governed by the eigenvalues of the Jacobian matrix (Floquet multipliers). For an orbit to be stable, all the eigenvalues (except the trivial one) must be less the one in absolute value.

The Jacobian (or Monodromy) matrix, is the solution of the differential equation:
\begin{equation}\label{equation:limit_cycle_stability/limit_cycle_stability:jacode}
\begin{split}\frac{d\mathbb{J}}{dt}(\mathbf{x}_0) \Big \rvert_{t_0}^{t}&= \mathbb{A}(\mathbf{x}, t) \mathbb{J}(\mathbf{x}_0) \Big \rvert_{t_0}^{t}\\
\mathbb{J} (\mathbf{x}_0)\Big \rvert_{t_0}^{t_0} &= \mathbb{I}\end{split}
\end{equation}
\begin{sphinxadmonition}{note}{Note:}
We define \sphinxstylestrong{stability matrix} the quantity
\begin{equation*}
\begin{split}\mathbb{A}(\mathbf{x}, t) = \frac{\partial}{\partial x_j}v_{i(\mathbf{x}, t)}\end{split}
\end{equation*}
where \(v\) is the right\sphinxhyphen{}hand\sphinxhyphen{}side of Equation \eqref{equation:limit_cycle_stability/limit_cycle_stability:odes}
\end{sphinxadmonition}

Two methods have been implemented in the code to calculate the Jacobian matrix:
\begin{itemize}
\item {} 
Analytical, solving Equation \eqref{equation:limit_cycle_stability/limit_cycle_stability:jacode};

\item {} 
Numerical, by finite differentiation.

\end{itemize}

A \sphinxstylestrong{multiple\sphinxhyphen{}shooting} algorithm has been implemented in order to detect limit cycles and assess their stability.


\chapter{Multiple\sphinxhyphen{}shooting algorithm}
\label{\detokenize{multiple_shooting/index:multiple-shooting-algorithm}}\label{\detokenize{multiple_shooting/index::doc}}
What follows is the description of the \sphinxstylestrong{multiple\sphinxhyphen{}shooting} algorithm. Two functions are implemented, depending whther the orbit period is known a priori (i.e. for non\sphinxhyphen{}autonomous systems) or not (i.e. most of the autonomous systems).

Both methods are adaptations of the algorithms described by Lust {[}cite here{]}.

Two methods to compute the Jacobian (or Monodromy matrix) are also described.


\section{Numerical scheme}
\label{\detokenize{multiple_shooting/numerical_scheme:numerical-scheme}}\label{\detokenize{multiple_shooting/numerical_scheme::doc}}
A multiple shooting algorithm is employed in order to identify the periodic orbits corresponding to trimmed flight, and to simultaneously compute their stability through their Floquet multipliers.

We use a multiple\sphinxhyphen{}shooting scheme first proposed by\textasciitilde{}cite\{lust2001\}, which was a modification of\textasciitilde{}cite\{keller1968\}. This algorithm is adapted to our case with the advantage that the limit cycle period is known, since it must be equal to the flapping one.

\begin{figure}[htbp]
\centering

\noindent\sphinxincludegraphics[width=0.650\linewidth]{{ms_scheme}.png}
\end{figure}

The multiple\sphinxhyphen{}shooting method splits the limit cycle into several points computing relatives sub\sphinxhyphen{}trajectories.\textbackslash{}
Integrating the ODEs system, the point \(\mathbf{x}^*_{i+1}\) is mapped to the point  \(\mathbf{x}^*_{i}\) by
\begin{equation}\label{equation:multiple_shooting/numerical_scheme:multishooting2}
\begin{split}\mathbf{x}^*_{i+1} = f(\mathbf{x}^*_i)  \big \rvert_{t_{i}}^{t_{i}+\tau} = f(\mathbf{x}_i + \Delta\mathbf{x}_i) \big \rvert_{t_{i}}^{t_{i}+\tau}\end{split}
\end{equation}
By expanding at the first order the right\sphinxhyphen{}hand\sphinxhyphen{}side of Equation \eqref{equation:multiple_shooting/numerical_scheme:multishooting2}, the point \(\mathbf{x}^*_{i+1}\) can be expressed as function of the guessed points only
\begin{equation}\label{equation:multiple_shooting/numerical_scheme:multishooting3}
\begin{split}\mathbf{x}_{i+1} + \Delta\mathbf{x}_{i+1}  =f(\mathbf{x}_i) \big \rvert_{t_{i}}^{t_{i}+\tau} + \mathbb{J} (\mathbf{x}_i) \Big \rvert_{t_{i}}^{t_{i}+\tau}\cdot\Delta\mathbf{x}_i\end{split}
\end{equation}
where \(\mathbb{J} \big \rvert_{t_{i}}^{t_{i}+\tau}(\mathbf{x}_i)\) is the Jacobian matrix previously defined.

Re\sphinxhyphen{}arranging Equation \eqref{equation:multiple_shooting/numerical_scheme:multishooting3} we get
\begin{equation}\label{equation:multiple_shooting/numerical_scheme:multishooting4}
\begin{split}      \mathbb{J}(\mathbf{x}_i) \Big \rvert_{t_{i}}^{t_{i}+\tau}\cdot\Delta\mathbf{x}_i -\Delta\mathbf{x}_{i+1} = \underbrace{-\big(f(\mathbf{x}_i)\big \rvert_{t_{i}}^{t_{i}+\tau} - \mathbf{x}_{i+1}\big)}_{Error}\end{split}
\end{equation}
and thus the \sphinxstylestrong{multiple\sphinxhyphen{}shooting} scheme becomes:
\begin{equation}\label{equation:multiple_shooting/numerical_scheme:shootingscheme}
\begin{split}\underbrace{
\begin{pmatrix}
\mathbb{J} (\mathbf{x}_0) \Big \rvert_{0}^{\tau}  & - \mathbb{I}& 0& \dots& 0 \\
\\
0 & \mathbb{J} (\mathbf{x}_1)\Big \rvert_{t_{1}}^{t_{1}+\tau}& - \mathbb{I}  & \dots & 0\\
\vdots & \vdots & \ddots & \ddots & \vdots \\
0 & 0 &\dots & \mathbb{J}(\mathbf{x}_{m-1})\Big \rvert_{t_{m-1}}^{T}  & - \mathbb{I}\\
- \mathbb{I} & 0 &\dots & 0 &  \mathbb{I}\\
\end{pmatrix}}_{\mathbf{M}\ [n \times M, n \times M]}
\underbrace{
\begin{pmatrix}
\Delta \mathbf{x}_{0}\\
\Delta \mathbf{x}_{1}\\
\vdots\\
\vdots\\
\vdots\\
\Delta \mathbf{x}_{m-1}\\
\Delta \mathbf{x}_{m}
\end{pmatrix}}_{\Delta\mathbf{x}\ [n \times M]}=
\underbrace{-\begin{pmatrix}
f(\mathbf{x}_0) \big \rvert_{0}^{\tau}- \mathbf{x}_1 \\
f(\mathbf{x}_1) \big \rvert_{t_{1}}^{t_{1}+\tau}- \mathbf{x}_2 \\
\vdots\\
(\mathbf{x}_{m-1}) \big \rvert_{t_{m-1}}^{T} - \mathbf{x}_m\\
\mathbf{x}_{m}- \mathbf{x}_0\\
\end{pmatrix}}_{\mathbf{E}\ [n \times M]}\end{split}
\end{equation}\begin{equation}\label{equation:multiple_shooting/numerical_scheme:multishootingcompact}
\begin{split}\mathbf{M}(\mathbf{x}_i) \mathbf{\Delta \mathbf{x}} = \mathbf{E}(\mathbf{x}_i)\end{split}
\end{equation}

\section{Numerical scheme (unknown period)}
\label{\detokenize{multiple_shooting/numerical_scheme_period:numerical-scheme-unknown-period}}\label{\detokenize{multiple_shooting/numerical_scheme_period::doc}}
What followis is a generalization of the previous scheme, suitable in all the situations where also the period of the periodic orbit is unknown.

\begin{figure}[htbp]
\centering

\noindent\sphinxincludegraphics[width=0.650\linewidth]{{ms_scheme_period}.png}
\end{figure}

Following the same appriach as before, we split the limit cycle into several points computing relatives sub\sphinxhyphen{}trajectories.
The relative time integration between two points, now has to be guessed as well. Mantaining the same notation, we call \(\tau^{*}\) the exact (unknown) subperiod of the periodic orbit, and \(\overline{\tau}\) the guessed subperiod of the periodic orbit.
Integrating the ODEs system, the point \(\mathbf{x}^*_{i+1}\) is mapped to the point  \(\mathbf{x}^*_{i}\) by
\begin{equation}\label{equation:multiple_shooting/numerical_scheme_period:multishooting2_period}
\begin{split}\mathbf{x}^*_{i+1} = f(\mathbf{x}^*_i)  \big \rvert_{t_{i}}^{t_{i}+\tau^{*}} = f(\mathbf{x}_i + \Delta\mathbf{x}_i) \big \rvert_{t_{i}}^{t_{i}+\tau^{*}}\end{split}
\end{equation}
By expanding at the first order the right\sphinxhyphen{}hand\sphinxhyphen{}side of Equation \eqref{equation:multiple_shooting/numerical_scheme_period:multishooting2_period}, the point \(\mathbf{x}^*_{i+1}\) can be expressed as function of the guessed points only
\begin{equation}\label{equation:multiple_shooting/numerical_scheme_period:multishooting3_period}
\begin{split}\mathbf{x}_{i+1} + \Delta\mathbf{x}_{i+1}  =f(\mathbf{x}_i) \big \rvert_{t_{i}}^{t_{i}+\tau^{*}} + \mathbb{J} (\mathbf{x}_i) \Big \rvert_{t_{i}}^{t_{i}+\tau^{*}}\cdot\Delta\mathbf{x}_i\end{split}
\end{equation}
Considering that
\begin{equation}\label{equation:multiple_shooting/numerical_scheme_period:period_iteration}
\begin{split}f(\mathbf{x}_i)  \big \rvert_{t_{i}}^{t_{i}+\tau^{*}} = f(\mathbf{x}_i)  \big \rvert_{t_{i}}^{t_{i}+\overline{\tau}} + \mathbf{v} \big ( f(\mathbf{x}_i)  \big \rvert_{t_{i}}^{t_{i}+\overline{\tau}}\big ) \Delta \tau\end{split}
\end{equation}
\begin{sphinxadmonition}{note}{Note:}
We approximate the Jacobian matrix as
\begin{equation*}
\begin{split}\mathbb{J} \big \rvert_{t_{i}}^{t_{i}+\tau^{*}}(\mathbf{x}_i) \approx  \mathbb{J} \big \rvert_{t_{i}}^{t_{i}+\overline{\tau}}(\mathbf{x}_i)\end{split}
\end{equation*}\end{sphinxadmonition}

The function the returns the mapped point \(f(\mathbf{x}_i)  \big \rvert_{t_{i}}^{t_{i}+\overline{\tau}}\) is the \sphinxcode{\sphinxupquote{get\_mappedpoint}} method of \sphinxcode{\sphinxupquote{multiple\_shooting\_period.py}} module.

\sphinxcode{\sphinxupquote{get\_mappedpoint()}} \sphinxstylestrong{Show code}
\begin{quote}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}mappedpoint}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,}\PYG{n}{x0}\PYG{p}{,} \PYG{n}{t0}\PYG{p}{,} \PYG{n}{deltat}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Returns the last element of the time integration. It outputs where a}
\PYG{l+s+sd}{    point x0(t) is mapped after a time deltat.}

\PYG{l+s+sd}{    Inputs:}
\PYG{l+s+sd}{        x0: initial value}
\PYG{l+s+sd}{        t0: initial time (required as the system is non\PYGZhy{}autonomous)}
\PYG{l+s+sd}{        deltat: integration\PYGZus{}time}

\PYG{l+s+sd}{    Outputs:}
\PYG{l+s+sd}{        mapped\PYGZus{}point: last element of the time integration}
\PYG{l+s+sd}{        solution: complete trajectory traced out from x0(t0) for t = deltat}


\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{t\PYGZus{}final} \PYG{o}{=} \PYG{n}{t0} \PYG{o}{+} \PYG{n}{deltat}     \PYG{c+c1}{\PYGZsh{} Final time}

    \PYG{n}{time\PYGZus{}array} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{n}{t0}\PYG{p}{,} \PYG{n}{t\PYGZus{}final}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{t\PYGZus{}steps}\PYG{p}{)}
    \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{integrator}\PYG{o}{==}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{rk}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{n}{tuple\PYGZus{}solution} \PYG{o}{=} \PYG{n}{rk4}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model}\PYG{o}{.}\PYG{n}{dynamics}\PYG{p}{,} \PYG{n}{x0}\PYG{p}{,} \PYG{n}{time\PYGZus{}array}\PYG{p}{)}
    \PYG{c+c1}{\PYGZsh{}    sspSolution = ode.solve\PYGZus{}ivp(birdEqn\PYGZus{}py,}
                        \PYG{c+c1}{\PYGZsh{}[tInitial, tFinal], ssp0,\PYGZsq{}LSODA\PYGZsq{}, max\PYGZus{}step = deltat/Nt)}
    \PYG{c+c1}{\PYGZsh{}    sspSolution = (sspSolution.y).T}
        \PYG{n}{solution} \PYG{o}{=} \PYG{n}{tuple\PYGZus{}solution}\PYG{o}{.}\PYG{n}{x}
        \PYG{n}{mapped\PYGZus{}point} \PYG{o}{=} \PYG{n}{solution}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} Read the final point to sspdeltat}
    \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{integrator}\PYG{o}{==}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{odeint}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{n}{solution} \PYG{o}{=} \PYG{n}{odeint}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model}\PYG{o}{.}\PYG{n}{dynamics}\PYG{p}{,} \PYG{n}{x0}\PYG{p}{,} \PYG{n}{time\PYGZus{}array}\PYG{p}{)}
        \PYG{n}{mapped\PYGZus{}point} \PYG{o}{=} \PYG{n}{solution}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}
        \PYG{n}{odesol} \PYG{o}{=} \PYG{n}{collections}\PYG{o}{.}\PYG{n}{namedtuple}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{odesol}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{t}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{tuple\PYGZus{}solution} \PYG{o}{=} \PYG{n}{odesol}\PYG{p}{(}\PYG{n}{solution}\PYG{p}{,} \PYG{n}{time\PYGZus{}array}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{mapped\PYGZus{}point}\PYG{p}{,} \PYG{n}{tuple\PYGZus{}solution}
\end{sphinxVerbatim}
\end{quote}

Plugging Equation \eqref{equation:multiple_shooting/numerical_scheme_period:period_iteration} in Equation \eqref{equation:multiple_shooting/numerical_scheme_period:multishooting2_period}, and re\sphinxhyphen{}arranging Equation \eqref{equation:multiple_shooting/numerical_scheme_period:multishooting2_period}, we get:
\begin{equation}\label{equation:multiple_shooting/numerical_scheme_period:multishooting4_period}
\begin{split}      \mathbb{J}(\mathbf{x}_i) \Big \rvert_{t_{i}}^{t_{i}+\overline{\tau}} \Delta\mathbf{x}_i -\Delta\mathbf{x}_{i+1} + \mathbf{v} \big ( f(\mathbf{x}_i)  \big \rvert_{t_{i}}^{t_{i}+\overline{\tau}}\big ) \Delta \tau = \underbrace{-\big(f(\mathbf{x}_i)\big \rvert_{t_{i}}^{t_{i}+\overline{\tau}} - \mathbf{x}_{i+1}\big)}_{Error}\end{split}
\end{equation}
and thus the \sphinxstylestrong{multiple\sphinxhyphen{}shooting} scheme becomes:
\begin{equation}\label{equation:multiple_shooting/numerical_scheme_period:shootingscheme_period}
\begin{split}\underbrace{
\begin{pmatrix}
\mathbb{J} (\mathbf{x}_0) \Big \rvert_{0}^{\overline{\tau}}  & - \mathbb{I}& 0& \dots& 0 & \mathbf{v} \big ( f(\mathbf{x}_{0})  \big \rvert_{0}^{\overline{\tau}}\big ) \\
\\
0 & \mathbb{J} (\mathbf{x}_1)\Big \rvert_{t_{1}}^{t_{1}+\overline{\tau}}& - \mathbb{I}  & \dots & 0 & \mathbf{v} \big ( f(\mathbf{x}_{1})  \big \rvert_{t_{1}}^{ t_{1}+\overline{\tau}}\big )\\
\vdots & \vdots & \ddots & \ddots & \vdots & \vdots\\
0 & 0 &\dots & \mathbb{J}(\mathbf{x}_{m-1})\Big \rvert_{t_{m-1}}^{\overline{T}}  & - \mathbb{I} & \mathbf{v} \big ( f(\mathbf{x}_{m-1})  \big \rvert_{t_{m-1}}^{\overline{T}}\big )\\
- \mathbb{I} & 0 &\dots & 0 &  \mathbb{I} & 0\\
\end{pmatrix}}_{\mathbf{M}\ [n \times M, n \times M + 1]}
\underbrace{
\begin{pmatrix}
\Delta \mathbf{x}_{0}\\
\Delta \mathbf{x}_{1}\\
\vdots\\
\vdots\\
\vdots\\
\Delta \mathbf{x}_{m-1}\\
\Delta \mathbf{x}_{m}\\
\Delta \tau
\end{pmatrix}}_{\Delta\mathbf{x}\ [n \times M +1]}=
\underbrace{-\begin{pmatrix}
f(\mathbf{x}_0) \big \rvert_{0}^{\overline{\tau}}- \mathbf{x}_1 \\
f(\mathbf{x}_1) \big \rvert_{t_{1}}^{t_{1}+\overline{\tau}}- \mathbf{x}_2 \\
\vdots\\
(\mathbf{x}_{m-1}) \big \rvert_{t_{m-1}}^{\overline{T}} - \mathbf{x}_m\\
\mathbf{x}_{m}- \mathbf{x}_0\\
-\overline{T}\\
\end{pmatrix}}_{\mathbf{E}\ [n \times M + 1]}\end{split}
\end{equation}
The system \eqref{equation:multiple_shooting/numerical_scheme_period:shootingscheme_period} is set up calling the method \sphinxcode{\sphinxupquote{get\_ms\_scheme}} of \sphinxcode{\sphinxupquote{multiple\_shooting\_period.py}} module.

\sphinxcode{\sphinxupquote{get\_ms\_scheme()}} \sphinxstylestrong{Show code}
\begin{quote}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}ms\PYGZus{}scheme}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x0}\PYG{p}{,} \PYG{n}{tau}\PYG{p}{)}\PYG{p}{:}


    \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Returns the multiple\PYGZhy{}shooting scheme to set up the equation:}
\PYG{l+s+sd}{    MS * DX = E}

\PYG{l+s+sd}{    Inputs:}
\PYG{l+s+sd}{        x0: array of m\PYGZhy{}points of the multiple\PYGZhy{}shooting scheme}

\PYG{l+s+sd}{    Outputs (M = points number, N = dimension):}
\PYG{l+s+sd}{        MS = Multiple\PYGZhy{}Shooting matrix dim(NxM, NxM)}
\PYG{l+s+sd}{        error = error vector dim(NxM),}
\PYG{l+s+sd}{        trajectory\PYGZus{}tuple = trajectory related to the initial value and time}
\PYG{l+s+sd}{    \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}

\PYG{l+s+sd}{    Multiple\PYGZhy{}Shooting Matrix (MS):}

\PYG{l+s+sd}{        dim(MS) = ((NxM) x (NxM))}

\PYG{l+s+sd}{                 [  J(x\PYGZus{}0, tau)  \PYGZhy{}I                                  ]}
\PYG{l+s+sd}{                 [              J(x\PYGZus{}1, tau)   \PYGZhy{}I                     ]}
\PYG{l+s+sd}{        MS   =   [                .                                  ]}
\PYG{l+s+sd}{                 [                 .                                 ]}
\PYG{l+s+sd}{                 [                  .                                ]}
\PYG{l+s+sd}{                 [                        J(x\PYGZus{}\PYGZob{}M\PYGZhy{}1\PYGZcb{}, tau)       I    ]}
\PYG{l+s+sd}{                 [ \PYGZhy{}I ........................................  I    ]}


\PYG{l+s+sd}{    Unknown Vector:                 Error vector:}

\PYG{l+s+sd}{    dim(DX) = (NxM)                 dim(E) = (NxM)}

\PYG{l+s+sd}{            [DX\PYGZus{}0]                          [ f(x\PYGZus{}0, tau) \PYGZhy{} x\PYGZus{}1 ]}
\PYG{l+s+sd}{    DX   =  [DX\PYGZus{}1]                  E  =  \PYGZhy{} [ f(x\PYGZus{}1, tau) \PYGZhy{} x\PYGZus{}2 ]}
\PYG{l+s+sd}{            [... ]                          [       ...         ]}
\PYG{l+s+sd}{            [DX\PYGZus{}M]                          [       x\PYGZus{}M \PYGZhy{} x\PYGZus{}0   ]}

\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{c+c1}{\PYGZsh{} The dimension of the MultiShooting matrix is (NxM,NxM)}
    \PYG{c+c1}{\PYGZsh{} The dimension of the MultiShooting matrix is (NxM,NxM)}
    \PYG{n}{MS} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{[}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{o}{*}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{point\PYGZus{}number}\PYG{p}{,}
                   \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{o}{*}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{point\PYGZus{}number}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{} Routine to fill the rest of the scheme}
    \PYG{c+c1}{\PYGZsh{}complete\PYGZus{}solution = []}
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{point\PYGZus{}number} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{x\PYGZus{}start} \PYG{o}{=} \PYG{n}{x0}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,}\PYG{p}{:}\PYG{p}{]}
        \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{option\PYGZus{}jacobian} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{analytical}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
            \PYG{n}{jacobian} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{get\PYGZus{}jacobian\PYGZus{}analytical}\PYG{p}{(}\PYG{n}{x\PYGZus{}start}\PYG{p}{,} \PYG{n}{i}\PYG{o}{*}\PYG{n}{tau}\PYG{p}{,}
                                                    \PYG{n}{tau}\PYG{p}{)}
        \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{option\PYGZus{}jacobian} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{numerical}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
            \PYG{n}{jacobian} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{get\PYGZus{}jacobian\PYGZus{}numerical}\PYG{p}{(}\PYG{n}{x\PYGZus{}start}\PYG{p}{,} \PYG{n}{i}\PYG{o}{*}\PYG{n}{tau}\PYG{p}{,}
                                                    \PYG{n}{tau}\PYG{p}{)}

        \PYG{n}{MS}\PYG{p}{[}\PYG{p}{(}\PYG{n}{i}\PYG{o}{*}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{)}\PYG{p}{:}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{o}{+}\PYG{p}{(}\PYG{n}{i}\PYG{o}{*}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{)}\PYG{p}{,}
           \PYG{p}{(}\PYG{n}{i}\PYG{o}{*}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{)}\PYG{o}{+}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{:}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{o}{+}\PYG{p}{(}\PYG{n}{i}\PYG{o}{*}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{)}\PYG{p}{]}\PYG{o}{=}\PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{eye}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{)}


        \PYG{n}{MS}\PYG{p}{[}\PYG{p}{(}\PYG{n}{i}\PYG{o}{*}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{)}\PYG{p}{:}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{o}{+}\PYG{p}{(}\PYG{n}{i}\PYG{o}{*}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{)}\PYG{p}{,}
           \PYG{p}{(}\PYG{n}{i}\PYG{o}{*}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{)}\PYG{p}{:}\PYG{p}{(}\PYG{n}{i}\PYG{o}{*}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{)}\PYG{o}{+}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{]} \PYG{o}{=} \PYG{n}{jacobian}


        \PYG{p}{[}\PYG{n}{mapped\PYGZus{}point}\PYG{p}{,} \PYG{n}{complete\PYGZus{}solution}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{get\PYGZus{}mappedpoint}\PYG{p}{(}\PYG{n}{x\PYGZus{}start}\PYG{p}{,} \PYG{n}{i}\PYG{o}{*}\PYG{n}{tau}\PYG{p}{,} \PYG{n}{tau}\PYG{p}{)}
        \PYG{n}{last\PYGZus{}time} \PYG{o}{=} \PYG{n}{complete\PYGZus{}solution}\PYG{o}{.}\PYG{n}{t}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}
        \PYG{n}{velocity} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model}\PYG{o}{.}\PYG{n}{dynamics}\PYG{p}{(}\PYG{n}{mapped\PYGZus{}point}\PYG{p}{,}\PYG{n}{last\PYGZus{}time}\PYG{p}{)}
        \PYG{n}{MS}\PYG{p}{[}\PYG{p}{(}\PYG{n}{i}\PYG{o}{*}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{)}\PYG{p}{:}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{o}{+}\PYG{p}{(}\PYG{n}{i}\PYG{o}{*}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{)}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{=} \PYG{n}{velocity}
    \PYG{c+c1}{\PYGZsh{}trajectory = np.asanyarray(complete\PYGZus{}solution)}
    \PYG{c+c1}{\PYGZsh{} Last block of the scheme}
    \PYG{n}{MS}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{:}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{]} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{eye}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{)}
    \PYG{n}{MS}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{:}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{eye}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{)}
    \PYG{p}{[}\PYG{n}{error}\PYG{p}{,} \PYG{n}{trajectory\PYGZus{}tuple}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{get\PYGZus{}error\PYGZus{}vector}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{,} \PYG{n}{tau}\PYG{p}{)}
    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Error vector is}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{error}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{MS}\PYG{p}{,} \PYG{n}{error}\PYG{p}{,} \PYG{n}{trajectory\PYGZus{}tuple}
\end{sphinxVerbatim}
\end{quote}
\begin{equation}\label{equation:multiple_shooting/numerical_scheme_period:multishootingcompact_period}
\begin{split}\mathbf{M}(\mathbf{x}_i) \mathbf{\Delta \mathbf{x}} = \mathbf{E}(\mathbf{x}_i)\end{split}
\end{equation}

\section{Jacobian computation}
\label{\detokenize{multiple_shooting/jacobian_computation:jacobian-computation}}\label{\detokenize{multiple_shooting/jacobian_computation::doc}}
Two methods are implemented to calculate the Jacobian matrix and build the diagonal blocks of the multiple\sphinxhyphen{}shooting matrix \(\textbf{M}\).


\subsection{Analytical computation}
\label{\detokenize{multiple_shooting/jacobian_computation:analytical-computation}}
The analytical computation solves the Equation:
\begin{equation}\label{equation:multiple_shooting/jacobian_computation:jac_an}
\begin{split}\begin{pmatrix} \dot{\mathbf{x}}\\ \dot{\mathbb{J}} \end{pmatrix} = \begin{pmatrix} \mathbf{v}(\mathbf{x}, t)\\ \mathbb{A}(\mathbf{x}, t) \ \mathbb{J} \end{pmatrix}\end{split}
\end{equation}
with the initial conditions:
\begin{equation}\label{equation:multiple_shooting/jacobian_computation:jac_an_initial_conditions}
\begin{split}\begin{pmatrix} {\mathbf{x}(t_0)}\\ {\mathbb{J}^{0}} \end{pmatrix} = \begin{pmatrix} \mathbf{x}_0 \\ \mathbb{I} \end{pmatrix}\end{split}
\end{equation}
This means solving a \((n+n^{2})\) system of differential equations.

First of all the ODE system \eqref{equation:multiple_shooting/jacobian_computation:jac_an} is reshaped in a \((n+n^{2})\) equations. This is done by the method \sphinxcode{\sphinxupquote{jacobian\_ode}}.

\sphinxcode{\sphinxupquote{jacobian\_ode}} \sphinxstylestrong{Show code}
\begin{quote}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{jacobian\PYGZus{}ode}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x0\PYGZus{}jacobian}\PYG{p}{,} \PYG{n}{t}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Set up the additional ODE system (d + d\PYGZca{}2) to evaluate analytically the}
\PYG{l+s+sd}{    Jacobian matrix.}
\PYG{l+s+sd}{    This function is used to unpack the Jacobian elements to solve}

\PYG{l+s+sd}{    \PYGZbs{}dot\PYGZob{}J\PYGZcb{} = AJ}

\PYG{l+s+sd}{    It reshapes Equation (7.18) of Seydel\PYGZsq{}s book \PYGZdq{}Practical Bifurcation and}
\PYG{l+s+sd}{    Stability Analysis\PYGZdq{}}
\PYG{l+s+sd}{    in order get the components of the Jacobian via numerical integration}
\PYG{l+s+sd}{    Inputs:}
\PYG{l+s+sd}{        x0\PYGZus{}jacobian: (d+d\PYGZca{}2) initial values}
\PYG{l+s+sd}{                     state space itself and the tangent space}
\PYG{l+s+sd}{        t: time.}

\PYG{l+s+sd}{    Outputs:}
\PYG{l+s+sd}{        jac\PYGZus{}elements\PYGZus{}ODE = (d+d\PYGZca{}2) dimensional velocity vector}

\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}



    \PYG{n}{x0} \PYG{o}{=} \PYG{n}{x0\PYGZus{}jacobian}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{:}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{]}
    \PYG{n}{J} \PYG{o}{=} \PYG{n}{x0\PYGZus{}jacobian}\PYG{p}{[}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{:}\PYG{p}{]}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{)}\PYG{p}{)}

    \PYG{n}{jac\PYGZus{}elements\PYGZus{}ODE} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{n}{x0\PYGZus{}jacobian}\PYG{p}{)}\PYG{p}{)}

    \PYG{n}{jac\PYGZus{}elements\PYGZus{}ODE}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{:}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model}\PYG{o}{.}\PYG{n}{dynamics}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{,} \PYG{n}{t}\PYG{p}{)}


    \PYG{c+c1}{\PYGZsh{}Last dxd elements of the velJ are determined by the action of}
    \PYG{c+c1}{\PYGZsh{}stability matrix on the current value of the Jacobian:}

    \PYG{n}{velocity\PYGZus{}vector} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{model}\PYG{o}{.}\PYG{n}{get\PYGZus{}stability\PYGZus{}matrix}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{,} \PYG{n}{t}\PYG{p}{)}\PYG{p}{,} \PYG{n}{J}\PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{} shape a back a (dxd) array in a d\PYGZca{}2 matrix}

    \PYG{n}{jac\PYGZus{}elements\PYGZus{}ODE}\PYG{p}{[}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{velocity\PYGZus{}vector}\PYG{p}{,}
                                                   \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}

    \PYG{k}{return} \PYG{n}{jac\PYGZus{}elements\PYGZus{}ODE}
\end{sphinxVerbatim}
\end{quote}

The function \sphinxcode{\sphinxupquote{get\_jacobian\_analytical}} is then implemented in order to solve the reshaped ODE system \eqref{equation:multiple_shooting/jacobian_computation:jac_an}

\sphinxcode{\sphinxupquote{get\_jacobian\_analytical()}} \sphinxstylestrong{Show code}
\begin{quote}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}jacobian\PYGZus{}analytical}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x0}\PYG{p}{,} \PYG{n}{initial\PYGZus{}time}\PYG{p}{,} \PYG{n}{integration\PYGZus{}time}\PYG{p}{)}\PYG{p}{:}

    \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Return the Jacobian (or Monodromy Matrix) of the flow, starting from x0}
\PYG{l+s+sd}{    and integrated for a time \PYGZdq{}integration\PYGZus{}time\PYGZdq{}.}

\PYG{l+s+sd}{    It solves numerically the (d + d\PYGZca{}2) ODE system.}

\PYG{l+s+sd}{    Reference: Equation (7.18) Seydel\PYGZsq{}s book \PYGZdq{}Practical Bifurcation and}
\PYG{l+s+sd}{    Stability Analysis\PYGZdq{}.}

\PYG{l+s+sd}{    Inputs:}
\PYG{l+s+sd}{        x0 : Initial point of the phase space. len(x0) = dimension}
\PYG{l+s+sd}{        initial\PYGZus{}time: initial time needed as the system is non\PYGZhy{}autonomous}
\PYG{l+s+sd}{        integration\PYGZus{}time: integration time}
\PYG{l+s+sd}{    Outputs:}
\PYG{l+s+sd}{        J: Jacobian (Monodromy Matrix) of flow from t \PYGZhy{}\PYGZgt{} t+integration\PYGZus{}time}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}

    \PYG{c+c1}{\PYGZsh{} Initial conditions (ic) for Jacobian matrix (see 7.18 Seydel)}

    \PYG{n}{jac\PYGZus{}ic} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{identity}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{)}

    \PYG{n}{jacODE\PYGZus{}ic} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim} \PYG{o}{*}\PYG{o}{*} \PYG{l+m+mi}{2}\PYG{p}{)}

    \PYG{n}{jacODE\PYGZus{}ic}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{:}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{]} \PYG{o}{=} \PYG{n}{x0}

    \PYG{n}{jacODE\PYGZus{}ic}\PYG{p}{[}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{jac\PYGZus{}ic}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}


    \PYG{n}{t\PYGZus{}Final} \PYG{o}{=} \PYG{n}{initial\PYGZus{}time} \PYG{o}{+} \PYG{n}{integration\PYGZus{}time}
    \PYG{n}{Nt} \PYG{o}{=} \PYG{l+m+mi}{50000} \PYG{c+c1}{\PYGZsh{}50000  \PYGZsh{} interval discretization for computing the integration}

    \PYG{n}{tArray} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{n}{initial\PYGZus{}time}\PYG{p}{,} \PYG{n}{t\PYGZus{}Final}\PYG{p}{,} \PYG{n}{Nt}\PYG{p}{)}

    \PYG{n}{start\PYGZus{}jac} \PYG{o}{=} \PYG{n}{time}\PYG{o}{.}\PYG{n}{time}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}   jac\PYGZus{}elements\PYGZus{}solution = ode.solve\PYGZus{}ivp(jacobian\PYGZus{}ode,[t\PYGZus{}initial, t\PYGZus{}Final],}
                            \PYG{c+c1}{\PYGZsh{}jacODE\PYGZus{}ic, \PYGZsq{}RK45\PYGZsq{})}
    \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{integrator}\PYG{o}{==}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{rk}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{n}{rk\PYGZus{}jac\PYGZus{}elements\PYGZus{}solution} \PYG{o}{=} \PYG{n}{rk2}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{jacobian\PYGZus{}ode}\PYG{p}{,} \PYG{n}{jacODE\PYGZus{}ic}\PYG{p}{,} \PYG{n}{tArray}\PYG{p}{)}

        \PYG{n}{end\PYGZus{}jac} \PYG{o}{=} \PYG{n}{time}\PYG{o}{.}\PYG{n}{time}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Jacobian time }\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{(}\PYG{n}{end\PYGZus{}jac}\PYG{o}{\PYGZhy{}}\PYG{n}{start\PYGZus{}jac}\PYG{p}{)}\PYG{p}{)}

        \PYG{n}{jac\PYGZus{}elements\PYGZus{}solution} \PYG{o}{=} \PYG{n}{rk\PYGZus{}jac\PYGZus{}elements\PYGZus{}solution}\PYG{o}{.}\PYG{n}{x}
    \PYG{c+c1}{\PYGZsh{}    jac\PYGZus{}elements\PYGZus{}solution = jac\PYGZus{}elements\PYGZus{}solution.y.T}
        \PYG{c+c1}{\PYGZsh{} Pack back the jacobian in matrix:}
        \PYG{n}{J} \PYG{o}{=} \PYG{n}{jac\PYGZus{}elements\PYGZus{}solution}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{:}\PYG{p}{]}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{,}
                                                            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{integrator}\PYG{o}{==}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{odeint}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{n}{jac\PYGZus{}elements\PYGZus{}solution} \PYG{o}{=} \PYG{n}{odeint}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{jacobian\PYGZus{}ode}\PYG{p}{,} \PYG{n}{jacODE\PYGZus{}ic}\PYG{p}{,} \PYG{n}{tArray}\PYG{p}{)}
        \PYG{n}{J} \PYG{o}{=} \PYG{n}{jac\PYGZus{}elements\PYGZus{}solution}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{:}\PYG{p}{]}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{,}
                                                          \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{J}
\end{sphinxVerbatim}
\end{quote}


\subsection{Numerical computation}
\label{\detokenize{multiple_shooting/jacobian_computation:numerical-computation}}
Alternatively, Jacobian matrix can be computed via numerical differentiation of the perturbed
trajectory along each state variable, i.e.:
\begin{equation}\label{equation:multiple_shooting/jacobian_computation:jac_numerical}
\begin{split}\mathbb{J}_{i,j} (\mathbf{x}_0) \Big \rvert_{t}^{t+T} = \frac{f_{i}(\mathbf{x_0} + \varepsilon\mathbf{\hat{e}}_{j}) \Big \rvert_{t}^{t+T} -f_{i}(\mathbf{x_0}) \Big \rvert_{t}^{t+T} }{\varepsilon}\end{split}
\end{equation}
\begin{sphinxadmonition}{tip}{Tip:}
By computing the Jacobian numerically, there is no need to hard code the \sphinxstylestrong{stability matrix}.
This feature is particularly useful anytime that the encoding of the stability matrix is hard to provide.
\end{sphinxadmonition}

The function that returns the numerical Jacobian is \sphinxcode{\sphinxupquote{get\_jacobian\_numerical}}.

\sphinxcode{\sphinxupquote{get\_jacobian\_numerical}} \sphinxstylestrong{Show code}
\begin{quote}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}jacobian\PYGZus{}numerical}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x0}\PYG{p}{,} \PYG{n}{initial\PYGZus{}time}\PYG{p}{,} \PYG{n}{integration\PYGZus{}time}\PYG{p}{)}\PYG{p}{:}

    \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Finite difference evaluation of Jacobian}
\PYG{l+s+sd}{    Flow is perturbed in all directions of the phase space, and the generic}
\PYG{l+s+sd}{    component of the Jacobian is calculated by finite difference as follow:}

\PYG{l+s+sd}{    dF[i]/dx[j] = (F\PYGZca{}t(x\PYGZus{}perturbed)[i] \PYGZhy{} F\PYGZca{}t(x)[i])/perturbation}

\PYG{l+s+sd}{    Jacobian = dF[i]/dx[j] (dim x dim) matrix}

\PYG{l+s+sd}{    epsilon = value of the perturbation}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{time\PYGZus{}steps} \PYG{o}{=} \PYG{l+m+mi}{50000}
    \PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
    \PYG{c+c1}{\PYGZsh{}  Initialization of the Jacobian Matrix}
    \PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}

    \PYG{n}{jacobian} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{,}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{)}\PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
    \PYG{c+c1}{\PYGZsh{} Set the numerical perturbation over the direction of the flow}
    \PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}

    \PYG{n}{epsilon} \PYG{o}{=} \PYG{l+m+mf}{1e\PYGZhy{}3}


    \PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
    \PYG{c+c1}{\PYGZsh{} Finite difference scheme for jacobian evaluation}
    \PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}

    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{... Running jacobian Function}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{perturbation} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{)}

        \PYG{n}{perturbation}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{n}{perturbation}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]} \PYG{o}{+} \PYG{n}{x0}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{o}{*}\PYG{n}{epsilon}

        \PYG{n}{x0\PYGZus{}pert} \PYG{o}{=} \PYG{n}{x0} \PYG{o}{+} \PYG{n}{perturbation}

        \PYG{p}{[}\PYG{n}{vel}\PYG{p}{,} \PYG{n}{\PYGZus{}}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{get\PYGZus{}mappedpoint}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{,}
                                        \PYG{n}{initial\PYGZus{}time}\PYG{p}{,}
                                        \PYG{n}{integration\PYGZus{}time}\PYG{p}{)}

        \PYG{p}{[}\PYG{n}{vel\PYGZus{}pert}\PYG{p}{,} \PYG{n}{\PYGZus{}}\PYG{p}{]} \PYG{o}{=}  \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{get\PYGZus{}mappedpoint}\PYG{p}{(}\PYG{n}{x0\PYGZus{}pert}\PYG{p}{,}
                                              \PYG{n}{initial\PYGZus{}time}\PYG{p}{,}
                                              \PYG{n}{integration\PYGZus{}time}\PYG{p}{)}


        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dim}\PYG{p}{)}\PYG{p}{:}

            \PYG{n}{jacobian}\PYG{p}{[}\PYG{n}{i}\PYG{p}{,}\PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{p}{(}\PYG{n}{vel\PYGZus{}pert}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{vel}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}\PYG{o}{/}\PYG{n}{perturbation}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}


    \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{... jacobian Calculated}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{jacobian}
\end{sphinxVerbatim}
\end{quote}


\section{Multiple\sphinxhyphen{}shooting solver}
\label{\detokenize{multiple_shooting/ms_solver:multiple-shooting-solver}}\label{\detokenize{multiple_shooting/ms_solver::doc}}
The compact form of the multiple\sphinxhyphen{}shooting scheme can be written in the form:
\begin{equation*}
\begin{split}\mathbf{M}(\mathbf{x}_i) \mathbf{\Delta \mathbf{x}} = \mathbf{E}(\mathbf{x}_i)\end{split}
\end{equation*}
Finding the solution of this Equation, means finding the \(\mathbf{x}^{*}_i \in \rm I\!R^{n}\) such that \(\mathbf{E}(\mathbf{x}_i^*) = \mathbf{0}\).

This is solve iteratively using the Levenberg\sphinxhyphen{}Marquardt Algorithm (LMA).

The estimation of the unknown vector \(\delta \mathbf{x}\), used to update the state variables at the generic iteration step \(k\), is computed as follows
\begin{equation}\label{equation:multiple_shooting/ms_solver:LMA}
\begin{split}\left[ \mathbf{M}^{T}\mathbf{M} + \lambda \text{diag}(\mathbf{M}^{T}\mathbf{M}) \right]\mathbf{\delta \mathbf{x}} =  \mathbf{M}^{T} \mathbf{E}\end{split}
\end{equation}
where \(\lambda\) is a non\sphinxhyphen{}negative, adaptive damping parameter.

LMA code \sphinxhyphen{} period
\begin{quote}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class} \PYG{n+nc}{Solver}\PYG{p}{:}


    \PYG{k}{def} \PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{tolerance} \PYG{o}{=} \PYG{l+m+mf}{1e\PYGZhy{}5}\PYG{p}{,} \PYG{n}{max\PYGZus{}iterations} \PYG{o}{=} \PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{ms\PYGZus{}obj} \PYG{o}{=} \PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tolerance} \PYG{o}{=} \PYG{n}{tolerance}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{max\PYGZus{}iterations} \PYG{o}{=} \PYG{n}{max\PYGZus{}iterations}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{ms\PYGZus{}obj} \PYG{o}{=} \PYG{n}{ms\PYGZus{}obj}

    \PYG{k}{def} \PYG{n+nf}{lma}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}

        \PYG{n}{damp} \PYG{o}{=} \PYG{l+m+mf}{1.0}
        \PYG{n}{x0} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{ms\PYGZus{}obj}\PYG{o}{.}\PYG{n}{get\PYGZus{}initial\PYGZus{}guess}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{l+m+mi}{1}\PYG{o}{*}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{)}
        \PYG{n}{ptlist} \PYG{o}{=} \PYG{p}{[}\PYG{n}{x0}\PYG{p}{]}
        \PYG{n}{error} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n}{dim} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{ms\PYGZus{}obj}\PYG{o}{.}\PYG{n}{dim}
        \PYG{c+c1}{\PYGZsh{} Start the iterative scheme}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{max\PYGZus{}iterations}\PYG{p}{)}\PYG{p}{:}

            \PYG{n}{start\PYGZus{}timing} \PYG{o}{=} \PYG{n}{time}\PYG{o}{.}\PYG{n}{time}\PYG{p}{(}\PYG{p}{)}
            \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{... Iteration i = }\PYG{l+s+s2}{\PYGZdq{}} \PYG{o}{+} \PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{i}\PYG{p}{)}\PYG{p}{)}

            \PYG{n}{MS}\PYG{p}{,} \PYG{n}{E}\PYG{p}{,} \PYG{n}{complete\PYGZus{}solution} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{ms\PYGZus{}obj}\PYG{o}{.}\PYG{n}{get\PYGZus{}ms\PYGZus{}scheme}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}

            \PYG{n}{epsilon} \PYG{o}{=} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{E}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{error}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{epsilon}\PYG{p}{)}
            \PYG{n}{end\PYGZus{}timing} \PYG{o}{=} \PYG{n}{time}\PYG{o}{.}\PYG{n}{time}\PYG{p}{(}\PYG{p}{)}
            \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{... Iteration }\PYG{l+s+s2}{\PYGZdq{}} \PYG{o}{+} \PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{i}\PYG{p}{)} \PYG{o}{+} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ time: }\PYG{l+s+s2}{\PYGZdq{}} \PYG{o}{+} \PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{end\PYGZus{}timing} \PYG{o}{\PYGZhy{}} \PYG{n}{start\PYGZus{}timing}\PYG{p}{)}\PYG{p}{)}
            \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{... Iteration number i = }\PYG{l+s+s2}{\PYGZdq{}} \PYG{o}{+} \PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{i}\PYG{p}{)} \PYG{o}{+} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ has error: }\PYG{l+s+s2}{\PYGZdq{}} \PYG{o}{+} \PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{E}\PYG{p}{,} \PYG{n}{inf}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{}        np.save(data\PYGZus{}sim\PYGZus{}history+\PYGZdq{}/Checkpoint\PYGZus{}Iteration\PYGZus{}\PYGZdq{}+str(i), x)}
    \PYG{c+c1}{\PYGZsh{}        np.save(data\PYGZus{}sim\PYGZus{}history+\PYGZdq{}/Error\PYGZus{}History\PYGZdq{}, error)}

            \PYG{k}{if} \PYG{n}{epsilon} \PYG{o}{\PYGZlt{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tolerance}\PYG{p}{:}
                \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Iteration terminates at error : }\PYG{l+s+s2}{\PYGZdq{}} \PYG{o}{+} \PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{E}\PYG{p}{,} \PYG{n}{inf}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
                \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Calculating Floquet Multipliers}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

                \PYG{n}{ptlist}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{*}\PYG{n}{x}\PYG{p}{)}
                \PYG{c+c1}{\PYGZsh{} jac\PYGZus{}sg: jacobian semigroup (from one point to the next one)}
                \PYG{n}{jac\PYGZus{}sg} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{eye}\PYG{p}{(}\PYG{n}{dim}\PYG{p}{)}

                \PYG{c+c1}{\PYGZsh{} Evaluation of Jacobian, using Semigroup (transition) property}
                \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{ms\PYGZus{}obj}\PYG{o}{.}\PYG{n}{point\PYGZus{}number}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
                    \PYG{n}{jac\PYGZus{}sg} \PYG{o}{=} \PYG{p}{(}\PYG{n}{MS}\PYG{p}{[}\PYG{p}{(}\PYG{n}{i}\PYG{o}{*}\PYG{n}{dim}\PYG{p}{)}\PYG{p}{:}\PYG{n}{dim}\PYG{o}{+}\PYG{p}{(}\PYG{n}{i}\PYG{o}{*}\PYG{n}{dim}\PYG{p}{)}\PYG{p}{,}
                                \PYG{p}{(}\PYG{n}{i}\PYG{o}{*}\PYG{n}{dim}\PYG{p}{)}\PYG{p}{:}\PYG{p}{(}\PYG{n}{i}\PYG{o}{*}\PYG{n}{dim}\PYG{p}{)}\PYG{o}{+}\PYG{n}{dim}\PYG{p}{]}\PYG{p}{)}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{jac\PYGZus{}sg}\PYG{p}{)}

                \PYG{k}{break}

            \PYG{k}{else}\PYG{p}{:}

                \PYG{c+c1}{\PYGZsh{} setting up LM equation}
                \PYG{c+c1}{\PYGZsh{} [(MS.T)MS + lambda*diag((MS.T)MS)]*delta\PYGZus{}x = (MS.T)E}
                \PYG{c+c1}{\PYGZsh{} put the Eq. in the form A*delta\PYGZus{}x = B}

                \PYG{n}{A\PYGZus{}0} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{MS}\PYG{o}{.}\PYG{n}{T}\PYG{p}{,}  \PYG{n}{MS}\PYG{p}{)}
                \PYG{n}{A} \PYG{o}{=} \PYG{n}{A\PYGZus{}0} \PYG{o}{+} \PYG{n}{damp}\PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{diag}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{diag}\PYG{p}{(}\PYG{n}{A\PYGZus{}0}\PYG{p}{)}\PYG{p}{)}
                \PYG{n}{B} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{MS}\PYG{o}{.}\PYG{n}{T}\PYG{p}{,} \PYG{n}{E}\PYG{p}{)}
                \PYG{n}{delta\PYGZus{}x} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{solve}\PYG{p}{(}\PYG{n}{A}\PYG{p}{,} \PYG{n}{B}\PYG{p}{)}
                \PYG{c+c1}{\PYGZsh{} Update of the solution}

                \PYG{k}{for} \PYG{n}{k} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{ms\PYGZus{}obj}\PYG{o}{.}\PYG{n}{point\PYGZus{}number}\PYG{p}{)}\PYG{p}{:}
                    \PYG{n}{x}\PYG{p}{[}\PYG{n}{k}\PYG{p}{,}\PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{n}{x}\PYG{p}{[}\PYG{n}{k}\PYG{p}{,}\PYG{p}{:}\PYG{p}{]} \PYG{o}{+} \PYG{n}{delta\PYGZus{}x}\PYG{p}{[}\PYG{n}{k}\PYG{o}{*}\PYG{n}{dim}\PYG{p}{:}\PYG{p}{(}\PYG{n}{k}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{*}\PYG{n}{dim}\PYG{p}{]}
                \PYG{p}{[}\PYG{n}{E\PYGZus{}new}\PYG{p}{,}\PYG{n}{\PYGZus{}}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{ms\PYGZus{}obj}\PYG{o}{.}\PYG{n}{get\PYGZus{}error\PYGZus{}vector}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}

                \PYG{k}{if} \PYG{n}{norm}\PYG{p}{(}\PYG{n}{E\PYGZus{}new}\PYG{p}{,} \PYG{n}{inf}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n}{norm}\PYG{p}{(}\PYG{n}{E}\PYG{p}{,} \PYG{n}{inf}\PYG{p}{)}\PYG{p}{:}
                    \PYG{n}{damp} \PYG{o}{=} \PYG{n}{damp} \PYG{o}{/} \PYG{l+m+mf}{10.0}
                \PYG{k}{else} \PYG{p}{:}
                    \PYG{n}{damp} \PYG{o}{=} \PYG{n}{damp} \PYG{o}{*} \PYG{l+m+mf}{10.0}
                \PYG{n}{ptlist}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{*}\PYG{n}{x}\PYG{p}{)}

        \PYG{k}{return} \PYG{n}{x}\PYG{p}{,} \PYG{n}{ptlist}\PYG{p}{,} \PYG{n}{error}\PYG{p}{,} \PYG{n}{complete\PYGZus{}solution}\PYG{p}{,} \PYG{n}{jac\PYGZus{}sg}
\end{sphinxVerbatim}
\end{quote}

LMA code \sphinxhyphen{} period unknown
\begin{quote}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class} \PYG{n+nc}{SolverPeriod}\PYG{p}{:}


    \PYG{k}{def} \PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{tolerance} \PYG{o}{=} \PYG{l+m+mf}{1e\PYGZhy{}5}\PYG{p}{,} \PYG{n}{max\PYGZus{}iterations} \PYG{o}{=} \PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{ms\PYGZus{}obj} \PYG{o}{=} \PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tolerance} \PYG{o}{=} \PYG{n}{tolerance}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{max\PYGZus{}iterations} \PYG{o}{=} \PYG{n}{max\PYGZus{}iterations}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{ms\PYGZus{}obj} \PYG{o}{=} \PYG{n}{ms\PYGZus{}obj}

    \PYG{k}{def} \PYG{n+nf}{lma}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{tau} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{ms\PYGZus{}obj}\PYG{o}{.}\PYG{n}{period\PYGZus{}guess}\PYG{o}{/}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{ms\PYGZus{}obj}\PYG{o}{.}\PYG{n}{point\PYGZus{}number} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{damp} \PYG{o}{=} \PYG{l+m+mf}{1.0}
        \PYG{n}{x0} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{ms\PYGZus{}obj}\PYG{o}{.}\PYG{n}{get\PYGZus{}initial\PYGZus{}guess}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{x} \PYG{o}{=} \PYG{l+m+mi}{1}\PYG{o}{*}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{)}
        \PYG{n}{ptlist} \PYG{o}{=} \PYG{p}{[}\PYG{n}{x0}\PYG{p}{]}
        \PYG{n}{error} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
        \PYG{n}{dim} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{ms\PYGZus{}obj}\PYG{o}{.}\PYG{n}{dim}
        \PYG{n}{x\PYGZus{}new} \PYG{o}{=} \PYG{n}{x}
        \PYG{c+c1}{\PYGZsh{} Start the iterative scheme}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{max\PYGZus{}iterations}\PYG{p}{)}\PYG{p}{:}

            \PYG{n}{start\PYGZus{}timing} \PYG{o}{=} \PYG{n}{time}\PYG{o}{.}\PYG{n}{time}\PYG{p}{(}\PYG{p}{)}
            \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{... Iteration i = }\PYG{l+s+s2}{\PYGZdq{}} \PYG{o}{+} \PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{i}\PYG{p}{)}\PYG{p}{)}
            \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{tau is:}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{tau}\PYG{p}{)}
            \PYG{n}{MS}\PYG{p}{,} \PYG{n}{E}\PYG{p}{,} \PYG{n}{complete\PYGZus{}solution} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{ms\PYGZus{}obj}\PYG{o}{.}\PYG{n}{get\PYGZus{}ms\PYGZus{}scheme}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{tau}\PYG{p}{)}

            \PYG{n}{epsilon} \PYG{o}{=} \PYG{n+nb}{max}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{E}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{error}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{epsilon}\PYG{p}{)}
            \PYG{n}{end\PYGZus{}timing} \PYG{o}{=} \PYG{n}{time}\PYG{o}{.}\PYG{n}{time}\PYG{p}{(}\PYG{p}{)}
            \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Iteration }\PYG{l+s+s2}{\PYGZdq{}} \PYG{o}{+} \PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{i}\PYG{p}{)} \PYG{o}{+} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ time: }\PYG{l+s+s2}{\PYGZdq{}} \PYG{o}{+} \PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{end\PYGZus{}timing} \PYG{o}{\PYGZhy{}} \PYG{n}{start\PYGZus{}timing}\PYG{p}{)}\PYG{p}{)}
            \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Iteration number i = }\PYG{l+s+s2}{\PYGZdq{}} \PYG{o}{+} \PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{i}\PYG{p}{)} \PYG{o}{+} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ has error: }\PYG{l+s+s2}{\PYGZdq{}} \PYG{o}{+} \PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{E}\PYG{p}{,} \PYG{n}{inf}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{}        np.save(data\PYGZus{}sim\PYGZus{}history+\PYGZdq{}/Checkpoint\PYGZus{}Iteration\PYGZus{}\PYGZdq{}+str(i), x)}
    \PYG{c+c1}{\PYGZsh{}        np.save(data\PYGZus{}sim\PYGZus{}history+\PYGZdq{}/Error\PYGZus{}History\PYGZdq{}, error)}


            \PYG{k}{if} \PYG{n}{epsilon} \PYG{o}{\PYGZlt{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tolerance}\PYG{p}{:}
                \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Iteration terminates at error : }\PYG{l+s+s2}{\PYGZdq{}} \PYG{o}{+} \PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{E}\PYG{p}{,} \PYG{n}{inf}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
                \PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Calculating Floquet Multipliers}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

                \PYG{n}{ptlist}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{*}\PYG{n}{x}\PYG{p}{)}
                \PYG{c+c1}{\PYGZsh{} jac\PYGZus{}sg: jacobian semigroup (from one point to the next one)}
                \PYG{n}{jac\PYGZus{}sg} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{eye}\PYG{p}{(}\PYG{n}{dim}\PYG{p}{)}

                \PYG{c+c1}{\PYGZsh{} Evaluation of Jacobian, using Semigroup (transition) property}
                \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{ms\PYGZus{}obj}\PYG{o}{.}\PYG{n}{point\PYGZus{}number}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
                    \PYG{n}{jac\PYGZus{}sg} \PYG{o}{=} \PYG{p}{(}\PYG{n}{MS}\PYG{p}{[}\PYG{p}{(}\PYG{n}{i}\PYG{o}{*}\PYG{n}{dim}\PYG{p}{)}\PYG{p}{:}\PYG{n}{dim}\PYG{o}{+}\PYG{p}{(}\PYG{n}{i}\PYG{o}{*}\PYG{n}{dim}\PYG{p}{)}\PYG{p}{,}
                                \PYG{p}{(}\PYG{n}{i}\PYG{o}{*}\PYG{n}{dim}\PYG{p}{)}\PYG{p}{:}\PYG{p}{(}\PYG{n}{i}\PYG{o}{*}\PYG{n}{dim}\PYG{p}{)}\PYG{o}{+}\PYG{n}{dim}\PYG{p}{]}\PYG{p}{)}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{jac\PYGZus{}sg}\PYG{p}{)}

                \PYG{k}{break}

            \PYG{k}{else}\PYG{p}{:}

                \PYG{c+c1}{\PYGZsh{} setting up LM equation}
                \PYG{c+c1}{\PYGZsh{} [(MS.T)MS + lambda*diag((MS.T)MS)]*delta\PYGZus{}x = (MS.T)E}
                \PYG{c+c1}{\PYGZsh{} put the Eq. in the form A*delta\PYGZus{}x = B}

                \PYG{n}{A\PYGZus{}0} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{MS}\PYG{o}{.}\PYG{n}{T}\PYG{p}{,}  \PYG{n}{MS}\PYG{p}{)}
                \PYG{n}{A} \PYG{o}{=} \PYG{n}{A\PYGZus{}0} \PYG{o}{+} \PYG{n}{damp}\PYG{o}{*} \PYG{n}{np}\PYG{o}{.}\PYG{n}{diag}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{diag}\PYG{p}{(}\PYG{n}{A\PYGZus{}0}\PYG{p}{)}\PYG{p}{)}
                \PYG{n}{B} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{MS}\PYG{o}{.}\PYG{n}{T}\PYG{p}{,} \PYG{n}{E}\PYG{p}{)}
                \PYG{n}{delta\PYGZus{}x} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{solve}\PYG{p}{(}\PYG{n}{A}\PYG{p}{,} \PYG{n}{B}\PYG{p}{)}
                \PYG{c+c1}{\PYGZsh{} Update of the solution}

                \PYG{k}{for} \PYG{n}{k} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{ms\PYGZus{}obj}\PYG{o}{.}\PYG{n}{point\PYGZus{}number}\PYG{p}{)}\PYG{p}{:}
                    \PYG{n}{x\PYGZus{}new}\PYG{p}{[}\PYG{n}{k}\PYG{p}{,}\PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{n}{x}\PYG{p}{[}\PYG{n}{k}\PYG{p}{,}\PYG{p}{:}\PYG{p}{]} \PYG{o}{+} \PYG{n}{delta\PYGZus{}x}\PYG{p}{[}\PYG{n}{k}\PYG{o}{*}\PYG{n}{dim}\PYG{p}{:}\PYG{p}{(}\PYG{n}{k}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{*}\PYG{n}{dim}\PYG{p}{]}
                \PYG{n}{tau\PYGZus{}new} \PYG{o}{=} \PYG{n}{tau} \PYG{o}{+} \PYG{n}{delta\PYGZus{}x}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}
                \PYG{p}{[}\PYG{n}{E\PYGZus{}new}\PYG{p}{,}\PYG{n}{\PYGZus{}}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{ms\PYGZus{}obj}\PYG{o}{.}\PYG{n}{get\PYGZus{}error\PYGZus{}vector}\PYG{p}{(}\PYG{n}{x\PYGZus{}new}\PYG{p}{,} \PYG{n}{tau\PYGZus{}new}\PYG{p}{)}

                \PYG{k}{if} \PYG{n}{norm}\PYG{p}{(}\PYG{n}{E\PYGZus{}new}\PYG{p}{,} \PYG{n}{inf}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n}{norm}\PYG{p}{(}\PYG{n}{E}\PYG{p}{,} \PYG{n}{inf}\PYG{p}{)}\PYG{p}{:}
                    \PYG{n}{tau} \PYG{o}{=} \PYG{n}{tau\PYGZus{}new}
                    \PYG{n}{x} \PYG{o}{=} \PYG{n}{x\PYGZus{}new}
                    \PYG{n}{damp} \PYG{o}{=} \PYG{n}{damp} \PYG{o}{/} \PYG{l+m+mf}{10.0}
                \PYG{k}{else} \PYG{p}{:}
                    \PYG{n}{damp} \PYG{o}{=} \PYG{n}{damp} \PYG{o}{*} \PYG{l+m+mf}{10.0}
                \PYG{n}{ptlist}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{*}\PYG{n}{x}\PYG{p}{)}

        \PYG{k}{return} \PYG{n}{x}\PYG{p}{,} \PYG{n}{ptlist}\PYG{p}{,} \PYG{n}{error}\PYG{p}{,} \PYG{n}{complete\PYGZus{}solution}\PYG{p}{,} \PYG{n}{jac\PYGZus{}sg}
\end{sphinxVerbatim}
\end{quote}


\section{Floquet multipliers}
\label{\detokenize{multiple_shooting/floquet_multipliers:floquet-multipliers}}\label{\detokenize{multiple_shooting/floquet_multipliers::doc}}
Once the convergence is reached the Floquet multipliers can be automatically exctracted from the output of LMA solver.

The global Jacobian over one period is calculated considering the semi\sphinxhyphen{}group property:
\begin{equation}\label{equation:multiple_shooting/floquet_multipliers:jacobian_period}
\begin{split}\mathbb{J} (\mathbf{x}_0) \Big \rvert_{0}^{T} =    \mathbb{J} (\mathbf{x}_{m-1}) \Big \rvert_{t_{m-1}}^{T} \cdots  \mathbb{J} (\mathbf{x}_1) \Big \rvert_{t_{1}}^{t_{1}+\tau}\cdot \mathbb{J} (\mathbf{x}_0) \Big \rvert_{0}^{\tau}\end{split}
\end{equation}
Eigenvalues (Floquet multipliers) and eigenvectors, are then calculated with \sphinxcode{\sphinxupquote{python}} builtin functions from \sphinxcode{\sphinxupquote{linalg}}.


\chapter{Lyapunov exponent computation}
\label{\detokenize{lyapunov_exponent/index:lyapunov-exponent-computation}}\label{\detokenize{lyapunov_exponent/index::doc}}

\section{Lyapunov exponent computation}
\label{\detokenize{lyapunov_exponent/lyapunov:lyapunov-exponent-computation}}\label{\detokenize{lyapunov_exponent/lyapunov::doc}}
The computation of the largest lyapunov exponent is based on a long time integration of two nearby trajectories, in which the separation in calculated at fixed time intervals via a recursive rescaling of the mutual distance between the two trajectories.

\begin{figure}[htbp]
\centering

\noindent\sphinxincludegraphics[width=0.650\linewidth]{{lyapunov_rescaling}.pdf}
\end{figure}

The following formalism applies.

The leading trajectory starts from an initial value \(\mathbf{x}_1\). Fixed a sampling time \(\Delta t\), the \((i+1)-th\) point of the reference trajectory is:
\begin{equation}
\mathbf{x}_{i+1} = f\big(\mathbf{x}_{i}\big) \Big \rvert_{t_i}^{t_{i} + \Delta t}
\end{equation}
The neighbouring trajectory is initially perturbed with a perturbation \(\delta \mathbf{x}\). At every sampling point this trajectory is riscaled with the module of the initial perturbation at time \(t_0\).

The exact separation of the trajectories is:
\begin{equation}
\mathbf{d}_{i+1} = f\big(\mathbf{z}_{i}\big) \Big \rvert_{t_i}^{t_{i} + \Delta t}- \mathbf{x}_{i+1}
\end{equation}
the vector \(\mathbf{d}_{i+1}\) is re\sphinxhyphen{}scaled with the module of the initial perturbation \(|\delta \mathbf{x}|\).

The next integration point for the perturbed trajectory is therefore:
\begin{equation}
\mathbf{z}_{i+1} = \mathbf{x}_{i+1} + \mathbf{d}_{i+1} \frac{|\delta \mathbf{x}|}{|\mathbf{d}_{i+1}|}
\end{equation}
By recursively finding the \(\mathbf{z}_{i}\) points via rescaling the distance, and then measuring the deviation of the two trajectories, the estimation of the largest Lyapunov exponent is calculated then from the series:
\begin{equation}
\lambda_{t} = \frac{1}{N \Delta t} \sum_{i=1}^{N} \ln \Big(\frac{\delta \mathbf{x}}{|\mathbf{d}_{i}|}\Big)
\end{equation}

\chapter{Plotting functions}
\label{\detokenize{plotting/index:plotting-functions}}\label{\detokenize{plotting/index::doc}}

\section{Plotting functions}
\label{\detokenize{plotting/plotting:plotting-functions}}\label{\detokenize{plotting/plotting::doc}}
For a rapid visualisation of the simulation results, few plotting functionalities comes with the package.

The main class you need to care about is \sphinxcode{\sphinxupquote{Plot}}


\subsection{crawler.main}
\label{\detokenize{plotting/plotting:crawler-main}}

\chapter{Tutorial}
\label{\detokenize{tutorial/index:tutorial}}\label{\detokenize{tutorial/index::doc}}

\section{Isothermal reaction}
\label{\detokenize{tutorial/isothermal_reaction:isothermal-reaction}}\label{\detokenize{tutorial/isothermal_reaction::doc}}
An isothermal reaction is described by a set of ODEs of the form \sphinxcite{tutorial/isothermal_reaction:sey2009}
\begin{equation*}
\begin{split}\begin{equation}
\begin{aligned}
\dot{y_1} &= y_{1}(30 - 0.25y_{1} -y_{2} -y_{3}) + 0.001y_{2}^{2} + 0.1 \\
\dot{y_{2}} &= y_{2}(y_{1} - 0.001y_{2} - \lambda) + 0.1 \\
\dot{y_{3}} &= y_{3}(16.5 - y_{1} -0.5y_{3}) + 0.1
\end{aligned}
\end{equation}\end{split}
\end{equation*}
and the relative \sphinxstylestrong{stability matrix} is therefore:
\begin{equation*}
\begin{split}\begin{equation}
\mathbb{A}(\mathbf{x}(t), t) =
\begin{pmatrix}
30 - 0.5y_{1} -y_{2} -y_{3} & y_{1} + 2*0.001y_{2} & -y_{1}\\
y_{2}& y_{1} - 2*0.001y_{2} - \lambda & 0\\
-y_{3} & 0 & 16.5 - y_{1} - y_{3}
\end{pmatrix}
\end{equation}\end{split}
\end{equation*}\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
Generate the input file containing the ODE system and the hard code the stability matrix, inside \sphinxcode{\sphinxupquote{multiflap/odes/isothermal\_reaction.py}}:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}

\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{Example case adopted from:}

\PYG{l+s+sd}{    Practical Bifurcation and Stability Analysis, page 325}
\PYG{l+s+sd}{    Seydel R.}
\PYG{l+s+sd}{    Eq. (7.15) \PYGZhy{} Isothermal chemical reaction dynamics}


\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}

\PYG{k}{class} \PYG{n+nc}{IsothermalReaction}\PYG{p}{:}
    \PYG{k}{def} \PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{lam}\PYG{o}{=}\PYG{l+m+mf}{1.8}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{lam} \PYG{o}{=} \PYG{n}{lam}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dimension}\PYG{o}{=}\PYG{l+m+mi}{3}        \PYG{c+c1}{\PYGZsh{} specify the dimension of the problem}
    \PYG{k}{def} \PYG{n+nf}{dynamics}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x0}\PYG{p}{,} \PYG{n}{t}\PYG{p}{)}\PYG{p}{:}

        \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}ODE system}
\PYG{l+s+sd}{        This function will be passed to the numerical integrator}

\PYG{l+s+sd}{        Inputs:}
\PYG{l+s+sd}{            x0: initial values}
\PYG{l+s+sd}{            t: time}

\PYG{l+s+sd}{        Outputs:}
\PYG{l+s+sd}{            x\PYGZus{}dot: velocity vector}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{y1}\PYG{p}{,} \PYG{n}{y2}\PYG{p}{,} \PYG{n}{y3} \PYG{o}{=} \PYG{n}{x0}
        \PYG{n}{dy1\PYGZus{}dt} \PYG{o}{=} \PYG{n}{y1}\PYG{o}{*}\PYG{p}{(}\PYG{l+m+mi}{30} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.25}\PYG{o}{*}\PYG{n}{y1} \PYG{o}{\PYGZhy{}}\PYG{n}{y2} \PYG{o}{\PYGZhy{}}\PYG{n}{y3}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mf}{0.001}\PYG{o}{*}\PYG{n}{y2}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} \PYG{o}{+} \PYG{l+m+mf}{0.1}
        \PYG{n}{dy2\PYGZus{}dt} \PYG{o}{=} \PYG{n}{y2}\PYG{o}{*}\PYG{p}{(}\PYG{n}{y1} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.001}\PYG{o}{*}\PYG{n}{y2} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{lam}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mf}{0.1}
        \PYG{n}{dy3\PYGZus{}dt} \PYG{o}{=} \PYG{n}{y3}\PYG{o}{*}\PYG{p}{(}\PYG{l+m+mf}{16.5} \PYG{o}{\PYGZhy{}} \PYG{n}{y1} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.5}\PYG{o}{*}\PYG{n}{y3}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mf}{0.1}

        \PYG{n}{vel\PYGZus{}array} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{dy1\PYGZus{}dt}\PYG{p}{,} \PYG{n}{dy2\PYGZus{}dt}\PYG{p}{,} \PYG{n}{dy3\PYGZus{}dt}\PYG{p}{]}\PYG{p}{,} \PYG{n+nb}{float}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{vel\PYGZus{}array}


    \PYG{k}{def} \PYG{n+nf}{get\PYGZus{}stability\PYGZus{}matrix}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x0}\PYG{p}{,} \PYG{n}{t}\PYG{p}{)}\PYG{p}{:}

        \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Stability matrix of the ODE system}

\PYG{l+s+sd}{        Inputs:}
\PYG{l+s+sd}{            x0: initial condition}
\PYG{l+s+sd}{        Outputs:}
\PYG{l+s+sd}{            A: Stability matrix evaluated at x0. (dxd) dimension}
\PYG{l+s+sd}{            A[i, j] = dv[i]/dx[j]}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{y1}\PYG{p}{,} \PYG{n}{y2}\PYG{p}{,} \PYG{n}{y3} \PYG{o}{=} \PYG{n}{x0}
        \PYG{n}{A\PYGZus{}matrix} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{p}{[}\PYG{l+m+mi}{30} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.5}\PYG{o}{*}\PYG{n}{y1} \PYG{o}{\PYGZhy{}}\PYG{n}{y2} \PYG{o}{\PYGZhy{}}\PYG{n}{y3}\PYG{p}{,} \PYG{n}{y1} \PYG{o}{+} \PYG{l+m+mi}{2}\PYG{o}{*}\PYG{l+m+mf}{0.001}\PYG{o}{*}\PYG{n}{y2}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{y1}\PYG{p}{]}\PYG{p}{,}
                            \PYG{p}{[}\PYG{n}{y2}\PYG{p}{,} \PYG{n}{y1} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{2}\PYG{o}{*}\PYG{l+m+mf}{0.001}\PYG{o}{*}\PYG{n}{y2} \PYG{o}{\PYGZhy{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{lam}\PYG{p}{,} \PYG{l+m+mf}{0.}\PYG{p}{]}\PYG{p}{,}
                            \PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{n}{y3}\PYG{p}{,} \PYG{l+m+mf}{0.}\PYG{p}{,} \PYG{l+m+mf}{16.5} \PYG{o}{\PYGZhy{}} \PYG{n}{y1} \PYG{o}{\PYGZhy{}} \PYG{n}{y3}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} \PYG{n+nb}{float}\PYG{p}{)}

        \PYG{k}{return} \PYG{n}{A\PYGZus{}matrix}
\end{sphinxVerbatim}

\item {} 
Generate the main file to run in the directory \sphinxcode{\sphinxupquote{multiflap/main\_isothermal.py}}:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\PYG{k+kn}{from}  \PYG{n+nn}{odes}\PYG{n+nn}{.}\PYG{n+nn}{isothermal\PYGZus{}reaction} \PYG{k+kn}{import} \PYG{n}{IsothermalReaction}
\PYG{k+kn}{from} \PYG{n+nn}{ms\PYGZus{}package}\PYG{n+nn}{.}\PYG{n+nn}{multiple\PYGZus{}shooting\PYGZus{}period} \PYG{k+kn}{import} \PYG{n}{MultipleShootingPeriod}
\PYG{k+kn}{import} \PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot} \PYG{k}{as} \PYG{n+nn}{plt}
\PYG{k+kn}{from} \PYG{n+nn}{ms\PYGZus{}package}\PYG{n+nn}{.}\PYG{n+nn}{lma\PYGZus{}solver\PYGZus{}period} \PYG{k+kn}{import} \PYG{n}{SolverPeriod}
\PYG{k+kn}{from} \PYG{n+nn}{mpl\PYGZus{}toolkits}\PYG{n+nn}{.}\PYG{n+nn}{mplot3d} \PYG{k+kn}{import} \PYG{n}{Axes3D}

\PYG{c+c1}{\PYGZsh{} generate the ODEs object}

\PYG{n}{mymodel} \PYG{o}{=} \PYG{n}{IsothermalReaction}\PYG{p}{(}\PYG{n}{lam}\PYG{o}{=}\PYG{l+m+mf}{11.}\PYG{p}{)}


\PYG{c+c1}{\PYGZsh{} initial condition}
\PYG{n}{x} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mf}{40.}\PYG{p}{,} \PYG{l+m+mf}{20.}\PYG{p}{,} \PYG{l+m+mf}{20.}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} generate the multiple shooting object}
\PYG{n}{ms\PYGZus{}obj} \PYG{o}{=} \PYG{n}{MultipleShootingPeriod}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{M}\PYG{o}{=}\PYG{l+m+mi}{20}\PYG{p}{,} \PYG{n}{period\PYGZus{}guess}\PYG{o}{=}\PYG{o}{.}\PYG{l+m+mi}{5}\PYG{p}{,}
                                \PYG{n}{t\PYGZus{}steps}\PYG{o}{=}\PYG{l+m+mi}{200}\PYG{p}{,} \PYG{n}{model}\PYG{o}{=}\PYG{n}{mymodel}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} just to plot the initial guess distribution. No need to call this}
\PYG{n}{initial\PYGZus{}guess} \PYG{o}{=} \PYG{n}{ms\PYGZus{}obj}\PYG{o}{.}\PYG{n}{get\PYGZus{}initial\PYGZus{}guess}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} call the solver for the multiple\PYGZhy{}shooting algorithm}
\PYG{n}{mysolution} \PYG{o}{=} \PYG{n}{SolverPeriod}\PYG{p}{(}\PYG{n}{ms\PYGZus{}obj}\PYG{o}{=}\PYG{n}{ms\PYGZus{}obj}\PYG{p}{)}\PYG{o}{.}\PYG{n}{lma}\PYG{p}{(}\PYG{p}{)}

\PYG{n}{jacobian} \PYG{o}{=} \PYG{n}{mysolution}\PYG{p}{[}\PYG{l+m+mi}{4}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Floquet multipliers}
\PYG{n}{eigenvalues}\PYG{p}{,} \PYG{n}{eigenvectors} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{eig}\PYG{p}{(}\PYG{n}{jacobian}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} ODE limit cycle solution}
\PYG{n}{sol\PYGZus{}array} \PYG{o}{=} \PYG{n}{mysolution}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{o}{.}\PYG{n}{space}
\PYG{n}{sol\PYGZus{}time} \PYG{o}{=} \PYG{n}{mysolution}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{o}{.}\PYG{n}{time}
\PYG{n}{period} \PYG{o}{=} \PYG{n}{sol\PYGZus{}time}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} plot the phase portrait of the limit cycle}
\PYG{n}{fig1} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{ax} \PYG{o}{=} \PYG{n}{fig1}\PYG{o}{.}\PYG{n}{gca}\PYG{p}{(}\PYG{n}{projection}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{3d}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZdl{}x\PYGZdl{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZdl{}y\PYGZdl{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}zlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZdl{}z\PYGZdl{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{initial\PYGZus{}guess}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}
           \PYG{n}{initial\PYGZus{}guess}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,}
           \PYG{n}{initial\PYGZus{}guess}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{initial guess}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{sol\PYGZus{}array}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}
        \PYG{n}{sol\PYGZus{}array}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,}
        \PYG{n}{sol\PYGZus{}array}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,}\PYG{n}{color} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\item {} 
Run the main file inside \sphinxcode{\sphinxupquote{multiflap}} directory:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{python3} \PYG{n}{main\PYGZus{}isothermal}\PYG{o}{.}\PYG{n}{py}
\end{sphinxVerbatim}

\end{enumerate}

the output will look like

\begin{figure}[htbp]
\centering

\noindent\sphinxincludegraphics[width=0.800\linewidth]{{isothermal_reaction}.png}
\end{figure}
\phantomsection\label{\detokenize{tutorial/isothermal_reaction:module-..-multiflap-ms_package-multiple_shooting_period}}\phantomsection\label{\detokenize{tutorial/isothermal_reaction:module-../multiflap/ms_package/multiple_shooting_period}}\index{module@\spxentry{module}!../multiflap/ms\_package/multiple\_shooting\_period@\spxentry{../multiflap/ms\_package/multiple\_shooting\_period}}\index{../multiflap/ms\_package/multiple\_shooting\_period@\spxentry{../multiflap/ms\_package/multiple\_shooting\_period}!module@\spxentry{module}}

\section{Redox oscillation}
\label{\detokenize{tutorial/redox_oscillation:redox-oscillation}}\label{\detokenize{tutorial/redox_oscillation::doc}}
The set of ODEs for this system is \sphinxcite{tutorial/redox_oscillation:dos2019}:
\begin{equation*}
\begin{split}\frac{dD_{1}}{dt} &= p - aA D_{1} -d D_{1}\\
\frac{dD_{2}}{dt} &= dD_{1} - eD_{2}\\
\frac{dR}{dt} &= eD_{2} - qR\\
\frac{dA}{dt} &= bIR - aAD_{1}\end{split}
\end{equation*}
and the stability matrix:
\begin{equation*}
\begin{split}\begin{equation}
\mathbb{A}(\mathbf{x}(t), t) =
\begin{pmatrix}
-d -aA & 0 & 0 & -aD_{1}\\
d & -e & 0 & 0\\
0 & e & -q & 0\\
-aA & 0 & b(1-a) & -bR -aD_{1}
\end{pmatrix}
\end{equation}\end{split}
\end{equation*}\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
Generate the input file containing the ODE system and the hard code the stability matrix, inside \sphinxcode{\sphinxupquote{multiflap/odes/redox\_oscillation.py}}:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class} \PYG{n+nc}{RedoxModel}\PYG{p}{:}
    \PYG{k}{def} \PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{a}\PYG{o}{=}\PYG{l+m+mi}{1000}\PYG{p}{,} \PYG{n}{b}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{c}\PYG{o}{=}\PYG{l+m+mi}{10000}\PYG{p}{,} \PYG{n}{d}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{e}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{q}\PYG{o}{=}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{p}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}

        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{a} \PYG{o}{=} \PYG{n}{a}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{b} \PYG{o}{=} \PYG{n}{b}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{c} \PYG{o}{=} \PYG{n}{c}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{d} \PYG{o}{=} \PYG{n}{d}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{e} \PYG{o}{=} \PYG{n}{e}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{q} \PYG{o}{=} \PYG{n}{q}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{p} \PYG{o}{=} \PYG{n}{p}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dimension} \PYG{o}{=} \PYG{l+m+mi}{4}
    \PYG{k}{def} \PYG{n+nf}{dynamics}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x0}\PYG{p}{,} \PYG{n}{t}\PYG{p}{)}\PYG{p}{:}

        \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}ODE system}
\PYG{l+s+sd}{        This function will be passed to the numerical integrator}

\PYG{l+s+sd}{        Inputs:}
\PYG{l+s+sd}{            x0: initial values}
\PYG{l+s+sd}{            t: time}

\PYG{l+s+sd}{        Outputs:}
\PYG{l+s+sd}{            x\PYGZus{}dot: velocity vector}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{D1}\PYG{p}{,} \PYG{n}{D2}\PYG{p}{,} \PYG{n}{R}\PYG{p}{,} \PYG{n}{A} \PYG{o}{=} \PYG{n}{x0}
        \PYG{n}{dD1\PYGZus{}dt} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{p} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{a}\PYG{o}{*}\PYG{n}{A}\PYG{o}{*}\PYG{n}{D1} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{d}\PYG{o}{*}\PYG{n}{D1}
        \PYG{n}{dD2\PYGZus{}dt} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{d}\PYG{o}{*}\PYG{n}{D1} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{e}\PYG{o}{*}\PYG{n}{D2}
        \PYG{n}{dR\PYGZus{}dt} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{e}\PYG{o}{*}\PYG{n}{D2} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{q}\PYG{o}{*}\PYG{n}{R}
        \PYG{n}{dA\PYGZus{}dt} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{b}\PYG{o}{*}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{A}\PYG{p}{)}\PYG{o}{*}\PYG{n}{R} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{a}\PYG{o}{*}\PYG{n}{A}\PYG{o}{*}\PYG{n}{D1}

        \PYG{n}{vel\PYGZus{}array} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{dD1\PYGZus{}dt}\PYG{p}{,} \PYG{n}{dD2\PYGZus{}dt}\PYG{p}{,} \PYG{n}{dR\PYGZus{}dt}\PYG{p}{,} \PYG{n}{dA\PYGZus{}dt}\PYG{p}{]}\PYG{p}{,} \PYG{n+nb}{float}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{vel\PYGZus{}array}



    \PYG{k}{def} \PYG{n+nf}{get\PYGZus{}stability\PYGZus{}matrix}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x0}\PYG{p}{,} \PYG{n}{t}\PYG{p}{)}\PYG{p}{:}

        \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Stability matrix of the ODE system}

\PYG{l+s+sd}{        Inputs:}
\PYG{l+s+sd}{            x0: initial condition}
\PYG{l+s+sd}{        Outputs:}
\PYG{l+s+sd}{            A: Stability matrix evaluated at x0. (dxd) dimension}
\PYG{l+s+sd}{            A[i, j] = dv[i]/dx[j]}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{D1}\PYG{p}{,} \PYG{n}{D2}\PYG{p}{,} \PYG{n}{R}\PYG{p}{,} \PYG{n}{A} \PYG{o}{=} \PYG{n}{x0}
        \PYG{n}{A\PYGZus{}matrix} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{d} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{a}\PYG{o}{*}\PYG{n}{A}\PYG{p}{,}  \PYG{l+m+mf}{0.}\PYG{p}{,} \PYG{l+m+mf}{0.}\PYG{p}{,}\PYG{o}{\PYGZhy{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{a}\PYG{o}{*}\PYG{n}{D1}\PYG{p}{]}\PYG{p}{,}
                      \PYG{p}{[}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{d}\PYG{p}{,}  \PYG{o}{\PYGZhy{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{e}\PYG{p}{,} \PYG{l+m+mf}{0.}\PYG{p}{,} \PYG{l+m+mf}{0.}\PYG{p}{]}\PYG{p}{,}
                      \PYG{p}{[}\PYG{l+m+mf}{0.}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{e}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{q}\PYG{p}{,} \PYG{l+m+mf}{0.}\PYG{p}{]}\PYG{p}{,}
                      \PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{a}\PYG{o}{*}\PYG{n}{A}\PYG{p}{,} \PYG{l+m+mf}{0.}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{b}\PYG{o}{*}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{A}\PYG{p}{)}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{b}\PYG{o}{*}\PYG{n}{R} \PYG{o}{\PYGZhy{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{a}\PYG{o}{*}\PYG{n}{D1}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} \PYG{n+nb}{float}\PYG{p}{)}

        \PYG{k}{return} \PYG{n}{A\PYGZus{}matrix}
\end{sphinxVerbatim}

\item {} 
Generate the main file to run in the directory \sphinxcode{\sphinxupquote{multiflap/redox\_main.py}}:

\end{enumerate}

Import the class generated in the input file \sphinxcode{\sphinxupquote{RedoxModel}} and the modules to run and solve the multiple\sphinxhyphen{}shooting

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from}  \PYG{n+nn}{odes}\PYG{n+nn}{.}\PYG{n+nn}{rossler} \PYG{k+kn}{import} \PYG{n}{RedoxModel}
\PYG{k+kn}{from} \PYG{n+nn}{ms\PYGZus{}package}\PYG{n+nn}{.}\PYG{n+nn}{rk\PYGZus{}integrator} \PYG{k+kn}{import} \PYG{n}{rk4}
\PYG{k+kn}{from} \PYG{n+nn}{ms\PYGZus{}package}\PYG{n+nn}{.}\PYG{n+nn}{multiple\PYGZus{}shooting\PYGZus{}period} \PYG{k+kn}{import} \PYG{n}{MultipleShootingPeriod}
\PYG{k+kn}{from} \PYG{n+nn}{ms\PYGZus{}package}\PYG{n+nn}{.}\PYG{n+nn}{lma\PYGZus{}solver\PYGZus{}period} \PYG{k+kn}{import} \PYG{n}{SolverPeriod}
\end{sphinxVerbatim}

set the initial guess:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{x} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{]}
\end{sphinxVerbatim}

Generate the object containing the Rossler’s equations:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{mymodel} \PYG{o}{=} \PYG{n}{RedoxModel}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

Passe the object to the multiple\sphinxhyphen{}shooting class, and solve it

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{ms\PYGZus{}obj} \PYG{o}{=}  \PYG{n}{MultipleShootingPeriod}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{M}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{period\PYGZus{}guess}\PYG{o}{=} \PYG{l+m+mf}{23.}\PYG{p}{,} \PYG{n}{t\PYGZus{}steps}\PYG{o}{=}\PYG{l+m+mi}{50000}\PYG{p}{,} \PYG{n}{model}\PYG{o}{=}\PYG{n}{mymodel}\PYG{p}{)}
\PYG{n}{mysol} \PYG{o}{=} \PYG{n}{SolverPeriod}\PYG{p}{(}\PYG{n}{ms\PYGZus{}obj} \PYG{o}{=} \PYG{n}{ms\PYGZus{}obj}\PYG{p}{)}\PYG{o}{.}\PYG{n}{lma}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxcode{\sphinxupquote{\textasciigrave{}redox\_main.py}} \sphinxstylestrong{Show full main}
\begin{quote}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\PYG{k+kn}{from}  \PYG{n+nn}{odes}\PYG{n+nn}{.}\PYG{n+nn}{redox\PYGZus{}oscillation} \PYG{k+kn}{import} \PYG{n}{RedoxModel}
\PYG{k+kn}{from} \PYG{n+nn}{ms\PYGZus{}package}\PYG{n+nn}{.}\PYG{n+nn}{rk\PYGZus{}integrator} \PYG{k+kn}{import} \PYG{n}{rk4}
\PYG{k+kn}{from} \PYG{n+nn}{ms\PYGZus{}package}\PYG{n+nn}{.}\PYG{n+nn}{multiple\PYGZus{}shooting\PYGZus{}period} \PYG{k+kn}{import} \PYG{n}{MultipleShootingPeriod}
\PYG{k+kn}{from} \PYG{n+nn}{scipy}\PYG{n+nn}{.}\PYG{n+nn}{integrate} \PYG{k+kn}{import} \PYG{n}{odeint}
\PYG{k+kn}{import} \PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot} \PYG{k}{as} \PYG{n+nn}{plt}
\PYG{k+kn}{from} \PYG{n+nn}{ms\PYGZus{}package}\PYG{n+nn}{.}\PYG{n+nn}{lma\PYGZus{}solver\PYGZus{}period} \PYG{k+kn}{import} \PYG{n}{SolverPeriod}

\PYG{n}{x} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{l+m+mf}{0.2}\PYG{p}{]}

\PYG{n}{time\PYGZus{}array} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{180}\PYG{p}{,} \PYG{l+m+mi}{90000}\PYG{p}{)}
\PYG{n}{mymodel} \PYG{o}{=} \PYG{n}{RedoxModel}\PYG{p}{(}\PYG{p}{)}

\PYG{n}{ms\PYGZus{}obj} \PYG{o}{=}  \PYG{n}{MultipleShootingPeriod}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{M}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{period\PYGZus{}guess}\PYG{o}{=} \PYG{l+m+mf}{23.}\PYG{p}{,} \PYG{n}{t\PYGZus{}steps}\PYG{o}{=}\PYG{l+m+mi}{50000}\PYG{p}{,} \PYG{n}{model}\PYG{o}{=}\PYG{n}{mymodel}\PYG{p}{)}

\PYG{n}{mysol} \PYG{o}{=} \PYG{n}{SolverPeriod}\PYG{p}{(}\PYG{n}{ms\PYGZus{}obj} \PYG{o}{=} \PYG{n}{ms\PYGZus{}obj}\PYG{p}{)}\PYG{o}{.}\PYG{n}{lma}\PYG{p}{(}\PYG{p}{)}

\PYG{n}{jac} \PYG{o}{=} \PYG{n}{mysol}\PYG{p}{[}\PYG{l+m+mi}{4}\PYG{p}{]}

\PYG{n}{eigenvalues}\PYG{p}{,} \PYG{n}{eigenvectors} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{eig}\PYG{p}{(}\PYG{n}{jac}\PYG{p}{)}


\PYG{n}{sol\PYGZus{}array} \PYG{o}{=} \PYG{n}{mysol}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{o}{.}\PYG{n}{space}
\PYG{n}{sol\PYGZus{}time} \PYG{o}{=} \PYG{n}{mysol}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{o}{.}\PYG{n}{time}
\PYG{n}{period} \PYG{o}{=} \PYG{n}{sol\PYGZus{}time}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(} \PYG{n}{sol\PYGZus{}time}\PYG{p}{,} \PYG{n}{sol\PYGZus{}array}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{D1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(} \PYG{n}{sol\PYGZus{}time}\PYG{p}{,} \PYG{n}{sol\PYGZus{}array}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{D2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(} \PYG{n}{sol\PYGZus{}time}\PYG{p}{,} \PYG{n}{sol\PYGZus{}array}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(} \PYG{n}{sol\PYGZus{}time}\PYG{p}{,} \PYG{n}{sol\PYGZus{}array}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{A}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}
\end{quote}

The solution is shown below:

\begin{figure}[htbp]
\centering

\noindent\sphinxincludegraphics[width=0.650\linewidth]{{redox_oscillation}.png}
\end{figure}

and the value of the stable Floquet multipliers is also plotted:

\begin{figure}[htbp]
\centering

\noindent\sphinxincludegraphics[width=0.650\linewidth]{{redox_multipliers}.png}
\end{figure}


\section{Rossler’s system}
\label{\detokenize{tutorial/rossler:rossler-s-system}}\label{\detokenize{tutorial/rossler::doc}}
Rossler’s system is described by the system of differential equations:
\begin{equation*}
\begin{split}\dot{x}&= -y - z\\
\dot{y} &= x + ay \\
\dot{z} &= b + z(x-c) \\\end{split}
\end{equation*}
The stability matrix of this system is:
\begin{equation*}
\begin{split}\begin{equation}
\mathbb{A}(\mathbf{x}(t), t) =
\begin{pmatrix}
0 & -1 & -1\\
1 & a & 0\\
z & 0 & x-c
\end{pmatrix}
\end{equation}\end{split}
\end{equation*}\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
Generate the input file containing the ODE system and the hard code the stability matrix, inside \sphinxcode{\sphinxupquote{multiflap/odes/rossler.py}}:

\end{enumerate}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}


\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{Case adopted from:}

\PYG{l+s+sd}{    Optimized shooting method for finding periodic orbits of nonlinear dynamical systems}
\PYG{l+s+sd}{    Dednam, W and Botha, Andre E}
\PYG{l+s+sd}{    https://arxiv.org/abs/1405.5347}

\PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{k}{class} \PYG{n+nc}{Rossler}\PYG{p}{:}
    \PYG{k}{def} \PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{a}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{b}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{c}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{d}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{e}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{q}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{p}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}

        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{a} \PYG{o}{=} \PYG{n}{a}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{b} \PYG{o}{=} \PYG{n}{b}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{c} \PYG{o}{=} \PYG{n}{c}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{d} \PYG{o}{=} \PYG{n}{d}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{e} \PYG{o}{=} \PYG{n}{e}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{q} \PYG{o}{=} \PYG{n}{q}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{p} \PYG{o}{=} \PYG{n}{p}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dimension} \PYG{o}{=} \PYG{l+m+mi}{3}
    \PYG{k}{def} \PYG{n+nf}{dynamics}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x0}\PYG{p}{,} \PYG{n}{t}\PYG{p}{)}\PYG{p}{:}

        \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}ODE system}
\PYG{l+s+sd}{        This function will be passed to the numerical integrator}

\PYG{l+s+sd}{        Inputs:}
\PYG{l+s+sd}{            x0: initial values}
\PYG{l+s+sd}{            t: time}

\PYG{l+s+sd}{        Outputs:}
\PYG{l+s+sd}{            x\PYGZus{}dot: velocity vector}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{z} \PYG{o}{=} \PYG{n}{x0}
        \PYG{n}{dxdt} \PYG{o}{=} \PYG{o}{\PYGZhy{}} \PYG{n}{y} \PYG{o}{\PYGZhy{}} \PYG{n}{z}
        \PYG{n}{dydt} \PYG{o}{=} \PYG{n}{x} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{a}\PYG{o}{*}\PYG{n}{y}
        \PYG{n}{dzdt} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{b} \PYG{o}{+} \PYG{n}{z}\PYG{o}{*}\PYG{p}{(}\PYG{n}{x} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{c}\PYG{p}{)}
        \PYG{n}{vel\PYGZus{}array} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{dxdt}\PYG{p}{,} \PYG{n}{dydt}\PYG{p}{,} \PYG{n}{dzdt}\PYG{p}{]}\PYG{p}{,} \PYG{n+nb}{float}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{vel\PYGZus{}array}



    \PYG{k}{def} \PYG{n+nf}{get\PYGZus{}stability\PYGZus{}matrix}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x0}\PYG{p}{,} \PYG{n}{t}\PYG{p}{)}\PYG{p}{:}

        \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Stability matrix of the ODE system}

\PYG{l+s+sd}{        Inputs:}
\PYG{l+s+sd}{            x0: initial condition}
\PYG{l+s+sd}{        Outputs:}
\PYG{l+s+sd}{            A: Stability matrix evaluated at x0. (dxd) dimension}
\PYG{l+s+sd}{            A[i, j] = dv[i]/dx[j]}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{z} \PYG{o}{=} \PYG{n}{x0}
        \PYG{n}{A\PYGZus{}matrix} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,}
                            \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{a}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}
                            \PYG{p}{[}\PYG{n}{z}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{x}\PYG{o}{\PYGZhy{}}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{c}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} \PYG{n+nb}{float}\PYG{p}{)}

        \PYG{k}{return} \PYG{n}{A\PYGZus{}matrix}
\end{sphinxVerbatim}
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\setcounter{enumi}{1}
\item {} 
Generate the main file to run in the directory \sphinxcode{\sphinxupquote{multiflap/main\_rossler.py}}:

\end{enumerate}

Import the class generated in the input file \sphinxcode{\sphinxupquote{Rossler}} and the modules to run and solve the multiple\sphinxhyphen{}shooting

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from}  \PYG{n+nn}{odes}\PYG{n+nn}{.}\PYG{n+nn}{rossler} \PYG{k+kn}{import} \PYG{n}{Rossler}
\PYG{k+kn}{from} \PYG{n+nn}{ms\PYGZus{}package}\PYG{n+nn}{.}\PYG{n+nn}{rk\PYGZus{}integrator} \PYG{k+kn}{import} \PYG{n}{rk4}
\PYG{k+kn}{from} \PYG{n+nn}{ms\PYGZus{}package}\PYG{n+nn}{.}\PYG{n+nn}{multiple\PYGZus{}shooting\PYGZus{}period} \PYG{k+kn}{import} \PYG{n}{MultipleShooting}
\PYG{k+kn}{from} \PYG{n+nn}{ms\PYGZus{}package}\PYG{n+nn}{.}\PYG{n+nn}{lma\PYGZus{}solver\PYGZus{}period} \PYG{k+kn}{import} \PYG{n}{Solver}
\end{sphinxVerbatim}

set the initial guess:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{x} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mf}{10.}\PYG{p}{,} \PYG{l+m+mf}{10.}\PYG{p}{,} \PYG{l+m+mf}{3.6}\PYG{p}{]}
\end{sphinxVerbatim}

Generate the object containing the Rossler’s equations:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{mymodel} \PYG{o}{=} \PYG{n}{Rossler}\PYG{p}{(}\PYG{n}{a}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{b}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{c}\PYG{o}{=}\PYG{l+m+mf}{5.7}\PYG{p}{)}
\end{sphinxVerbatim}

Passe the object to the multiple\sphinxhyphen{}shooting class, and solve it

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{ms\PYGZus{}obj} \PYG{o}{=}  \PYG{n}{MultipleShooting}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{M}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{period\PYGZus{}guess}\PYG{o}{=} \PYG{l+m+mf}{5.}\PYG{p}{,} \PYG{n}{t\PYGZus{}steps}\PYG{o}{=}\PYG{l+m+mi}{50000}\PYG{p}{,} \PYG{n}{model}\PYG{o}{=}\PYG{n}{mymodel}\PYG{p}{)}
\PYG{n}{mysol} \PYG{o}{=} \PYG{n}{Solver}\PYG{p}{(}\PYG{n}{ms\PYGZus{}obj} \PYG{o}{=} \PYG{n}{ms\PYGZus{}obj}\PYG{p}{)}\PYG{o}{.}\PYG{n}{lma}\PYG{p}{(}\PYG{l+m+mf}{5.}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxcode{\sphinxupquote{rossler\_main.py}} \sphinxstylestrong{Show full main}
\begin{quote}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\PYG{k+kn}{from}  \PYG{n+nn}{odes}\PYG{n+nn}{.}\PYG{n+nn}{rossler} \PYG{k+kn}{import} \PYG{n}{Rossler}
\PYG{k+kn}{from} \PYG{n+nn}{ms\PYGZus{}package}\PYG{n+nn}{.}\PYG{n+nn}{rk\PYGZus{}integrator} \PYG{k+kn}{import} \PYG{n}{rk4}
\PYG{k+kn}{from} \PYG{n+nn}{ms\PYGZus{}package}\PYG{n+nn}{.}\PYG{n+nn}{multiple\PYGZus{}shooting\PYGZus{}period} \PYG{k+kn}{import} \PYG{n}{MultipleShooting}
\PYG{k+kn}{from} \PYG{n+nn}{scipy}\PYG{n+nn}{.}\PYG{n+nn}{integrate} \PYG{k+kn}{import} \PYG{n}{odeint}
\PYG{k+kn}{import} \PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot} \PYG{k}{as} \PYG{n+nn}{plt}
\PYG{k+kn}{from} \PYG{n+nn}{ms\PYGZus{}package}\PYG{n+nn}{.}\PYG{n+nn}{lma\PYGZus{}solver\PYGZus{}period} \PYG{k+kn}{import} \PYG{n}{Solver}

\PYG{n}{x} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mf}{10.}\PYG{p}{,} \PYG{l+m+mf}{10.}\PYG{p}{,} \PYG{l+m+mf}{3.6}\PYG{p}{]}

\PYG{n}{time\PYGZus{}array} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{180}\PYG{p}{,} \PYG{l+m+mi}{90000}\PYG{p}{)}
\PYG{n}{mymodel} \PYG{o}{=} \PYG{n}{Rossler}\PYG{p}{(}\PYG{n}{a}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{b}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{c}\PYG{o}{=}\PYG{l+m+mf}{5.7}\PYG{p}{)}

\PYG{n}{ms\PYGZus{}obj} \PYG{o}{=}  \PYG{n}{MultipleShooting}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{M}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{period\PYGZus{}guess}\PYG{o}{=} \PYG{l+m+mf}{5.}\PYG{p}{,} \PYG{n}{t\PYGZus{}steps}\PYG{o}{=}\PYG{l+m+mi}{50000}\PYG{p}{,} \PYG{n}{model}\PYG{o}{=}\PYG{n}{mymodel}\PYG{p}{)}

\PYG{n}{mysol} \PYG{o}{=} \PYG{n}{Solver}\PYG{p}{(}\PYG{n}{ms\PYGZus{}obj} \PYG{o}{=} \PYG{n}{ms\PYGZus{}obj}\PYG{p}{)}\PYG{o}{.}\PYG{n}{lma}\PYG{p}{(}\PYG{l+m+mf}{5.}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{/Users/gducci/UCL/PROJECT/Simulations/class\PYGZus{}test}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{jac} \PYG{o}{=} \PYG{n}{mysol}\PYG{p}{[}\PYG{l+m+mi}{4}\PYG{p}{]}

\PYG{n}{eigenvalues}\PYG{p}{,} \PYG{n}{eigenvectors} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{eig}\PYG{p}{(}\PYG{n}{jac}\PYG{p}{)}


\PYG{n}{sol\PYGZus{}array} \PYG{o}{=} \PYG{n}{mysol}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{o}{.}\PYG{n}{space}
\PYG{n}{sol\PYGZus{}time} \PYG{o}{=} \PYG{n}{mysol}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{o}{.}\PYG{n}{time}
\PYG{n}{period} \PYG{o}{=} \PYG{n}{sol\PYGZus{}time}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(} \PYG{n}{sol\PYGZus{}time}\PYG{p}{,} \PYG{n}{sol\PYGZus{}array}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{D1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(} \PYG{n}{sol\PYGZus{}time}\PYG{p}{,} \PYG{n}{sol\PYGZus{}array}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{D2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(} \PYG{n}{sol\PYGZus{}time}\PYG{p}{,} \PYG{n}{sol\PYGZus{}array}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}
\end{quote}

The relocation of the points is shown in the following animation.




\section{Bird model dynamics}
\label{\detokenize{tutorial/bird_dynamics:bird-model-dynamics}}\label{\detokenize{tutorial/bird_dynamics::doc}}
This tutorial reproduces step\sphinxhyphen{}by\sphinxhyphen{}step the results obtained analysing the bird dynamics.


\subsection{Imposing the bird kinematics}
\label{\detokenize{tutorial/bird_dynamics:imposing-the-bird-kinematics}}
The bird wing is a poliarticulated rigid body, with three joints: shoulder, elbow and wrist. Each joint motion is governed by a periodic function of the form:
\begin{equation}\label{equation:tutorial/bird_dynamics:joint_kinematics}
\begin{split}q_i(t) = q_{0,i} + A_i \sin\left(\omega t + \phi_{0,i}\right)\end{split}
\end{equation}
where \(q_{i}\) is the rotation of the joint with respect to the generic axis \(i\).

The module \sphinxcode{\sphinxupquote{multiflap/aero\_package/kinematics\_constructor.py}} allows to impose the kinamatics on each wing joint.

\sphinxcode{\sphinxupquote{kinematics\_constructor.py}} \sphinxstylestrong{Show code}
\begin{quote}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\PYG{k+kn}{import} \PYG{n+nn}{math} \PYG{k}{as} \PYG{n+nn}{m}

\PYG{n}{frequency}  \PYG{o}{=} \PYG{l+m+mi}{4}
\PYG{n}{omega} \PYG{o}{=} \PYG{n}{frequency}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}

\PYG{k}{class} \PYG{n+nc}{Joint}\PYG{p}{:}
    \PYG{n}{omega} \PYG{o}{=} \PYG{n}{frequency}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}

    \PYG{k}{def} \PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{offset}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{amplitude}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{phase}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{offset} \PYG{o}{=} \PYG{n}{offset}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{amplitude} \PYG{o}{=} \PYG{n}{amplitude}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{phase} \PYG{o}{=} \PYG{n}{phase}

    \PYG{k}{def} \PYG{n+nf}{motion\PYGZus{}joint}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{t}\PYG{p}{)}\PYG{p}{:}

        \PYG{n}{motion} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{offset} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{amplitude}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{omega}\PYG{o}{*}\PYG{n}{t} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{phase}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{motion}

\PYG{k}{class} \PYG{n+nc}{Shoulder}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def} \PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{axis\PYGZus{}x}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{axis\PYGZus{}y}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{axis\PYGZus{}z}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{axis\PYGZus{}x}  \PYG{o}{=} \PYG{n}{Joint}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{axis\PYGZus{}y}  \PYG{o}{=} \PYG{n}{Joint}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{axis\PYGZus{}z}  \PYG{o}{=} \PYG{n}{Joint}\PYG{p}{(}\PYG{p}{)}
        \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{axis\PYGZus{}x}\PYG{p}{,} \PYG{n}{Joint}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{axis\PYGZus{}x} \PYG{o}{=} \PYG{n}{axis\PYGZus{}x}
        \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{axis\PYGZus{}y}\PYG{p}{,} \PYG{n}{Joint}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{axis\PYGZus{}y} \PYG{o}{=} \PYG{n}{axis\PYGZus{}y}
        \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{axis\PYGZus{}z}\PYG{p}{,} \PYG{n}{Joint}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{axis\PYGZus{}z} \PYG{o}{=} \PYG{n}{axis\PYGZus{}z}

\PYG{k}{class} \PYG{n+nc}{Elbow}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def} \PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{axis\PYGZus{}x}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{axis\PYGZus{}y}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{axis\PYGZus{}x}  \PYG{o}{=} \PYG{n}{Joint}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{axis\PYGZus{}y}  \PYG{o}{=} \PYG{n}{Joint}\PYG{p}{(}\PYG{p}{)}
        \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{axis\PYGZus{}x}\PYG{p}{,} \PYG{n}{Joint}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{axis\PYGZus{}x} \PYG{o}{=} \PYG{n}{axis\PYGZus{}x}
        \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{axis\PYGZus{}y}\PYG{p}{,} \PYG{n}{Joint}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{axis\PYGZus{}y} \PYG{o}{=} \PYG{n}{axis\PYGZus{}y}

\PYG{k}{class} \PYG{n+nc}{Wrist}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def} \PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{axis\PYGZus{}y}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{axis\PYGZus{}z}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{axis\PYGZus{}y}  \PYG{o}{=} \PYG{n}{Joint}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{axis\PYGZus{}z}  \PYG{o}{=} \PYG{n}{Joint}\PYG{p}{(}\PYG{p}{)}
        \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{axis\PYGZus{}y}\PYG{p}{,} \PYG{n}{Joint}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{axis\PYGZus{}y} \PYG{o}{=} \PYG{n}{axis\PYGZus{}y}
        \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{axis\PYGZus{}z}\PYG{p}{,} \PYG{n}{Joint}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{axis\PYGZus{}z} \PYG{o}{=} \PYG{n}{axis\PYGZus{}z}
\end{sphinxVerbatim}
\end{quote}


\subsection{The bird object}
\label{\detokenize{tutorial/bird_dynamics:the-bird-object}}
Once the kinematics is imposes, the object \sphinxstylestrong{bird} can be crated. This object is the input for the aerodynamic solver because it takes the kinematics of each joint, and exctracts the wing envelope and subsequently the lifting line at each time step.

The bird object takes as arguments the kinematics previously generated. The module is reported below.

\sphinxcode{\sphinxupquote{bird\_model.py}} \sphinxstylestrong{Show code}
\begin{quote}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\PYG{k+kn}{from} \PYG{n+nn}{.}\PYG{n+nn}{kinematics\PYGZus{}constructor} \PYG{k+kn}{import} \PYG{n}{Joint}\PYG{p}{,} \PYG{n}{Shoulder}\PYG{p}{,} \PYG{n}{Elbow}\PYG{p}{,} \PYG{n}{Wrist}
\PYG{k+kn}{from} \PYG{n+nn}{.}\PYG{n+nn}{line\PYGZus{}functions} \PYG{k+kn}{import} \PYG{n}{smooth\PYGZus{}line}\PYG{p}{,} \PYG{n}{smooth\PYGZus{}quarterline}\PYG{p}{,} \PYG{n}{quarterchord\PYGZus{}naive}\PYG{p}{,} \PYG{n}{improveline\PYGZus{}iteration}
\PYG{k+kn}{from} \PYG{n+nn}{.}\PYG{n+nn}{RotationMatrix} \PYG{k+kn}{import} \PYG{n}{RotationMatrix}
\PYG{k+kn}{from} \PYG{n+nn}{.}\PYG{n+nn}{CompMatrix} \PYG{k+kn}{import} \PYG{n}{CompMatrix}
\PYG{k+kn}{from} \PYG{n+nn}{.}\PYG{n+nn}{Plumes} \PYG{k+kn}{import} \PYG{n}{plumes}
\PYG{k+kn}{from} \PYG{n+nn}{collections} \PYG{k+kn}{import} \PYG{n}{namedtuple}
\PYG{k+kn}{from} \PYG{n+nn}{odes}\PYG{n+nn}{.}\PYG{n+nn}{bird\PYGZus{}dynamics} \PYG{k+kn}{import} \PYG{n}{dynamics}\PYG{p}{,} \PYG{n}{get\PYGZus{}aeroforces}\PYG{p}{,} \PYG{n}{get\PYGZus{}stability\PYGZus{}matrix}


\PYG{k}{class} \PYG{n+nc}{BirdModel}\PYG{p}{:}

    \PYG{k}{def} \PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{shoulder}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{elbow}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{wrist}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{)}\PYG{p}{:}

        \PYG{c+c1}{\PYGZsh{}Parameters:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{dimensions} \PYG{o}{=} \PYG{l+m+mi}{4}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{g} \PYG{o}{=} \PYG{l+m+mf}{9.81}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{mass} \PYG{o}{=} \PYG{l+m+mf}{1.2}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{frequency} \PYG{o}{=} \PYG{l+m+mi}{4}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{wingframe\PYGZus{}position} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.05}\PYG{p}{]}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{wingframe\PYGZus{}position\PYGZus{}tail} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.}\PYG{p}{,} \PYG{o}{.}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tail\PYGZus{}length} \PYG{o}{=} \PYG{l+m+mf}{0.25}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tail\PYGZus{}chord} \PYG{o}{=} \PYG{l+m+mf}{0.15}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{tail\PYGZus{}opening} \PYG{o}{=} \PYG{l+m+mf}{0.}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{shoulder} \PYG{o}{=} \PYG{n}{Shoulder}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{wrist} \PYG{o}{=} \PYG{n}{Wrist}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{elbow} \PYG{o}{=} \PYG{n}{Elbow}\PYG{p}{(}\PYG{p}{)}

        \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{shoulder}\PYG{p}{,} \PYG{n}{Shoulder}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{shoulder} \PYG{o}{=} \PYG{n}{shoulder}
        \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{wrist}\PYG{p}{,} \PYG{n}{Wrist}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{wrist} \PYG{o}{=} \PYG{n}{wrist}
        \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{elbow}\PYG{p}{,} \PYG{n}{Elbow}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{elbow} \PYG{o}{=} \PYG{n}{elbow}


    \PYG{k}{def} \PYG{n+nf}{get\PYGZus{}wingstate}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{t}\PYG{p}{)}\PYG{p}{:}

        \PYG{n}{state\PYGZus{}shoulder\PYGZus{}x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{shoulder}\PYG{o}{.}\PYG{n}{axis\PYGZus{}x}\PYG{o}{.}\PYG{n}{motion\PYGZus{}joint}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}
        \PYG{n}{state\PYGZus{}shoulder\PYGZus{}y} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{shoulder}\PYG{o}{.}\PYG{n}{axis\PYGZus{}y}\PYG{o}{.}\PYG{n}{motion\PYGZus{}joint}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}
        \PYG{n}{state\PYGZus{}shoulder\PYGZus{}z} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{shoulder}\PYG{o}{.}\PYG{n}{axis\PYGZus{}z}\PYG{o}{.}\PYG{n}{motion\PYGZus{}joint}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Elbow motion}
        \PYG{n}{state\PYGZus{}elbow\PYGZus{}x} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{elbow}\PYG{o}{.}\PYG{n}{axis\PYGZus{}x}\PYG{o}{.}\PYG{n}{motion\PYGZus{}joint}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}
        \PYG{n}{state\PYGZus{}elbow\PYGZus{}y} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{elbow}\PYG{o}{.}\PYG{n}{axis\PYGZus{}y}\PYG{o}{.}\PYG{n}{motion\PYGZus{}joint}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Wrist motion}
        \PYG{n}{state\PYGZus{}wrist\PYGZus{}y} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{wrist}\PYG{o}{.}\PYG{n}{axis\PYGZus{}y}\PYG{o}{.}\PYG{n}{motion\PYGZus{}joint}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}
        \PYG{n}{state\PYGZus{}wrist\PYGZus{}z} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{wrist}\PYG{o}{.}\PYG{n}{axis\PYGZus{}z}\PYG{o}{.}\PYG{n}{motion\PYGZus{}joint}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}

        \PYG{n}{wing\PYGZus{}state} \PYG{o}{=} \PYG{p}{[}\PYG{n}{state\PYGZus{}shoulder\PYGZus{}x}\PYG{p}{,} \PYG{n}{state\PYGZus{}shoulder\PYGZus{}z}\PYG{p}{,} \PYG{n}{state\PYGZus{}shoulder\PYGZus{}y}\PYG{p}{,} \PYG{n}{state\PYGZus{}elbow\PYGZus{}y}\PYG{p}{,} \PYG{n}{state\PYGZus{}elbow\PYGZus{}x}\PYG{p}{,} \PYG{n}{state\PYGZus{}wrist\PYGZus{}y}\PYG{p}{,} \PYG{n}{state\PYGZus{}wrist\PYGZus{}z}\PYG{p}{]}
        \PYG{c+c1}{\PYGZsh{}return ws}
        \PYG{k}{return} \PYG{n}{wing\PYGZus{}state}

    \PYG{k}{def} \PYG{n+nf}{get\PYGZus{}wingenvelope}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{wing\PYGZus{}state}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{shoulder\PYGZus{}x}\PYG{p}{,} \PYG{n}{shoulder\PYGZus{}z}\PYG{p}{,} \PYG{n}{shoulder\PYGZus{}y}\PYG{p}{,} \PYG{n}{elbow\PYGZus{}y}\PYG{p}{,} \PYG{n}{elbow\PYGZus{}x}\PYG{p}{,} \PYG{n}{wrist\PYGZus{}y}\PYG{p}{,} \PYG{n}{wrist\PYGZus{}z} \PYG{o}{=} \PYG{n}{wing\PYGZus{}state}
        \PYG{p}{[}\PYG{n}{plumesrot}\PYG{p}{,} \PYG{n}{plumesvec}\PYG{p}{]} \PYG{o}{=} \PYG{n}{plumes}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{dim\PYGZus{}plumesrot0} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{n}{plumesrot}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
        \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Assignment of the dimensions of the skeleton and the frame position}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}

        \PYG{c+c1}{\PYGZsh{} Versor along y axis}
        \PYG{n}{ey} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}

        \PYG{c+c1}{\PYGZsh{} Lenght of the first part of the wing skeleton}
        \PYG{n}{l1} \PYG{o}{=} \PYG{o}{.}\PYG{l+m+mi}{134}

        \PYG{c+c1}{\PYGZsh{} Lenght of the second part of the wing skeleton}
        \PYG{n}{l2} \PYG{o}{=} \PYG{o}{.}\PYG{l+m+mi}{162}

        \PYG{c+c1}{\PYGZsh{} Lenght of the second third of the wing skeleton (l3 is used to connect l1 and l2)}
        \PYG{n}{l4} \PYG{o}{=} \PYG{o}{.}\PYG{l+m+mi}{084}

        \PYG{c+c1}{\PYGZsh{} Origin of the reference frame}
        \PYG{n}{origin} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}

        \PYG{c+c1}{\PYGZsh{} Respective position of the end of the three parts of the skeleton}
        \PYG{n}{end1} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{l1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{end2} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{l2}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{end4} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{l4}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}

        \PYG{n}{vec30} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{end1}\PYG{p}{)} \PYG{o}{+} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{end2}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{origin}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} Probably unused}

        \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Assignment of the points over the three parts of the skeleton, arm, forearm, hand respoectively}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{} Number of points over the arm}
        \PYG{n}{npoints\PYGZus{}arm} \PYG{o}{=} \PYG{l+m+mi}{1}

        \PYG{c+c1}{\PYGZsh{} Number of points over the forearm}
        \PYG{n}{npoints\PYGZus{}forearm} \PYG{o}{=} \PYG{l+m+mi}{1}

        \PYG{c+c1}{\PYGZsh{} Number of points over the hand}
        \PYG{n}{npoints\PYGZus{}hand} \PYG{o}{=} \PYG{l+m+mi}{2}

        \PYG{c+c1}{\PYGZsh{} Total number of point}
        \PYG{n}{nslice} \PYG{o}{=} \PYG{n}{npoints\PYGZus{}arm} \PYG{o}{+} \PYG{n}{npoints\PYGZus{}forearm} \PYG{o}{+} \PYG{n}{npoints\PYGZus{}hand}

        \PYG{c+c1}{\PYGZsh{} Distances from point to point for each part of the skeleton}
        \PYG{n}{delta\PYGZus{}arm} \PYG{o}{=} \PYG{n}{l1}\PYG{o}{/}\PYG{n}{npoints\PYGZus{}arm}
        \PYG{n}{delta\PYGZus{}forearm} \PYG{o}{=} \PYG{n}{l2}\PYG{o}{/}\PYG{n}{npoints\PYGZus{}forearm}
        \PYG{n}{delta\PYGZus{}hand} \PYG{o}{=} \PYG{n}{l4}\PYG{o}{/}\PYG{p}{(}\PYG{n}{npoints\PYGZus{}hand}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}


        \PYG{c+c1}{\PYGZsh{} Routine for the xslice vector (values checked with Matlab code). Maybe write a function!}
        \PYG{n}{xslice} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{nslice}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{npoints\PYGZus{}arm}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{xslice}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{0} \PYG{o}{+} \PYG{p}{(}\PYG{n}{i}\PYG{o}{*}\PYG{n}{delta\PYGZus{}arm}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{npoints\PYGZus{}forearm}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{xslice}\PYG{p}{[}\PYG{n}{i} \PYG{o}{+} \PYG{n}{npoints\PYGZus{}arm}\PYG{p}{]} \PYG{o}{=} \PYG{n}{l1} \PYG{o}{+} \PYG{p}{(}\PYG{n}{i}\PYG{o}{*}\PYG{n}{delta\PYGZus{}forearm}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{npoints\PYGZus{}hand}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{xslice}\PYG{p}{[}\PYG{n}{i} \PYG{o}{+} \PYG{n}{npoints\PYGZus{}arm} \PYG{o}{+} \PYG{n}{npoints\PYGZus{}forearm}\PYG{p}{]} \PYG{o}{=} \PYG{n}{l1} \PYG{o}{+} \PYG{n}{l2} \PYG{o}{+} \PYG{p}{(}\PYG{n}{i}\PYG{o}{*}\PYG{n}{delta\PYGZus{}hand}\PYG{p}{)}

        \PYG{c+c1}{\PYGZsh{} Index of feathers starting point (ask it for a more clear comment). CHECKED!}
        \PYG{n}{index} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{l+m+mi}{7}\PYG{p}{)}
        \PYG{n}{index}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{n}{xslice}\PYG{p}{)}
        \PYG{n}{index}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{nonzero}\PYG{p}{(}\PYG{n}{xslice}\PYG{o}{\PYGZgt{}}\PYG{o}{=}\PYG{n}{l1}\PYG{o}{+}\PYG{n}{l2}\PYG{o}{+}\PYG{n}{l4}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        \PYG{n}{index}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{nonzero}\PYG{p}{(}\PYG{n}{xslice}\PYG{o}{\PYGZgt{}}\PYG{o}{=}\PYG{n}{l1}\PYG{o}{+}\PYG{n}{l2}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        \PYG{n}{index}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{nonzero}\PYG{p}{(}\PYG{n}{xslice}\PYG{o}{\PYGZgt{}}\PYG{o}{=}\PYG{n}{l1}\PYG{o}{+}\PYG{n}{l2}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        \PYG{n}{index}\PYG{p}{[}\PYG{l+m+mi}{4}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{nonzero}\PYG{p}{(}\PYG{n}{xslice}\PYG{o}{\PYGZgt{}}\PYG{o}{=}\PYG{n}{l1}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        \PYG{n}{index}\PYG{p}{[}\PYG{l+m+mi}{5}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{nonzero}\PYG{p}{(}\PYG{n}{xslice}\PYG{o}{\PYGZgt{}}\PYG{o}{=}\PYG{n}{l1}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        \PYG{n}{index}\PYG{p}{[}\PYG{l+m+mi}{6}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{1}
        \PYG{n}{number\PYGZus{}ellipses} \PYG{o}{=} \PYG{l+m+mi}{2}
        \PYG{n}{s} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{,}\PYG{n}{number\PYGZus{}ellipses} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{s} \PYG{o}{=} \PYG{n}{s}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{:}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{]}
        \PYG{n}{skz} \PYG{o}{=} \PYG{o}{.}\PYG{l+m+mi}{01}
        \PYG{n}{sky} \PYG{o}{=} \PYG{o}{.}\PYG{l+m+mi}{01}
        \PYG{n}{z} \PYG{o}{=} \PYG{n}{skz}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{s}\PYG{p}{)}
        \PYG{n}{y} \PYG{o}{=} \PYG{n}{sky}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{s}\PYG{p}{)}
        \PYG{n}{points} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{3} \PYG{p}{,} \PYG{n}{nslice}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{)}\PYG{p}{)}

        \PYG{n}{w1} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{nslice}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{)}
        \PYG{n}{w2a} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{nslice}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{)}
        \PYG{n}{w2b} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{nslice}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{)}
        \PYG{n}{w3} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{nslice}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{)}
        \PYG{n}{w4} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{nslice}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{nslice}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{xslice}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]} \PYG{o}{\PYGZlt{}} \PYG{n}{l1}\PYG{p}{:}
                \PYG{k}{for} \PYG{n}{k} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{)}\PYG{p}{:}
                    \PYG{n}{points}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{p}{(}\PYG{n}{j}\PYG{p}{)}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{o}{+}\PYG{n}{k}\PYG{p}{]} \PYG{o}{=} \PYG{p}{[}\PYG{n}{xslice}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{p}{,} \PYG{n}{y}\PYG{p}{[}\PYG{n}{k}\PYG{p}{]}\PYG{p}{,} \PYG{n}{z}\PYG{p}{[}\PYG{n}{k}\PYG{p}{]}\PYG{p}{]}

                \PYG{n}{facb} \PYG{o}{=} \PYG{p}{(}\PYG{n}{z}\PYG{o}{/}\PYG{n}{skz} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{/}\PYG{l+m+mi}{2}
                \PYG{n}{lrefcd} \PYG{o}{=} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{l1}\PYG{p}{,}\PYG{n}{l2}\PYG{p}{)}

                \PYG{k}{if} \PYG{n}{xslice}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]} \PYG{o}{\PYGZlt{}} \PYG{n}{l1}\PYG{o}{\PYGZhy{}}\PYG{n}{lrefcd}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{:}
                    \PYG{n}{faccd1} \PYG{o}{=} \PYG{l+m+mi}{1}
                \PYG{k}{else}\PYG{p}{:}
                    \PYG{n}{faccd1} \PYG{o}{=} \PYG{l+m+mf}{0.5}\PYG{o}{*}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{*}\PYG{p}{(}\PYG{n}{xslice}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{o}{\PYGZhy{}}\PYG{n}{l1}\PYG{p}{)}\PYG{o}{/}\PYG{n}{lrefcd}\PYG{p}{)}\PYG{p}{)}

                \PYG{n}{faccd2} \PYG{o}{=} \PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{faccd1}
                \PYG{n}{fac2a} \PYG{o}{=} \PYG{l+m+mi}{1}
                \PYG{n}{fac2b} \PYG{o}{=} \PYG{l+m+mi}{0}
                \PYG{n}{w1}\PYG{p}{[}\PYG{n}{j}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{:}\PYG{p}{(}\PYG{n}{j}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{]} \PYG{o}{=} \PYG{n}{facb}\PYG{o}{*}\PYG{n}{faccd1}
                \PYG{n}{w2a}\PYG{p}{[}\PYG{n}{j}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{:}\PYG{p}{(}\PYG{n}{j}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{]} \PYG{o}{=} \PYG{n}{facb}\PYG{o}{*}\PYG{n}{faccd2}\PYG{o}{*}\PYG{n}{fac2a}
                \PYG{n}{w2b}\PYG{p}{[}\PYG{n}{j}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{:}\PYG{p}{(}\PYG{n}{j}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{]} \PYG{o}{=} \PYG{n}{facb}\PYG{o}{*}\PYG{n}{faccd2}\PYG{o}{*}\PYG{n}{fac2b}
                \PYG{n}{w3}\PYG{p}{[}\PYG{n}{j}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{:}\PYG{p}{(}\PYG{n}{j}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{]} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{facb}\PYG{p}{)}
                \PYG{n}{w4}\PYG{p}{[}\PYG{n}{j}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{:}\PYG{p}{(}\PYG{n}{j}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{0}

            \PYG{k}{elif} \PYG{n}{xslice}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]} \PYG{o}{\PYGZlt{}} \PYG{n}{l1} \PYG{o}{+} \PYG{n}{l2}\PYG{p}{:}
                \PYG{k}{for} \PYG{n}{k} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{)}\PYG{p}{:}
                    \PYG{n}{points}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{p}{(}\PYG{n}{j}\PYG{p}{)}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{o}{+}\PYG{n}{k}\PYG{p}{]} \PYG{o}{=} \PYG{p}{[}\PYG{n}{xslice}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{p}{,} \PYG{n}{y}\PYG{p}{[}\PYG{n}{k}\PYG{p}{]}\PYG{p}{,} \PYG{n}{z}\PYG{p}{[}\PYG{n}{k}\PYG{p}{]}\PYG{p}{]}

                \PYG{n}{facb} \PYG{o}{=} \PYG{p}{(}\PYG{n}{z}\PYG{o}{/}\PYG{n}{skz} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{/}\PYG{l+m+mi}{2}
                \PYG{n}{lrefcd} \PYG{o}{=} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{l1}\PYG{p}{,}\PYG{n}{l2}\PYG{p}{)}
                \PYG{k}{if} \PYG{n}{xslice}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]} \PYG{o}{\PYGZlt{}} \PYG{n}{l1}\PYG{o}{+}\PYG{n}{lrefcd}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{:}
                    \PYG{n}{faccd2} \PYG{o}{=} \PYG{l+m+mf}{0.5}\PYG{o}{*}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{+}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{*}\PYG{p}{(}\PYG{n}{xslice}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{o}{\PYGZhy{}}\PYG{n}{l1}\PYG{p}{)}\PYG{o}{/}\PYG{n}{lrefcd}\PYG{p}{)}\PYG{p}{)}
                \PYG{k}{else}\PYG{p}{:}
                    \PYG{n}{faccd2} \PYG{o}{=} \PYG{l+m+mi}{1}

                \PYG{n}{faccd1} \PYG{o}{=} \PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{faccd2}
                \PYG{n}{fac2b} \PYG{o}{=} \PYG{p}{(}\PYG{n}{xslice}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{o}{\PYGZhy{}}\PYG{n}{l1}\PYG{p}{)}\PYG{o}{/}\PYG{n}{l2}
                \PYG{n}{fac2a} \PYG{o}{=} \PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{fac2b}
                \PYG{n}{lrefpg} \PYG{o}{=} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{l2}\PYG{p}{,}\PYG{n}{l4}\PYG{p}{)}

                \PYG{k}{if} \PYG{n}{xslice}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]} \PYG{o}{\PYGZlt{}} \PYG{n}{l1}\PYG{o}{+}\PYG{n}{l2}\PYG{o}{\PYGZhy{}}\PYG{n}{lrefpg}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{:}
                    \PYG{n}{facpg2} \PYG{o}{=} \PYG{l+m+mi}{1}
                \PYG{k}{else}\PYG{p}{:}
                    \PYG{n}{facpg2} \PYG{o}{=} \PYG{l+m+mf}{0.5}\PYG{o}{*}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{*}\PYG{p}{(}\PYG{n}{xslice}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{l1}\PYG{o}{+}\PYG{n}{l2}\PYG{p}{)}\PYG{p}{)}\PYG{o}{/}\PYG{n}{lrefpg}\PYG{p}{)}\PYG{p}{)}

                \PYG{n}{facpg4} \PYG{o}{=} \PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{facpg2}

                \PYG{n}{w1}\PYG{p}{[}\PYG{n}{j}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{:}\PYG{p}{(}\PYG{n}{j}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{]} \PYG{o}{=} \PYG{n}{facb}\PYG{o}{*}\PYG{n}{faccd1}\PYG{o}{*}\PYG{n}{facpg2}
                \PYG{n}{w2a}\PYG{p}{[}\PYG{n}{j}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{:}\PYG{p}{(}\PYG{n}{j}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{]} \PYG{o}{=} \PYG{n}{facb}\PYG{o}{*}\PYG{n}{faccd2}\PYG{o}{*}\PYG{n}{fac2a}\PYG{o}{*}\PYG{n}{facpg2}
                \PYG{n}{w2b}\PYG{p}{[}\PYG{n}{j}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{:}\PYG{p}{(}\PYG{n}{j}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{]} \PYG{o}{=} \PYG{n}{facb}\PYG{o}{*}\PYG{n}{faccd2}\PYG{o}{*}\PYG{n}{fac2b}\PYG{o}{*}\PYG{n}{facpg2}
                \PYG{n}{w3}\PYG{p}{[}\PYG{n}{j}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{:}\PYG{p}{(}\PYG{n}{j}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{]} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{facb}\PYG{p}{)}\PYG{o}{*}\PYG{n}{facpg2}
                \PYG{n}{w4}\PYG{p}{[}\PYG{n}{j}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{:}\PYG{p}{(}\PYG{n}{j}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{]} \PYG{o}{=} \PYG{n}{facpg4}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{k}{for} \PYG{n}{k} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{)}\PYG{p}{:}
                    \PYG{n}{points}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{p}{(}\PYG{n}{j}\PYG{p}{)}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{o}{+}\PYG{n}{k}\PYG{p}{]} \PYG{o}{=} \PYG{p}{[}\PYG{n}{xslice}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{p}{,} \PYG{n}{y}\PYG{p}{[}\PYG{n}{k}\PYG{p}{]}\PYG{p}{,} \PYG{n}{z}\PYG{p}{[}\PYG{n}{k}\PYG{p}{]}\PYG{p}{]}

                \PYG{n}{facb} \PYG{o}{=} \PYG{p}{(}\PYG{n}{z}\PYG{o}{/}\PYG{n}{skz} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{/}\PYG{l+m+mi}{2}
                \PYG{n}{fac2a} \PYG{o}{=} \PYG{l+m+mi}{0}
                \PYG{n}{fac2b} \PYG{o}{=} \PYG{l+m+mi}{1}
                \PYG{n}{lrefpg} \PYG{o}{=} \PYG{n+nb}{min}\PYG{p}{(}\PYG{n}{l2}\PYG{p}{,}\PYG{n}{l4}\PYG{p}{)}

                \PYG{k}{if} \PYG{n}{xslice}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]} \PYG{o}{\PYGZlt{}} \PYG{n}{l1}\PYG{o}{+}\PYG{n}{l2}\PYG{o}{+}\PYG{n}{lrefpg}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{:}
                    \PYG{n}{facpg4} \PYG{o}{=} \PYG{l+m+mf}{0.5}\PYG{o}{*}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{+}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{*}\PYG{p}{(}\PYG{n}{xslice}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{l1}\PYG{o}{+}\PYG{n}{l2}\PYG{p}{)}\PYG{p}{)}\PYG{o}{/}\PYG{n}{lrefpg}\PYG{p}{)}\PYG{p}{)}
                \PYG{k}{else}\PYG{p}{:}
                    \PYG{n}{facpg4} \PYG{o}{=} \PYG{l+m+mi}{1}

                \PYG{n}{facpg2} \PYG{o}{=} \PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{facpg4}

                \PYG{n}{w1}\PYG{p}{[}\PYG{n}{j}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{:}\PYG{p}{(}\PYG{n}{j}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{0}
                \PYG{n}{w2a}\PYG{p}{[}\PYG{n}{j}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{:}\PYG{p}{(}\PYG{n}{j}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{]} \PYG{o}{=} \PYG{n}{facb}\PYG{o}{*}\PYG{n}{facpg2}\PYG{o}{*}\PYG{n}{fac2a}
                \PYG{n}{w2b}\PYG{p}{[}\PYG{n}{j}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{:}\PYG{p}{(}\PYG{n}{j}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{]} \PYG{o}{=} \PYG{n}{facb}\PYG{o}{*}\PYG{n}{facpg2}\PYG{o}{*}\PYG{n}{fac2b}
                \PYG{n}{w3}\PYG{p}{[}\PYG{n}{j}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{:}\PYG{p}{(}\PYG{n}{j}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{]} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{facb}\PYG{p}{)}\PYG{o}{*}\PYG{n}{facpg2}
                \PYG{n}{w4}\PYG{p}{[}\PYG{n}{j}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{:}\PYG{p}{(}\PYG{n}{j}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{]} \PYG{o}{=} \PYG{n}{facpg4}



        \PYG{n}{npts} \PYG{o}{=} \PYG{n}{nslice}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}

        \PYG{n}{pts} \PYG{o}{=} \PYG{n}{points}

        \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Rotation routine for the three parts of the skeleton (shoulder, elbow, hand)}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{rot1X} \PYG{o}{=} \PYG{n}{RotationMatrix}\PYG{p}{(}\PYG{n}{shoulder\PYGZus{}x}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{rot1Z} \PYG{o}{=} \PYG{n}{RotationMatrix}\PYG{p}{(}\PYG{n}{shoulder\PYGZus{}z}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{z}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{rot1Y} \PYG{o}{=} \PYG{n}{RotationMatrix}\PYG{p}{(}\PYG{n}{shoulder\PYGZus{}y}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{rot1} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{rot1X}\PYG{p}{)}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{rot1Z}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{rot1Y}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{ey1} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{rot1}\PYG{p}{)}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{ey}\PYG{p}{)}\PYG{p}{)}

        \PYG{n}{rot2relY} \PYG{o}{=} \PYG{n}{RotationMatrix}\PYG{p}{(}\PYG{n}{elbow\PYGZus{}y}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{rot2relX} \PYG{o}{=} \PYG{n}{RotationMatrix}\PYG{p}{(}\PYG{n}{elbow\PYGZus{}x}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{rot2b} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{rot1}\PYG{p}{)}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{rot2relY}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{rot2relX}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{rot2a} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{rot1}\PYG{p}{)}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{rot2relY}\PYG{p}{)}\PYG{p}{)}

        \PYG{n}{rot4relY} \PYG{o}{=} \PYG{n}{RotationMatrix}\PYG{p}{(}\PYG{n}{wrist\PYGZus{}y}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{rot4relZ} \PYG{o}{=} \PYG{n}{RotationMatrix}\PYG{p}{(}\PYG{n}{wrist\PYGZus{}z}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{z}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{rot4} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{rot2b}\PYG{p}{)}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{rot4relY}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{rot4relZ}\PYG{p}{)}\PYG{p}{)}


        \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Evaluation of the bones position}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{endd1} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{rot1}\PYG{p}{)}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{end1}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{endd2} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{rot2a}\PYG{p}{)}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{end2}\PYG{p}{)}\PYG{p}{)}\PYG{o}{+}\PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{endd1}\PYG{p}{)}
        \PYG{n}{endd4} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{rot4}\PYG{p}{)}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{end4}\PYG{p}{)}\PYG{p}{)}\PYG{o}{+}\PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{endd2}\PYG{p}{)}
        \PYG{n}{vec3} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{endd2}\PYG{p}{)}\PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{origin}\PYG{p}{)}

        \PYG{n}{ex3} \PYG{o}{=} \PYG{n}{vec3}\PYG{o}{/}\PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{vec3}\PYG{p}{)}
        \PYG{n}{ey3} \PYG{o}{=} \PYG{n}{ey1}
        \PYG{n}{ez3} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{ex3}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{*}\PYG{n}{ey3}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{\PYGZhy{}}\PYG{n}{ex3}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{*}\PYG{n}{ey3}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{ex3}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{*}\PYG{n}{ey3}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{\PYGZhy{}}\PYG{n}{ex3}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{*}\PYG{n}{ey3}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{n}{ex3}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{*}\PYG{n}{ey3}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{\PYGZhy{}}\PYG{n}{ex3}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{*}\PYG{n}{ey3}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{rot3} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{ex3}\PYG{p}{,}\PYG{n}{ey3}\PYG{p}{,}\PYG{n}{ez3}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{rot3} \PYG{o}{=} \PYG{n}{rot3}\PYG{o}{.}\PYG{n}{transpose}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{kx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{vec3}\PYG{p}{)}\PYG{o}{/}\PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{vec30}\PYG{p}{)}
        \PYG{n}{comp3} \PYG{o}{=} \PYG{n}{CompMatrix}\PYG{p}{(}\PYG{n}{kx}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}


        \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Routine to find skin points}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}

        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{npts}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{pt} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{points}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{j}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{pt1} \PYG{o}{=} \PYG{n}{rot1}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{pt}\PYG{p}{)}
            \PYG{n}{pt2a} \PYG{o}{=} \PYG{n}{rot2a}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{p}{(}\PYG{n}{pt}\PYG{o}{\PYGZhy{}}\PYG{n}{end1}\PYG{p}{)}\PYG{p}{)} \PYG{o}{+} \PYG{n}{endd1}
            \PYG{n}{pt2b} \PYG{o}{=} \PYG{n}{rot2b}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{p}{(}\PYG{n}{pt}\PYG{o}{\PYGZhy{}}\PYG{n}{end1}\PYG{p}{)}\PYG{p}{)} \PYG{o}{+} \PYG{n}{endd1}
            \PYG{n}{pt3} \PYG{o}{=} \PYG{n}{rot3}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{comp3}\PYG{p}{)}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{pt}\PYG{p}{)}
            \PYG{n}{pt4} \PYG{o}{=} \PYG{n}{rot4}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{p}{(}\PYG{n}{pt}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{end1}\PYG{o}{+}\PYG{n}{end2}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)} \PYG{o}{+} \PYG{n}{endd2}

            \PYG{n}{pts}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{n}{pt1}\PYG{o}{*}\PYG{n}{w1}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]} \PYG{o}{+} \PYG{n}{pt2a}\PYG{o}{*}\PYG{n}{w2a}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]} \PYG{o}{+} \PYG{n}{pt2b}\PYG{o}{*}\PYG{n}{w2b}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]} \PYG{o}{+} \PYG{n}{pt3}\PYG{o}{*}\PYG{n}{w3}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]} \PYG{o}{+} \PYG{n}{pt4}\PYG{o}{*}\PYG{n}{w4}\PYG{p}{[}\PYG{n}{j}\PYG{p}{]}

        \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Routine to find main feathers}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{vecpss} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,}\PYG{n}{dim\PYGZus{}plumesrot0}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{startp} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{n}{plumesrot}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}

        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{n}{plumesrot}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{i} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
                \PYG{n}{prerot} \PYG{o}{=} \PYG{n}{rot4}
            \PYG{k}{elif} \PYG{n}{i} \PYG{o}{==} \PYG{l+m+mi}{1}\PYG{p}{:}
                \PYG{n}{prerot} \PYG{o}{=} \PYG{n}{rot4}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{RotationMatrix}\PYG{p}{(}\PYG{n}{wrist\PYGZus{}z}\PYG{o}{/}\PYG{l+m+mi}{4}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
            \PYG{k}{elif} \PYG{n}{i} \PYG{o}{==} \PYG{l+m+mi}{2}\PYG{p}{:}
                \PYG{n}{prerot} \PYG{o}{=} \PYG{n}{rot2b}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{RotationMatrix}\PYG{p}{(}\PYG{n}{wrist\PYGZus{}y}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{RotationMatrix}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{wrist\PYGZus{}z}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
            \PYG{k}{elif} \PYG{n}{i} \PYG{o}{==} \PYG{l+m+mi}{3}\PYG{p}{:}
                \PYG{n}{prerot} \PYG{o}{=} \PYG{n}{rot2a}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{RotationMatrix}\PYG{p}{(}\PYG{n}{elbow\PYGZus{}x}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{RotationMatrix}\PYG{p}{(}\PYG{n}{wrist\PYGZus{}y}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{RotationMatrix}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{wrist\PYGZus{}z}\PYG{o}{/}\PYG{l+m+mi}{4}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
            \PYG{k}{elif} \PYG{n}{i} \PYG{o}{==} \PYG{l+m+mi}{4}\PYG{p}{:}
                \PYG{n}{prerot} \PYG{o}{=} \PYG{n}{rot1}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{RotationMatrix}\PYG{p}{(}\PYG{n}{elbow\PYGZus{}y}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
            \PYG{k}{elif} \PYG{n}{i} \PYG{o}{==} \PYG{l+m+mi}{5}\PYG{p}{:}
                \PYG{n}{prerot} \PYG{o}{=} \PYG{n}{rot1}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{RotationMatrix}\PYG{p}{(}\PYG{n}{elbow\PYGZus{}y}\PYG{o}{/}\PYG{l+m+mi}{4}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
            \PYG{k}{elif} \PYG{n}{i} \PYG{o}{==} \PYG{l+m+mi}{6}\PYG{p}{:}
                \PYG{n}{prerot} \PYG{o}{=} \PYG{n}{rot1}

            \PYG{n}{rY} \PYG{o}{=} \PYG{n}{RotationMatrix}\PYG{p}{(}\PYG{n}{plumesrot}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{n}{i}\PYG{p}{]}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{n}{rX} \PYG{o}{=} \PYG{n}{RotationMatrix}\PYG{p}{(}\PYG{n}{plumesrot}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{n}{i}\PYG{p}{]}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{n}{rot} \PYG{o}{=} \PYG{n}{prerot}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{rY}\PYG{p}{)}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{rX}\PYG{p}{)}
            \PYG{n}{vecpss}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{rot}\PYG{p}{,}\PYG{n}{plumesvec}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{element} \PYG{o}{=} \PYG{n}{index}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
            \PYG{n}{column} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{p}{(}\PYG{n}{index}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{*}\PYG{p}{(}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{startp}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{pts}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{[}\PYG{n}{column}\PYG{p}{]}
            \PYG{n}{startp}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{pts}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{[}\PYG{n}{column}\PYG{p}{]}
            \PYG{n}{startp}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{pts}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{[}\PYG{n}{column}\PYG{p}{]}

        \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Interpolation Routine}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{main1} \PYG{o}{=} \PYG{p}{(}\PYG{p}{(}\PYG{n}{xslice}\PYG{p}{[}\PYG{n}{xslice} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n}{l1}\PYG{o}{+}\PYG{n}{l2}\PYG{o}{+}\PYG{n}{l4}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{l1}\PYG{o}{+}\PYG{n}{l2}\PYG{o}{+}\PYG{n}{l4}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}\PYG{o}{/}\PYG{p}{(}\PYG{n}{l4}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{main1} \PYG{o}{=} \PYG{n}{main1}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{newaxis}\PYG{p}{]}\PYG{o}{.}\PYG{n}{T}
        \PYG{n}{main2} \PYG{o}{=} \PYG{p}{(}\PYG{p}{(}\PYG{n}{xslice}\PYG{p}{[}\PYG{p}{(}\PYG{n}{xslice} \PYG{o}{\PYGZgt{}}\PYG{o}{=} \PYG{n}{l1}\PYG{o}{+}\PYG{n}{l2}\PYG{p}{)} \PYG{o}{\PYGZam{}} \PYG{p}{(}\PYG{n}{xslice} \PYG{o}{\PYGZlt{}} \PYG{n}{l1}\PYG{o}{+}\PYG{n}{l2}\PYG{o}{+}\PYG{n}{l4}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{]}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{l1}\PYG{o}{+}\PYG{n}{l2}\PYG{p}{)}\PYG{p}{)}\PYG{o}{/}\PYG{p}{(}\PYG{n}{l4}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{main2} \PYG{o}{=} \PYG{n}{main2}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{newaxis}\PYG{p}{]}\PYG{o}{.}\PYG{n}{T}
        \PYG{n}{abras1} \PYG{o}{=} \PYG{p}{(}\PYG{p}{(}\PYG{n}{xslice}\PYG{p}{[}\PYG{p}{(}\PYG{n}{xslice} \PYG{o}{\PYGZgt{}}\PYG{o}{=}\PYG{n}{l1}\PYG{o}{+}\PYG{n}{l2}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)} \PYG{o}{\PYGZam{}} \PYG{p}{(}\PYG{n}{xslice} \PYG{o}{\PYGZlt{}}\PYG{n}{l1}\PYG{o}{+}\PYG{n}{l2}\PYG{p}{)}\PYG{p}{]}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{l1}\PYG{o}{+}\PYG{n}{l2}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}\PYG{o}{/}\PYG{p}{(}\PYG{n}{l2}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{abras1} \PYG{o}{=} \PYG{n}{abras1}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{newaxis}\PYG{p}{]}\PYG{o}{.}\PYG{n}{T}
        \PYG{n}{abras2} \PYG{o}{=} \PYG{p}{(}\PYG{p}{(}\PYG{n}{xslice}\PYG{p}{[}\PYG{p}{(}\PYG{n}{xslice} \PYG{o}{\PYGZgt{}}\PYG{o}{=}\PYG{n}{l1}\PYG{p}{)} \PYG{o}{\PYGZam{}} \PYG{p}{(}\PYG{n}{xslice} \PYG{o}{\PYGZlt{}}\PYG{n}{l1}\PYG{o}{+}\PYG{n}{l2}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{]}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{l1}\PYG{p}{)}\PYG{p}{)}\PYG{o}{/}\PYG{p}{(}\PYG{n}{l2}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{abras2} \PYG{o}{=} \PYG{n}{abras2}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{newaxis}\PYG{p}{]}\PYG{o}{.}\PYG{n}{T}
        \PYG{n}{bras1} \PYG{o}{=} \PYG{p}{(}\PYG{p}{(}\PYG{n}{xslice}\PYG{p}{[}\PYG{p}{(}\PYG{n}{xslice} \PYG{o}{\PYGZgt{}}\PYG{o}{=}\PYG{n}{l1}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)} \PYG{o}{\PYGZam{}} \PYG{p}{(}\PYG{n}{xslice} \PYG{o}{\PYGZlt{}}\PYG{n}{l1}\PYG{p}{)}\PYG{p}{]}\PYG{o}{\PYGZhy{}}\PYG{p}{(}\PYG{n}{l1}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}\PYG{o}{/}\PYG{p}{(}\PYG{n}{l1}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{bras1} \PYG{o}{=} \PYG{n}{bras1}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{newaxis}\PYG{p}{]}\PYG{o}{.}\PYG{n}{T}
        \PYG{n}{bras2} \PYG{o}{=} \PYG{p}{(}\PYG{n}{xslice}\PYG{p}{[}\PYG{n}{xslice} \PYG{o}{\PYGZlt{}}\PYG{n}{l1}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{/}\PYG{p}{(}\PYG{n}{l1}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{bras2} \PYG{o}{=} \PYG{n}{bras2}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{newaxis}\PYG{p}{]}\PYG{o}{.}\PYG{n}{T}

        \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Feathers Routine}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{pm1} \PYG{o}{=} \PYG{n}{vecpss}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{newaxis}\PYG{p}{]}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{main1}\PYG{p}{)}\PYG{o}{+}\PYG{n}{vecpss}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{newaxis}\PYG{p}{]}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{main1}\PYG{p}{)}
        \PYG{n}{pm2} \PYG{o}{=} \PYG{n}{vecpss}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{newaxis}\PYG{p}{]}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{main2}\PYG{p}{)}\PYG{o}{+}\PYG{n}{vecpss}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{newaxis}\PYG{p}{]}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{main2}\PYG{p}{)}
        \PYG{n}{pa1} \PYG{o}{=} \PYG{n}{vecpss}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{newaxis}\PYG{p}{]}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{abras1}\PYG{p}{)}\PYG{o}{+}\PYG{n}{vecpss}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{newaxis}\PYG{p}{]}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{abras1}\PYG{p}{)}
        \PYG{n}{pa2} \PYG{o}{=} \PYG{n}{vecpss}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{newaxis}\PYG{p}{]}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{abras2}\PYG{p}{)}\PYG{o}{+}\PYG{n}{vecpss}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{4}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{newaxis}\PYG{p}{]}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{abras2}\PYG{p}{)}
        \PYG{n}{pb1} \PYG{o}{=} \PYG{n}{vecpss}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{4}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{newaxis}\PYG{p}{]}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{bras1}\PYG{p}{)}\PYG{o}{+}\PYG{n}{vecpss}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{5}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{newaxis}\PYG{p}{]}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{bras1}\PYG{p}{)}
        \PYG{n}{pb2} \PYG{o}{=} \PYG{n}{vecpss}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{5}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{newaxis}\PYG{p}{]}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{n}{bras2}\PYG{p}{)}\PYG{o}{+}\PYG{n}{vecpss}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{6}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{newaxis}\PYG{p}{]}\PYG{o}{.}\PYG{n}{dot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{bras2}\PYG{p}{)}

        \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Store the feathers in a single vector following the structure:}

\PYG{l+s+sd}{                [pb2(0,0),..,pb2(0,n),pb1(0,0),..,pb1(0,n),pa2(0,0),..,pa2(0,k),pa1(0,0),..,pa1(0,k),pm2(0,0),..,pm2(0,j),pm1(0,0),..,pm1(0,j)]}
\PYG{l+s+sd}{        vecps = [pb2(1,0),..,pb2(1,n),pb1(1,0),..,pb1(1,n),pa2(1,0),..,pa2(1,k),pa1(1,0),..,pa1(1,k),pm2(1,0),..,pm2(1,j),pm1(1,0),..,pm1(1,j)]}
\PYG{l+s+sd}{                [pb2(2,0),..,pb2(2,n),pb1(2,0),..,pb1(2,n),pa2(2,0),..,pa2(2,k),pa1(2,0),..,pa1(2,k),pm2(2,0),..,pm2(2,j),pm1(2,0),..,pm1(2,j)]}

\PYG{l+s+sd}{        Matrix concatenation}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{vecps} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{c\PYGZus{}}\PYG{p}{[}\PYG{n}{pb2}\PYG{p}{,} \PYG{n}{pb1}\PYG{p}{,} \PYG{n}{pa2}\PYG{p}{,} \PYG{n}{pa1}\PYG{p}{,} \PYG{n}{pm2}\PYG{p}{,} \PYG{n}{pm1}\PYG{p}{]}


        \PYG{n}{trailingedge} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,}\PYG{n}{nslice}\PYG{p}{)}\PYG{p}{)}

        \PYG{n}{xpt} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{)}
        \PYG{n}{ypt} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{)}
        \PYG{n}{zpt} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{)}

        \PYG{k}{for} \PYG{n}{j} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{nslice}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{xpt} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{pts}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{p}{(}\PYG{n}{j}\PYG{p}{)}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{]}\PYG{p}{,} \PYG{n}{pts}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{n}{j}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{pts}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{p}{(}\PYG{n}{j}\PYG{p}{)}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{ypt} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{pts}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{p}{(}\PYG{n}{j}\PYG{p}{)}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{]}\PYG{p}{,} \PYG{n}{pts}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{n}{j}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{pts}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{p}{(}\PYG{n}{j}\PYG{p}{)}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{zpt} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{pts}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{p}{(}\PYG{n}{j}\PYG{p}{)}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{]}\PYG{p}{,} \PYG{n}{pts}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{n}{j}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{pts}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{p}{(}\PYG{n}{j}\PYG{p}{)}\PYG{o}{*}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}

            \PYG{n}{vecp} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{vecps}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{j}\PYG{p}{]}\PYG{p}{)}

            \PYG{n}{trailingedge}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{n}{xpt}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{+}\PYG{n}{vecp}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
            \PYG{n}{trailingedge}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{n}{ypt}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{+}\PYG{n}{vecp}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}
            \PYG{n}{trailingedge}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{n}{j}\PYG{p}{]} \PYG{o}{=} \PYG{n}{zpt}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{+}\PYG{n}{vecp}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}

        \PYG{n}{leadingedge} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{c\PYGZus{}}\PYG{p}{[}\PYG{n}{pts}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{number\PYGZus{}ellipses}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{:}\PYG{p}{:}\PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{number\PYGZus{}ellipses}\PYG{p}{)}\PYG{p}{]}\PYG{p}{,}\PYG{n}{trailingedge}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{]}
        \PYG{k}{return} \PYG{n}{leadingedge}\PYG{p}{,} \PYG{n}{trailingedge}
    \PYG{k}{def} \PYG{n+nf}{get\PYGZus{}liftingline}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{leadingedge}\PYG{p}{,} \PYG{n}{trailingedge}\PYG{p}{)}\PYG{p}{:}
        \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        === Call of wing\PYGZus{}envelope function. Given the kinematics, the wing shape is found ===}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}

        \PYG{n}{nlete} \PYG{o}{=} \PYG{l+m+mi}{16}

        \PYG{n}{leadingedge} \PYG{o}{=} \PYG{n}{smooth\PYGZus{}line}\PYG{p}{(}\PYG{n}{leadingedge}\PYG{p}{,} \PYG{n}{nlete}\PYG{p}{)}
        \PYG{n}{trailingedge} \PYG{o}{=} \PYG{n}{smooth\PYGZus{}line}\PYG{p}{(}\PYG{n}{trailingedge}\PYG{p}{,} \PYG{n}{nlete}\PYG{p}{)}

        \PYG{p}{[}\PYG{n}{line}\PYG{p}{,} \PYG{n}{chord\PYGZus{}leadingedge}\PYG{p}{,} \PYG{n}{chord\PYGZus{}trailingedge}\PYG{p}{]} \PYG{o}{=} \PYG{n}{quarterchord\PYGZus{}naive}\PYG{p}{(}\PYG{n}{leadingedge}\PYG{p}{,} \PYG{n}{trailingedge}\PYG{p}{)}

        \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        ============= PLOT ROUTINE =============}
\PYG{l+s+sd}{        Here in the original code there is a function that prints out on the screen wing plots.}
\PYG{l+s+sd}{        It is now omitted, and there will be implemented later in a second time}
\PYG{l+s+sd}{        ========================================}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}

        \PYG{n}{tol} \PYG{o}{=} \PYG{l+m+mf}{0.1}
        \PYG{n}{nmax} \PYG{o}{=} \PYG{l+m+mi}{10}
        \PYG{n}{a} \PYG{o}{=} \PYG{n}{tol} \PYG{o}{+} \PYG{l+m+mi}{1}
        \PYG{n}{chg} \PYG{o}{=} \PYG{n}{tol} \PYG{o}{+} \PYG{l+m+mi}{1}
        \PYG{n}{it} \PYG{o}{=} \PYG{l+m+mi}{1}

        \PYG{k}{while} \PYG{n}{a} \PYG{o}{\PYGZgt{}} \PYG{n}{tol} \PYG{o+ow}{and} \PYG{n}{it} \PYG{o}{\PYGZlt{}} \PYG{n}{nmax}\PYG{p}{:}
            \PYG{p}{[}\PYG{n}{line}\PYG{p}{,} \PYG{n}{chord\PYGZus{}leadingedge}\PYG{p}{,} \PYG{n}{chord\PYGZus{}trailingedge}\PYG{p}{,} \PYG{n}{a}\PYG{p}{]} \PYG{o}{=} \PYG{n}{improveline\PYGZus{}iteration}\PYG{p}{(}\PYG{n}{line}\PYG{p}{,}\PYG{n}{chord\PYGZus{}leadingedge}\PYG{p}{,}
                                                            \PYG{n}{chord\PYGZus{}trailingedge}\PYG{p}{,}\PYG{n}{leadingedge}\PYG{p}{,}\PYG{n}{trailingedge}\PYG{p}{,}\PYG{n}{it}\PYG{p}{)}

            \PYG{n}{chg} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{c\PYGZus{}}\PYG{p}{[}\PYG{n}{chg}\PYG{p}{,} \PYG{n}{a}\PYG{p}{]}

            \PYG{n}{it} \PYG{o}{=} \PYG{n}{it} \PYG{o}{+} \PYG{l+m+mi}{1}

        \PYG{p}{[}\PYG{n}{lifting\PYGZus{}line}\PYG{p}{,} \PYG{n}{chord\PYGZus{}leadingedge}\PYG{p}{,} \PYG{n}{chord\PYGZus{}trailingedge}\PYG{p}{]} \PYG{o}{=} \PYG{n}{smooth\PYGZus{}quarterline}\PYG{p}{(}\PYG{n}{line}\PYG{p}{,} \PYG{n}{chord\PYGZus{}leadingedge}\PYG{p}{,} \PYG{n}{chord\PYGZus{}trailingedge}\PYG{p}{)}

        \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Output lifting\PYGZus{}line, chord\PYGZus{}leadingedge, chord\PYGZus{}trailingedge CHECKED}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{line\PYGZus{}dummy} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{n}{lifting\PYGZus{}line}\PYG{p}{)}
        \PYG{n}{nl} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{n}{line}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{chord\PYGZus{}direction} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,}\PYG{n}{nl}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{updir} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,}\PYG{n}{nl}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{chord} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{n}{nl}\PYG{p}{)}\PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{} =============================================================================}
    \PYG{c+c1}{\PYGZsh{}     Evaluating the chord and its direction}
    \PYG{c+c1}{\PYGZsh{}     For every slice, it\PYGZsq{}s calculated the distance btw Lead. edge and Trail.}
    \PYG{c+c1}{\PYGZsh{}     edge (chord\PYGZus{}distance), and then the modulus, so that the versor is}
    \PYG{c+c1}{\PYGZsh{}     identified.}
    \PYG{c+c1}{\PYGZsh{} =============================================================================}

        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{nl}\PYG{p}{)}\PYG{p}{:}

            \PYG{n}{chord\PYGZus{}distance} \PYG{o}{=} \PYG{p}{(}\PYG{n}{chord\PYGZus{}trailingedge}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{i}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{chord\PYGZus{}leadingedge}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mf}{1e\PYGZhy{}20}
            \PYG{n}{chord}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{chord\PYGZus{}distance}\PYG{p}{)}
            \PYG{c+c1}{\PYGZsh{}chord = chord[:,np.newaxis]}
            \PYG{n}{chord\PYGZus{}direction}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{chord\PYGZus{}distance}\PYG{o}{/}\PYG{n}{chord}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}

            \PYG{k}{if} \PYG{n}{i} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
                \PYG{n}{linevec} \PYG{o}{=} \PYG{n}{line}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{line}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{]}
            \PYG{k}{elif} \PYG{n}{i} \PYG{o}{==} \PYG{p}{(}\PYG{n}{nl} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{linevec} \PYG{o}{=} \PYG{n}{line}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{line}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{2}\PYG{p}{]}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{n}{linevec} \PYG{o}{=} \PYG{n}{line}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{line}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}

            \PYG{n}{linevec} \PYG{o}{=} \PYG{n}{linevec}\PYG{o}{/}\PYG{n}{np}\PYG{o}{.}\PYG{n}{linalg}\PYG{o}{.}\PYG{n}{norm}\PYG{p}{(}\PYG{n}{linevec}\PYG{p}{)}
            \PYG{n}{updir}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{cross}\PYG{p}{(}\PYG{n}{chord\PYGZus{}direction}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{linevec}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Different value in the last iteration}

        \PYG{n}{updir\PYGZus{}dummy} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{n}{updir}\PYG{p}{)}
        \PYG{n}{chord\PYGZus{}direction\PYGZus{}dummy} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{n}{chord\PYGZus{}direction}\PYG{p}{)}
        \PYG{n}{chord\PYGZus{}dummy} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{n}{chord}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Left Wing}

        \PYG{n}{line\PYGZus{}left} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{fliplr}\PYG{p}{(}\PYG{n}{line\PYGZus{}dummy}\PYG{p}{)}
        \PYG{n}{up\PYGZus{}direction\PYGZus{}left} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{fliplr}\PYG{p}{(}\PYG{n}{updir\PYGZus{}dummy}\PYG{p}{)}
        \PYG{n}{chord\PYGZus{}direction\PYGZus{}left} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{fliplr}\PYG{p}{(}\PYG{n}{chord\PYGZus{}direction\PYGZus{}dummy}\PYG{p}{)}
        \PYG{n}{chord\PYGZus{}left} \PYG{o}{=} \PYG{n}{chord\PYGZus{}dummy}\PYG{p}{[}\PYG{p}{:}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}

        \PYG{n}{line\PYGZus{}left}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{negative}\PYG{p}{(}\PYG{n}{line\PYGZus{}left}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{p}{:}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{chord\PYGZus{}direction\PYGZus{}left}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{negative}\PYG{p}{(}\PYG{n}{chord\PYGZus{}direction\PYGZus{}left}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{p}{:}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{up\PYGZus{}direction\PYGZus{}left}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{negative}\PYG{p}{(}\PYG{n}{up\PYGZus{}direction\PYGZus{}left}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{p}{:}\PYG{p}{]}\PYG{p}{)}

        \PYG{n}{sumvector} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{n}{nl}\PYG{p}{)}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{nl}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{i} \PYG{o}{\PYGZlt{}} \PYG{n}{nl}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{:}
                \PYG{n}{sumvector}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{p}{(}\PYG{n}{lifting\PYGZus{}line}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{lifting\PYGZus{}line}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{n}{i}\PYG{p}{]}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{n}{sumvector}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{p}{(}\PYG{n}{lifting\PYGZus{}line}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{lifting\PYGZus{}line}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{)}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}


        \PYG{n}{dx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{mean}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n}{sumvector}\PYG{p}{)}\PYG{p}{)}

        \PYG{k}{return} \PYG{n}{lifting\PYGZus{}line}\PYG{p}{,} \PYG{n}{updir}\PYG{p}{,} \PYG{n}{chord\PYGZus{}direction}\PYG{p}{,} \PYG{n}{chord}\PYG{p}{,} \PYG{n}{line\PYGZus{}left}\PYG{p}{,} \PYG{n}{up\PYGZus{}direction\PYGZus{}left}\PYG{p}{,} \PYG{n}{chord\PYGZus{}direction\PYGZus{}left}\PYG{p}{,} \PYG{n}{chord\PYGZus{}left}\PYG{p}{,} \PYG{n}{dx}



    \PYG{k}{def} \PYG{n+nf}{merge\PYGZus{}lines}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{line\PYGZus{}package}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{line\PYGZus{}r}\PYG{p}{,}\PYG{n}{updir\PYGZus{}r}\PYG{p}{,}\PYG{n}{chordir\PYGZus{}r}\PYG{p}{,}\PYG{n}{chord\PYGZus{}r}\PYG{p}{,}\PYG{n}{line\PYGZus{}l}\PYG{p}{,}\PYG{n}{updir\PYGZus{}l}\PYG{p}{,}\PYG{n}{chordir\PYGZus{}l}\PYG{p}{,}\PYG{n}{chord\PYGZus{}l}\PYG{p}{,} \PYG{n}{dx} \PYG{o}{=} \PYG{n}{line\PYGZus{}package}
        \PYG{n}{x\PYGZus{}ep} \PYG{o}{=} \PYG{l+m+mf}{0.05}
        \PYG{n}{nmid} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{ceil}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{x\PYGZus{}ep}\PYG{o}{/}\PYG{n}{dx}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{line\PYGZus{}r}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{n}{line\PYGZus{}r}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{p}{:}\PYG{p}{]} \PYG{o}{+} \PYG{n}{x\PYGZus{}ep}
        \PYG{n}{line\PYGZus{}l}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{n}{line\PYGZus{}l}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{p}{:}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{x\PYGZus{}ep}

        \PYG{n}{xmid} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{n}{line\PYGZus{}l}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,}\PYG{n}{line\PYGZus{}r}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}\PYG{n}{nmid}\PYG{p}{)}
        \PYG{n}{length\PYGZus{}xmid} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{n}{xmid}\PYG{p}{)}
        \PYG{n}{line\PYGZus{}mid} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{xmid}\PYG{p}{,} \PYG{n}{line\PYGZus{}r}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{ones}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{n}{xmid}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{n}{line\PYGZus{}r}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{ones}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{n}{xmid}\PYG{p}{)}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{chordir\PYGZus{}mid} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{chordir\PYGZus{}r}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{n}{xmid}\PYG{p}{)}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}\PYG{o}{.}\PYG{n}{T}
        \PYG{n}{updir\PYGZus{}mid} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{updir\PYGZus{}r}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{size}\PYG{p}{(}\PYG{n}{xmid}\PYG{p}{)}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}\PYG{o}{.}\PYG{n}{T}
        \PYG{n}{chord\PYGZus{}mid} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros}\PYG{p}{(}\PYG{n}{length\PYGZus{}xmid}\PYG{p}{)}
        \PYG{n}{chord\PYGZus{}mid}\PYG{p}{[}\PYG{p}{:}\PYG{p}{]} \PYG{o}{=} \PYG{n}{chord\PYGZus{}r}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{ones}\PYG{p}{(}\PYG{n}{length\PYGZus{}xmid}\PYG{p}{)}

        \PYG{n}{line} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{c\PYGZus{}}\PYG{p}{[}\PYG{n}{line\PYGZus{}l}\PYG{p}{,}\PYG{n}{line\PYGZus{}mid}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,}\PYG{n}{line\PYGZus{}r}\PYG{p}{]}
        \PYG{n}{chordir} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{c\PYGZus{}}\PYG{p}{[}\PYG{n}{chordir\PYGZus{}l}\PYG{p}{,} \PYG{n}{chordir\PYGZus{}mid}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{chordir\PYGZus{}r}\PYG{p}{]}
        \PYG{n}{updir} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{c\PYGZus{}}\PYG{p}{[}\PYG{n}{updir\PYGZus{}l}\PYG{p}{,} \PYG{n}{updir\PYGZus{}mid}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{updir\PYGZus{}r}\PYG{p}{]}
        \PYG{n}{chord} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{concatenate}\PYG{p}{(}\PYG{p}{[}\PYG{n}{chord\PYGZus{}l}\PYG{p}{,} \PYG{n}{chord\PYGZus{}mid}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{/}\PYG{l+m+mf}{1e4}\PYG{p}{,} \PYG{n}{chord\PYGZus{}r}\PYG{p}{]}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{line}\PYG{p}{,} \PYG{n}{chordir}\PYG{p}{,} \PYG{n}{updir}\PYG{p}{,} \PYG{n}{chord}

    \PYG{c+c1}{\PYGZsh{} calling methods of BirdModel that are defined in other files}
    \PYG{n}{get\PYGZus{}aeroforces} \PYG{o}{=} \PYG{n}{get\PYGZus{}aeroforces}
    \PYG{n}{dynamics} \PYG{o}{=} \PYG{n}{dynamics}
    \PYG{n}{get\PYGZus{}stability\PYGZus{}matrix} \PYG{o}{=} \PYG{n}{get\PYGZus{}stability\PYGZus{}matrix}
\end{sphinxVerbatim}
\end{quote}

\begin{sphinxadmonition}{note}{Note:}
Kinematics and bird constructors have been briefly introduced because they will be called from the user in the \sphinxcode{\sphinxupquote{main.py}} file.
\end{sphinxadmonition}

We are now able to create the user files.


\subsection{Input file}
\label{\detokenize{tutorial/bird_dynamics:input-file}}
As all the other input files, this has to respect the path \sphinxcode{\sphinxupquote{multiflap/odes/bird\_dynamics.py}}. The equations of motion of the flier restricted on the longitudinal plane are:
\begin{equation}\label{equation:tutorial/bird_dynamics:bird_odes}
\begin{split}\dot{u} &= -qw - g\sin \theta + \frac{1}{m_b}{F_{x'}(\mathbf{x}(t),  t)}\\
\dot{w} &= qu + g\cos \theta +\frac{1}{m_b} F_{z'}(\mathbf{x}(t),  t)\\
\dot{q} &=\frac{1}{I_{yy}}M_{y'}(\mathbf{x}(t),  t)\\
\dot{\theta} &= q\end{split}
\end{equation}
and therefore the time\sphinxhyphen{}dependent stability matrix:
\begin{equation}\label{equation:tutorial/bird_dynamics:stability_matrix_bird}
\begin{split}\mathbb{A}(\mathbf{x}(t), t) =
\begin{pmatrix}
\frac{1}{m}\frac{\partial{F_{x'}}}{\partial{u}}  & \frac{1}{m}\frac{\partial{F_{x'}}}{\partial{w}} - q& - w + \frac{1}{m}\frac{\partial{F_{x'}}}{\partial{q}}& -g\cos{\theta} + \frac{1}{m}\frac{\partial{F_{x'}}}{\partial{\theta}}\\
q + \frac{1}{m}\frac{\partial{F_{z'}}}{\partial{u}}  & \frac{1}{m}\frac{\partial{F_{z'}}}{\partial{w}}&  u + \frac{1}{m}\frac{\partial{F_{z'}}}{\partial{q}} & g\sin{\theta} + \frac{1}{m}\frac{\partial{F_{z'}}}{\partial{\theta}}\\
\frac{1}{I_{yy}}\frac{\partial{M_{y'}}}{\partial{u}}  & \frac{1}{I_{yy}}\frac{\partial{M_{y'}}}{\partial{w}}& \frac{1}{I_{yy}}\frac{\partial{M_{y'}}}{\partial{q}}  & \frac{1}{I_{yy}}\frac{\partial{M_{y'}}}{\partial{\theta}}\\
0 & 0 &1 & 0 \\
\end{pmatrix}\end{split}
\end{equation}
The aerodynamic derivatives are computed at every time step from the \sphinxcode{\sphinxupquote{get\_stability\_matrix}} function.

The input file is \sphinxcode{\sphinxupquote{multiflap/odes/bird\_dynamics.py}}. This set of ODEs is coupled with the aerodynamics. To use the aerodynamic solver, the realative package \sphinxcode{\sphinxupquote{aero\_package}} needs to be loaded.

At every time step the position of the wing and the extraction of the lifting line is calculated, based on the bird object passed from the main file.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\PYG{k+kn}{from} \PYG{n+nn}{aero\PYGZus{}package}\PYG{n+nn}{.}\PYG{n+nn}{flapping\PYGZus{}forces} \PYG{k+kn}{import} \PYG{n}{get\PYGZus{}flappingforces}
\PYG{k+kn}{import} \PYG{n+nn}{scipy}\PYG{n+nn}{.}\PYG{n+nn}{integrate} \PYG{k}{as} \PYG{n+nn}{ode}
\PYG{k+kn}{import} \PYG{n+nn}{time}
\PYG{k+kn}{from} \PYG{n+nn}{math} \PYG{k+kn}{import} \PYG{n}{sin}\PYG{p}{,} \PYG{n}{cos}
\PYG{n}{dim} \PYG{o}{=} \PYG{l+m+mi}{4}

\PYG{k}{def} \PYG{n+nf}{dynamics}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x0}\PYG{p}{,} \PYG{n}{t}\PYG{p}{)}\PYG{p}{:}
        \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        ODE system for the Equation of Motion on the longitudinal plane.}
\PYG{l+s+sd}{        This function will be passed to the numerical integrator}

\PYG{l+s+sd}{        Inputs:}
\PYG{l+s+sd}{            x0: initial values [u, w, q, theta]}
\PYG{l+s+sd}{            t: time}

\PYG{l+s+sd}{        Outputs:}
\PYG{l+s+sd}{            x\PYGZus{}dot: velocity vector}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{c+c1}{\PYGZsh{}Read inputs:}
        \PYG{n}{u}\PYG{p}{,} \PYG{n}{w}\PYG{p}{,} \PYG{n}{q}\PYG{p}{,} \PYG{n}{theta}  \PYG{o}{=} \PYG{n}{x0}  \PYG{c+c1}{\PYGZsh{} Read state space points}

        \PYG{c+c1}{\PYGZsh{} get the aereodynamic forces at time t}
        \PYG{p}{[}\PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{Fy}\PYG{p}{,} \PYG{n}{Fz}\PYG{p}{,} \PYG{n}{My}\PYG{p}{,} \PYG{n}{F\PYGZus{}tail}\PYG{p}{,} \PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{\PYGZus{}}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{get\PYGZus{}aeroforces}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{,} \PYG{n}{t}\PYG{p}{)}

        \PYG{c+c1}{\PYGZsh{} bird body dynamics}
        \PYG{n}{dudt} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{n}{q}\PYG{o}{*}\PYG{n}{w} \PYG{o}{\PYGZhy{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{g}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{theta}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{Fz}\PYG{o}{/}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{mass}
        \PYG{n}{dwdt} \PYG{o}{=} \PYG{n}{q}\PYG{o}{*}\PYG{n}{u} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{g}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{theta}\PYG{p}{)} \PYG{o}{\PYGZhy{}} \PYG{n}{Fy}\PYG{o}{/}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{mass} \PYG{o}{\PYGZhy{}} \PYG{n}{F\PYGZus{}tail}\PYG{o}{/}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{mass}
        \PYG{n}{dqdt} \PYG{o}{=}  \PYG{n}{My}\PYG{o}{/}\PYG{l+m+mf}{0.1}
        \PYG{n}{dthetadt} \PYG{o}{=} \PYG{n}{q}

        \PYG{c+c1}{\PYGZsh{} collecting x\PYGZus{}dot components in a single array:}
        \PYG{n}{x\PYGZus{}dot} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{n}{dudt}\PYG{p}{,} \PYG{n}{dwdt}\PYG{p}{,} \PYG{n}{dqdt}\PYG{p}{,} \PYG{n}{dthetadt}\PYG{p}{]}\PYG{p}{,} \PYG{n+nb}{float}\PYG{p}{)}

        \PYG{k}{return} \PYG{n}{x\PYGZus{}dot}

\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}aeroforces}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x0}\PYG{p}{,} \PYG{n}{t}\PYG{p}{)}\PYG{p}{:}
        \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{        Returns the aereodynamic forces at a time t}
\PYG{l+s+sd}{        1. Get the wing state (angles of each joint at time t)}
\PYG{l+s+sd}{        2. Based on the joint angles, exctracts the wing envelope}
\PYG{l+s+sd}{        3. From the envelope, exctracts the lifing line}
\PYG{l+s+sd}{        4. The lifting line is mirrored for the symmetric wing}
\PYG{l+s+sd}{        5. Lifting line properties and bird velocities are}
\PYG{l+s+sd}{            passed to the liftin line solver}

\PYG{l+s+sd}{        Inputs:}
\PYG{l+s+sd}{            x0: initial values [u, w, q, theta]}
\PYG{l+s+sd}{            t: time}

\PYG{l+s+sd}{        Outputs:}
\PYG{l+s+sd}{            aereodynamic\PYGZus{}forces : components of the aereod. forces and moments}
\PYG{l+s+sd}{        \PYGZdq{}\PYGZdq{}\PYGZdq{}}
        \PYG{n}{dt} \PYG{o}{=} \PYG{l+m+mf}{0.25}\PYG{o}{*}\PYG{l+m+mf}{1e\PYGZhy{}4}
        \PYG{n}{wing\PYGZus{}state} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{get\PYGZus{}wingstate}\PYG{p}{(}\PYG{n}{t}\PYG{p}{)}
        \PYG{n}{wing\PYGZus{}state\PYGZus{}dt} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{get\PYGZus{}wingstate}\PYG{p}{(}\PYG{n}{t}\PYG{o}{\PYGZhy{}}\PYG{n}{dt}\PYG{p}{)}

        \PYG{p}{[}\PYG{n}{leadingedge}\PYG{p}{,}
         \PYG{n}{trailingedge}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{get\PYGZus{}wingenvelope}\PYG{p}{(}\PYG{n}{wing\PYGZus{}state}\PYG{p}{)}

        \PYG{p}{[}\PYG{n}{leadingedge\PYGZus{}dt}\PYG{p}{,}
         \PYG{n}{trailingedge\PYGZus{}dt}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{get\PYGZus{}wingenvelope}\PYG{p}{(}\PYG{n}{wing\PYGZus{}state\PYGZus{}dt}\PYG{p}{)}

        \PYG{n}{lifting\PYGZus{}line} \PYG{o}{=}  \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{get\PYGZus{}liftingline}\PYG{p}{(}\PYG{n}{leadingedge}\PYG{p}{,}
                                             \PYG{n}{trailingedge}\PYG{p}{)}

        \PYG{n}{lifting\PYGZus{}line\PYGZus{}dt} \PYG{o}{=}  \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{get\PYGZus{}liftingline}\PYG{p}{(}\PYG{n}{leadingedge\PYGZus{}dt}\PYG{p}{,}
                                                \PYG{n}{trailingedge\PYGZus{}dt}\PYG{p}{)}

        \PYG{p}{[}\PYG{n}{line}\PYG{p}{,} \PYG{n}{chordir}\PYG{p}{,} \PYG{n}{updir}\PYG{p}{,} \PYG{n}{chord}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{merge\PYGZus{}lines}\PYG{p}{(}\PYG{n}{lifting\PYGZus{}line}\PYG{p}{)}

        \PYG{p}{[}\PYG{n}{line\PYGZus{}dt}\PYG{p}{,} \PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{\PYGZus{}}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{merge\PYGZus{}lines}\PYG{p}{(}\PYG{n}{lifting\PYGZus{}line\PYGZus{}dt}\PYG{p}{)}

        \PYG{n}{v\PYGZus{}kinematics} \PYG{o}{=} \PYG{n}{get\PYGZus{}kinematicvelocity}\PYG{p}{(}\PYG{n}{line}\PYG{p}{,} \PYG{n}{line\PYGZus{}dt}\PYG{p}{,} \PYG{n}{dt}\PYG{p}{)}

        \PYG{c+c1}{\PYGZsh{} call the aereodynamic solver for the lifting line get\PYGZus{}flappingforces}
        \PYG{p}{[}\PYG{n}{Fx}\PYG{p}{,}
         \PYG{n}{Fy}\PYG{p}{,}
         \PYG{n}{Fz}\PYG{p}{,}
         \PYG{n}{My}\PYG{p}{,}
         \PYG{n}{F\PYGZus{}tail}\PYG{p}{,}
         \PYG{n}{M\PYGZus{}wing}\PYG{p}{,}
         \PYG{n}{M\PYGZus{}tail}\PYG{p}{,}
         \PYG{n}{M\PYGZus{}drag}\PYG{p}{,}
         \PYG{n}{M\PYGZus{}lift}\PYG{p}{]} \PYG{o}{=} \PYG{n}{get\PYGZus{}flappingforces}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{,} \PYG{n}{v\PYGZus{}kinematics}\PYG{p}{,}
                                      \PYG{n}{line}\PYG{p}{,} \PYG{n}{chordir}\PYG{p}{,} \PYG{n}{updir}\PYG{p}{,} \PYG{n}{chord}\PYG{p}{)}

        \PYG{n}{aereodynamic\PYGZus{}forces} \PYG{o}{=} \PYG{p}{[}\PYG{n}{Fx}\PYG{p}{,} \PYG{n}{Fy}\PYG{p}{,} \PYG{n}{Fz}\PYG{p}{,} \PYG{n}{My}\PYG{p}{,}
                               \PYG{n}{F\PYGZus{}tail}\PYG{p}{,} \PYG{n}{M\PYGZus{}wing}\PYG{p}{,} \PYG{n}{M\PYGZus{}tail}\PYG{p}{,} \PYG{n}{M\PYGZus{}drag}\PYG{p}{,} \PYG{n}{M\PYGZus{}lift}\PYG{p}{]}
        \PYG{k}{return} \PYG{n}{aereodynamic\PYGZus{}forces}


\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}kinematicvelocity}\PYG{p}{(}\PYG{n}{line}\PYG{p}{,} \PYG{n}{line\PYGZus{}dt}\PYG{p}{,} \PYG{n}{dt}\PYG{p}{)}\PYG{p}{:}

       \PYG{n}{line\PYGZus{}c} \PYG{o}{=} \PYG{n}{line}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{:}\PYG{l+m+mi}{2}\PYG{p}{]}
       \PYG{n}{line\PYGZus{}c2} \PYG{o}{=} \PYG{n}{line\PYGZus{}dt}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{:}\PYG{l+m+mi}{2}\PYG{p}{]}
       \PYG{n}{v\PYGZus{}kin} \PYG{o}{=}  \PYG{p}{(}\PYG{n}{line\PYGZus{}c} \PYG{o}{\PYGZhy{}} \PYG{n}{line\PYGZus{}c2}\PYG{p}{)}\PYG{o}{/}\PYG{n}{dt}

       \PYG{k}{return} \PYG{n}{v\PYGZus{}kin}

\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}stability\PYGZus{}matrix}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{x0}\PYG{p}{,} \PYG{n}{t}\PYG{p}{)}\PYG{p}{:}

    \PYG{l+s+sd}{\PYGZdq{}\PYGZdq{}\PYGZdq{}}
\PYG{l+s+sd}{    Stability matrix of the ODE system for the longitudinal plane}

\PYG{l+s+sd}{    Inputs:}
\PYG{l+s+sd}{        x0: initial condition [u\PYGZus{}0, w\PYGZus{}0, q\PYGZus{}0, theta\PYGZus{}0]}
\PYG{l+s+sd}{    Outputs:}
\PYG{l+s+sd}{        A: Stability matrix evaluated at x0. (dxd) dimension}
\PYG{l+s+sd}{        A[i, j] = dv[i]/dx[j]}
\PYG{l+s+sd}{    \PYGZdq{}\PYGZdq{}\PYGZdq{}}
    \PYG{n}{m} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{mass}
    \PYG{n}{g} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{g}
    \PYG{n}{perturbation} \PYG{o}{=} \PYG{l+m+mf}{1e\PYGZhy{}3}
    \PYG{n}{x0\PYGZus{}u} \PYG{o}{=} \PYG{n}{x0} \PYG{o}{+} \PYG{p}{[}\PYG{n}{x0}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{*}\PYG{n}{perturbation}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}
    \PYG{n}{x0\PYGZus{}w} \PYG{o}{=} \PYG{n}{x0} \PYG{o}{+} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{x0}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{*}\PYG{n}{perturbation}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}
    \PYG{n}{x0\PYGZus{}q} \PYG{o}{=} \PYG{n}{x0} \PYG{o}{+} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{x0}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{*}\PYG{n}{perturbation}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}
    \PYG{p}{[}\PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{Fy}\PYG{p}{,} \PYG{n}{Fz}\PYG{p}{,} \PYG{n}{My}\PYG{p}{,} \PYG{n}{F\PYGZus{}tail}\PYG{p}{,} \PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{\PYGZus{}}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{get\PYGZus{}aeroforces}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{,} \PYG{n}{t}\PYG{p}{)}
    \PYG{c+c1}{\PYGZsh{} force evaluation, perturbation along \PYGZsq{}u\PYGZsq{}}
    \PYG{p}{[}\PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{Fyu}\PYG{p}{,} \PYG{n}{Fzu}\PYG{p}{,} \PYG{n}{Myu}\PYG{p}{,} \PYG{n}{F\PYGZus{}tailu}\PYG{p}{,} \PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{\PYGZus{}}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{get\PYGZus{}aeroforces}\PYG{p}{(}\PYG{n}{x0\PYGZus{}u}\PYG{p}{,} \PYG{n}{t}\PYG{p}{)}
    \PYG{c+c1}{\PYGZsh{} force evaluation, perturbation along \PYGZsq{}w\PYGZsq{}}
    \PYG{p}{[}\PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{Fyw}\PYG{p}{,} \PYG{n}{Fzw}\PYG{p}{,} \PYG{n}{Myw}\PYG{p}{,} \PYG{n}{F\PYGZus{}tailw}\PYG{p}{,} \PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{\PYGZus{}}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{get\PYGZus{}aeroforces}\PYG{p}{(}\PYG{n}{x0\PYGZus{}w}\PYG{p}{,} \PYG{n}{t}\PYG{p}{)}
    \PYG{c+c1}{\PYGZsh{} force evaluation, perturbation along \PYGZsq{}q\PYGZsq{}}
    \PYG{p}{[}\PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{Fyq}\PYG{p}{,} \PYG{n}{Fzq}\PYG{p}{,} \PYG{n}{Myq}\PYG{p}{,} \PYG{n}{F\PYGZus{}tailq}\PYG{p}{,} \PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{\PYGZus{}}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{get\PYGZus{}aeroforces}\PYG{p}{(}\PYG{n}{x0\PYGZus{}q}\PYG{p}{,} \PYG{n}{t}\PYG{p}{)}


    \PYG{c+c1}{\PYGZsh{} Derivatives of Fz with respect to the state space variables}
    \PYG{n}{dFzu\PYGZus{}dU} \PYG{o}{=} \PYG{p}{(}\PYG{n}{Fzu} \PYG{o}{\PYGZhy{}} \PYG{n}{Fz}\PYG{p}{)}\PYG{o}{/}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{*}\PYG{n}{perturbation}\PYG{p}{)}
    \PYG{n}{dFzw\PYGZus{}dW} \PYG{o}{=} \PYG{p}{(}\PYG{n}{Fzw} \PYG{o}{\PYGZhy{}} \PYG{n}{Fz}\PYG{p}{)}\PYG{o}{/}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{*}\PYG{n}{perturbation}\PYG{p}{)}
    \PYG{n}{dFzq\PYGZus{}dq} \PYG{o}{=} \PYG{p}{(}\PYG{n}{Fzq} \PYG{o}{\PYGZhy{}} \PYG{n}{Fz}\PYG{p}{)}\PYG{o}{/}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{*}\PYG{n}{perturbation}\PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{} Derivatives of Fy with respect to the state space variables}
    \PYG{n}{dFyu\PYGZus{}dU} \PYG{o}{=} \PYG{p}{(}\PYG{n}{Fyu} \PYG{o}{\PYGZhy{}} \PYG{n}{Fy}\PYG{p}{)}\PYG{o}{/}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{*}\PYG{n}{perturbation}\PYG{p}{)}
    \PYG{n}{dFyw\PYGZus{}dW} \PYG{o}{=} \PYG{p}{(}\PYG{n}{Fyw} \PYG{o}{\PYGZhy{}} \PYG{n}{Fy}\PYG{p}{)}\PYG{o}{/}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{*}\PYG{n}{perturbation}\PYG{p}{)}
    \PYG{n}{dFyq\PYGZus{}dq} \PYG{o}{=} \PYG{p}{(}\PYG{n}{Fyq} \PYG{o}{\PYGZhy{}} \PYG{n}{Fy}\PYG{p}{)}\PYG{o}{/}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{*}\PYG{n}{perturbation}\PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{} Derivatives of F\PYGZus{}tail with respect to the state space variables}
    \PYG{n}{dFytail\PYGZus{}du} \PYG{o}{=} \PYG{p}{(}\PYG{n}{F\PYGZus{}tailu} \PYG{o}{\PYGZhy{}} \PYG{n}{F\PYGZus{}tail}\PYG{p}{)}\PYG{o}{/}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{*}\PYG{n}{perturbation}\PYG{p}{)}
    \PYG{n}{dFytail\PYGZus{}dw} \PYG{o}{=} \PYG{p}{(}\PYG{n}{F\PYGZus{}tailw} \PYG{o}{\PYGZhy{}} \PYG{n}{F\PYGZus{}tail}\PYG{p}{)}\PYG{o}{/}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{*}\PYG{n}{perturbation}\PYG{p}{)}
    \PYG{n}{dFytail\PYGZus{}dq} \PYG{o}{=} \PYG{p}{(}\PYG{n}{F\PYGZus{}tailq} \PYG{o}{\PYGZhy{}} \PYG{n}{F\PYGZus{}tail}\PYG{p}{)}\PYG{o}{/}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{*}\PYG{n}{perturbation}\PYG{p}{)}

    \PYG{c+c1}{\PYGZsh{} Derivatives of My with respect to the state space variables}
    \PYG{n}{dMy\PYGZus{}du} \PYG{o}{=} \PYG{p}{(}\PYG{n}{Myu} \PYG{o}{\PYGZhy{}} \PYG{n}{My}\PYG{p}{)}\PYG{o}{/}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{*}\PYG{n}{perturbation}\PYG{p}{)}
    \PYG{n}{dMy\PYGZus{}dw} \PYG{o}{=} \PYG{p}{(}\PYG{n}{Myw} \PYG{o}{\PYGZhy{}} \PYG{n}{My}\PYG{p}{)}\PYG{o}{/}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{*}\PYG{n}{perturbation}\PYG{p}{)}
    \PYG{n}{dMy\PYGZus{}dq} \PYG{o}{=} \PYG{p}{(}\PYG{n}{Myq} \PYG{o}{\PYGZhy{}} \PYG{n}{My}\PYG{p}{)}\PYG{o}{/}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{*}\PYG{n}{perturbation}\PYG{p}{)}
    \PYG{n}{u}\PYG{p}{,} \PYG{n}{w}\PYG{p}{,} \PYG{n}{q}\PYG{p}{,} \PYG{n}{theta} \PYG{o}{=} \PYG{n}{x0}

    \PYG{n}{A} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{n}{dFzu\PYGZus{}dU}\PYG{o}{/}\PYG{n}{m}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{q} \PYG{o}{\PYGZhy{}} \PYG{n}{dFzw\PYGZus{}dW}\PYG{o}{/}\PYG{n}{m}\PYG{p}{,}
                   \PYG{o}{\PYGZhy{}}\PYG{n}{w} \PYG{o}{\PYGZhy{}} \PYG{n}{dFzq\PYGZus{}dq}\PYG{o}{/}\PYG{n}{m}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{g}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{theta}\PYG{p}{)}\PYG{p}{]}\PYG{p}{,}
                  \PYG{p}{[}\PYG{n}{q} \PYG{o}{\PYGZhy{}} \PYG{n}{dFyu\PYGZus{}dU}\PYG{o}{/}\PYG{n}{m} \PYG{o}{\PYGZhy{}} \PYG{n}{dFytail\PYGZus{}du}\PYG{o}{/}\PYG{n}{m}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{dFyw\PYGZus{}dW}\PYG{o}{/}\PYG{n}{m} \PYG{o}{\PYGZhy{}} \PYG{n}{dFytail\PYGZus{}dw}\PYG{o}{/}\PYG{n}{m}\PYG{p}{,}
                   \PYG{n}{u} \PYG{o}{\PYGZhy{}} \PYG{n}{dFyq\PYGZus{}dq}\PYG{o}{/}\PYG{n}{m} \PYG{o}{\PYGZhy{}} \PYG{n}{dFytail\PYGZus{}dq}\PYG{o}{/}\PYG{n}{m}\PYG{p}{,} \PYG{o}{\PYGZhy{}}\PYG{n}{g}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sin}\PYG{p}{(}\PYG{n}{theta}\PYG{p}{)}\PYG{p}{]}\PYG{p}{,}
                  \PYG{p}{[}\PYG{n}{dMy\PYGZus{}du}\PYG{o}{/}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{dMy\PYGZus{}dw}\PYG{o}{/}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{n}{dMy\PYGZus{}dq}\PYG{o}{/}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}
                  \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} \PYG{n+nb}{float}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{A}
\end{sphinxVerbatim}


\subsection{The main file}
\label{\detokenize{tutorial/bird_dynamics:the-main-file}}
The main is composed by the following parts:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
Generate the kinematics object;

\item {} 
Build the \sphinxstylestrong{bird} object

\item {} 
Pass the bird object to the multiple\sphinxhyphen{}shooting solver

\item {} 
Solve the multiple\sphinxhyphen{}shooting problem

\end{enumerate}

The main file is thus

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\PYG{k+kn}{from}  \PYG{n+nn}{ms\PYGZus{}package}\PYG{n+nn}{.}\PYG{n+nn}{multiple\PYGZus{}shooting} \PYG{k+kn}{import} \PYG{n}{MultipleShooting}
\PYG{k+kn}{from} \PYG{n+nn}{aero\PYGZus{}package}\PYG{n+nn}{.}\PYG{n+nn}{bird\PYGZus{}model} \PYG{k+kn}{import} \PYG{n}{BirdModel}
\PYG{k+kn}{from} \PYG{n+nn}{aero\PYGZus{}package}\PYG{n+nn}{.}\PYG{n+nn}{kinematics\PYGZus{}constructor} \PYG{k+kn}{import} \PYG{n}{Shoulder}\PYG{p}{,} \PYG{n}{Elbow}\PYG{p}{,} \PYG{n}{Wrist}\PYG{p}{,} \PYG{n}{Joint}
\PYG{k+kn}{import} \PYG{n+nn}{time}
\PYG{k+kn}{from} \PYG{n+nn}{numpy}\PYG{n+nn}{.}\PYG{n+nn}{linalg} \PYG{k+kn}{import} \PYG{n}{norm}
\PYG{k+kn}{from} \PYG{n+nn}{numpy} \PYG{k+kn}{import} \PYG{n}{inf}
\PYG{k+kn}{from} \PYG{n+nn}{ms\PYGZus{}package}\PYG{n+nn}{.}\PYG{n+nn}{lma\PYGZus{}solver} \PYG{k+kn}{import} \PYG{n}{Solver}


\PYG{c+c1}{\PYGZsh{} generate bird kinematics by calling \PYGZdq{}kinematics\PYGZus{}constructor\PYGZdq{} module}
\PYG{n}{bird\PYGZus{}shoulder} \PYG{o}{=} \PYG{n}{Shoulder}\PYG{p}{(}\PYG{n}{axis\PYGZus{}x}\PYG{o}{=}\PYG{n}{Joint}\PYG{p}{(}\PYG{l+m+mf}{0.2}\PYG{p}{,}\PYG{l+m+mf}{0.014}\PYG{p}{,}\PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,}
                         \PYG{n}{axis\PYGZus{}y}\PYG{o}{=}\PYG{n}{Joint}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{deg2rad}\PYG{p}{(}\PYG{l+m+mi}{19}\PYG{p}{)}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{deg2rad}\PYG{p}{(}\PYG{l+m+mi}{20}\PYG{p}{)}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,}
                         \PYG{n}{axis\PYGZus{}z}\PYG{o}{=}\PYG{n}{Joint}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{deg2rad}\PYG{p}{(}\PYG{l+m+mi}{42}\PYG{p}{)}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{bird\PYGZus{}elbow} \PYG{o}{=} \PYG{n}{Elbow}\PYG{p}{(}\PYG{n}{axis\PYGZus{}x}\PYG{o}{=}\PYG{n}{Joint}\PYG{p}{(}\PYG{l+m+mf}{0.}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{6}\PYG{p}{,}\PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,}
                   \PYG{n}{axis\PYGZus{}y}\PYG{o}{=}\PYG{n}{Joint}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{6}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{6}\PYG{p}{,}\PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{bird\PYGZus{}wrist} \PYG{o}{=} \PYG{n}{Wrist}\PYG{p}{(}\PYG{n}{axis\PYGZus{}y}\PYG{o}{=}\PYG{n}{Joint}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{6}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{6}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{,}
                   \PYG{n}{axis\PYGZus{}z}\PYG{o}{=}\PYG{n}{Joint}\PYG{p}{(}\PYG{l+m+mf}{0.}\PYG{p}{,}\PYG{l+m+mf}{0.}\PYG{p}{,}\PYG{l+m+mf}{0.}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{mybird} \PYG{o}{=} \PYG{n}{BirdModel}\PYG{p}{(}\PYG{n}{shoulder}\PYG{o}{=}\PYG{n}{bird\PYGZus{}shoulder}\PYG{p}{,} \PYG{n}{elbow}\PYG{o}{=}\PYG{n}{bird\PYGZus{}elbow}\PYG{p}{,} \PYG{n}{wrist}\PYG{o}{=}\PYG{n}{bird\PYGZus{}wrist}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} set initial guess for multiple\PYGZhy{}shooting scheme}
\PYG{n}{x0} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mf}{18.}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{0.01}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} generate multiple\PYGZhy{}shooting object}
\PYG{n}{ms\PYGZus{}obj} \PYG{o}{=} \PYG{n}{MultipleShooting}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{,} \PYG{n}{M} \PYG{o}{=} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{period}\PYG{o}{=}\PYG{l+m+mf}{0.25}\PYG{p}{,} \PYG{n}{t\PYGZus{}steps}\PYG{o}{=}\PYG{l+m+mi}{60}\PYG{p}{,} \PYG{n}{model} \PYG{o}{=} \PYG{n}{mybird}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} call the LMA solver}
\PYG{n}{mysol} \PYG{o}{=} \PYG{n}{Solver}\PYG{p}{(}\PYG{n}{ms\PYGZus{}obj} \PYG{o}{=} \PYG{n}{ms\PYGZus{}obj}\PYG{p}{)}\PYG{o}{.}\PYG{n}{lma}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

It is now possible to run the main file inside the \sphinxcode{\sphinxupquote{multiflap}} directory:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{python3} \PYG{n}{main}\PYG{o}{.}\PYG{n}{py}
\end{sphinxVerbatim}


\chapter{LICENSE}
\label{\detokenize{license:license}}\label{\detokenize{license::doc}}\begin{quote}
\begin{quote}
\begin{quote}
\begin{quote}

Apache License
\end{quote}

Version 2.0, January 2004
\end{quote}

\sphinxurl{http://www.apache.org/licenses/}
\end{quote}

TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
Definitions.

“License” shall mean the terms and conditions for use, reproduction,
and distribution as defined by Sections 1 through 9 of this document.

“Licensor” shall mean the copyright owner or entity authorized by
the copyright owner that is granting the License.

“Legal Entity” shall mean the union of the acting entity and all
other entities that control, are controlled by, or are under common
control with that entity. For the purposes of this definition,
“control” means (i) the power, direct or indirect, to cause the
direction or management of such entity, whether by contract or
otherwise, or (ii) ownership of fifty percent (50\%) or more of the
outstanding shares, or (iii) beneficial ownership of such entity.

“You” (or “Your”) shall mean an individual or Legal Entity
exercising permissions granted by this License.

“Source” form shall mean the preferred form for making modifications,
including but not limited to software source code, documentation
source, and configuration files.

“Object” form shall mean any form resulting from mechanical
transformation or translation of a Source form, including but
not limited to compiled object code, generated documentation,
and conversions to other media types.

“Work” shall mean the work of authorship, whether in Source or
Object form, made available under the License, as indicated by a
copyright notice that is included in or attached to the work
(an example is provided in the Appendix below).

“Derivative Works” shall mean any work, whether in Source or Object
form, that is based on (or derived from) the Work and for which the
editorial revisions, annotations, elaborations, or other modifications
represent, as a whole, an original work of authorship. For the purposes
of this License, Derivative Works shall not include works that remain
separable from, or merely link (or bind by name) to the interfaces of,
the Work and Derivative Works thereof.

“Contribution” shall mean any work of authorship, including
the original version of the Work and any modifications or additions
to that Work or Derivative Works thereof, that is intentionally
submitted to Licensor for inclusion in the Work by the copyright owner
or by an individual or Legal Entity authorized to submit on behalf of
the copyright owner. For the purposes of this definition, “submitted”
means any form of electronic, verbal, or written communication sent
to the Licensor or its representatives, including but not limited to
communication on electronic mailing lists, source code control systems,
and issue tracking systems that are managed by, or on behalf of, the
Licensor for the purpose of discussing and improving the Work, but
excluding communication that is conspicuously marked or otherwise
designated in writing by the copyright owner as “Not a Contribution.”

“Contributor” shall mean Licensor and any individual or Legal Entity
on behalf of whom a Contribution has been received by Licensor and
subsequently incorporated within the Work.

\item {} 
Grant of Copyright License. Subject to the terms and conditions of
this License, each Contributor hereby grants to You a perpetual,
worldwide, non\sphinxhyphen{}exclusive, no\sphinxhyphen{}charge, royalty\sphinxhyphen{}free, irrevocable
copyright license to reproduce, prepare Derivative Works of,
publicly display, publicly perform, sublicense, and distribute the
Work and such Derivative Works in Source or Object form.

\item {} 
Grant of Patent License. Subject to the terms and conditions of
this License, each Contributor hereby grants to You a perpetual,
worldwide, non\sphinxhyphen{}exclusive, no\sphinxhyphen{}charge, royalty\sphinxhyphen{}free, irrevocable
(except as stated in this section) patent license to make, have made,
use, offer to sell, sell, import, and otherwise transfer the Work,
where such license applies only to those patent claims licensable
by such Contributor that are necessarily infringed by their
Contribution(s) alone or by combination of their Contribution(s)
with the Work to which such Contribution(s) was submitted. If You
institute patent litigation against any entity (including a
cross\sphinxhyphen{}claim or counterclaim in a lawsuit) alleging that the Work
or a Contribution incorporated within the Work constitutes direct
or contributory patent infringement, then any patent licenses
granted to You under this License for that Work shall terminate
as of the date such litigation is filed.

\item {} 
Redistribution. You may reproduce and distribute copies of the
Work or Derivative Works thereof in any medium, with or without
modifications, and in Source or Object form, provided that You
meet the following conditions:
\begin{enumerate}
\sphinxsetlistlabels{\alph}{enumii}{enumiii}{(}{)}%
\item {} 
You must give any other recipients of the Work or
Derivative Works a copy of this License; and

\item {} 
You must cause any modified files to carry prominent notices
stating that You changed the files; and

\item {} 
You must retain, in the Source form of any Derivative Works
that You distribute, all copyright, patent, trademark, and
attribution notices from the Source form of the Work,
excluding those notices that do not pertain to any part of
the Derivative Works; and

\item {} 
If the Work includes a “NOTICE” text file as part of its
distribution, then any Derivative Works that You distribute must
include a readable copy of the attribution notices contained
within such NOTICE file, excluding those notices that do not
pertain to any part of the Derivative Works, in at least one
of the following places: within a NOTICE text file distributed
as part of the Derivative Works; within the Source form or
documentation, if provided along with the Derivative Works; or,
within a display generated by the Derivative Works, if and
wherever such third\sphinxhyphen{}party notices normally appear. The contents
of the NOTICE file are for informational purposes only and
do not modify the License. You may add Your own attribution
notices within Derivative Works that You distribute, alongside
or as an addendum to the NOTICE text from the Work, provided
that such additional attribution notices cannot be construed
as modifying the License.

\end{enumerate}

You may add Your own copyright statement to Your modifications and
may provide additional or different license terms and conditions
for use, reproduction, or distribution of Your modifications, or
for any such Derivative Works as a whole, provided Your use,
reproduction, and distribution of the Work otherwise complies with
the conditions stated in this License.

\item {} 
Submission of Contributions. Unless You explicitly state otherwise,
any Contribution intentionally submitted for inclusion in the Work
by You to the Licensor shall be under the terms and conditions of
this License, without any additional terms or conditions.
Notwithstanding the above, nothing herein shall supersede or modify
the terms of any separate license agreement you may have executed
with Licensor regarding such Contributions.

\item {} 
Trademarks. This License does not grant permission to use the trade
names, trademarks, service marks, or product names of the Licensor,
except as required for reasonable and customary use in describing the
origin of the Work and reproducing the content of the NOTICE file.

\item {} 
Disclaimer of Warranty. Unless required by applicable law or
agreed to in writing, Licensor provides the Work (and each
Contributor provides its Contributions) on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
implied, including, without limitation, any warranties or conditions
of TITLE, NON\sphinxhyphen{}INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
PARTICULAR PURPOSE. You are solely responsible for determining the
appropriateness of using or redistributing the Work and assume any
risks associated with Your exercise of permissions under this License.

\item {} 
Limitation of Liability. In no event and under no legal theory,
whether in tort (including negligence), contract, or otherwise,
unless required by applicable law (such as deliberate and grossly
negligent acts) or agreed to in writing, shall any Contributor be
liable to You for damages, including any direct, indirect, special,
incidental, or consequential damages of any character arising as a
result of this License or out of the use or inability to use the
Work (including but not limited to damages for loss of goodwill,
work stoppage, computer failure or malfunction, or any and all
other commercial damages or losses), even if such Contributor
has been advised of the possibility of such damages.

\item {} 
Accepting Warranty or Additional Liability. While redistributing
the Work or Derivative Works thereof, You may choose to offer,
and charge a fee for, acceptance of support, warranty, indemnity,
or other liability obligations and/or rights consistent with this
License. However, in accepting such obligations, You may act only
on Your own behalf and on Your sole responsibility, not on behalf
of any other Contributor, and only if You agree to indemnify,
defend, and hold each Contributor harmless for any liability
incurred by, or claims asserted against, such Contributor by reason
of your accepting any such warranty or additional liability.

\end{enumerate}

END OF TERMS AND CONDITIONS

APPENDIX: How to apply the Apache License to your work.
\begin{quote}

To apply the Apache License to your work, attach the following
boilerplate notice, with the fields enclosed by brackets “{[}{]}”
replaced with your own identifying information. (Don’t include
the brackets!)  The text should be enclosed in the appropriate
comment syntax for the file format. We also recommend that a
file or class name and description of purpose be included on the
same “printed page” as the copyright notice for easier
identification within third\sphinxhyphen{}party archives.
\end{quote}

Copyright {[}2021{]} {[}Gianmarco Ducci{]}

Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
\begin{quote}

\sphinxurl{http://www.apache.org/licenses/LICENSE-2.0}
\end{quote}

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
\end{quote}

\begin{sphinxthebibliography}{Sey2009}
\bibitem[Sey2009]{tutorial/isothermal_reaction:sey2009}
Practical bifurcation and stability analysis, Seydel Rudiger, Springer Science \& Business Media
\bibitem[DOS2019]{tutorial/redox_oscillation:dos2019}
del Olmo, M.; Kramer, A.; Herzel, H, A robust model for circadian redox oscillations, Int. J. Mol. Sci. 2019, 20, 2368.
\end{sphinxthebibliography}


\renewcommand{\indexname}{Python Module Index}
\begin{sphinxtheindex}
\let\bigletter\sphinxstyleindexlettergroup
\bigletter{.}
\item\relax\sphinxstyleindexentry{../multiflap/ms\_package/multiple\_shooting\_period}\sphinxstyleindexpageref{tutorial/isothermal_reaction:\detokenize{module-..-multiflap-ms_package-multiple_shooting_period}}
\end{sphinxtheindex}

\renewcommand{\indexname}{Index}
\printindex
\end{document}